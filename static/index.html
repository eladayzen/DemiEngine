<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Playable Ad Generator</title>
  <style>
    /* â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg:        #12121e;
      --surface:   #1c1c2e;
      --card:      #24243a;
      --border:    #35355a;
      --accent:    #ff5722;
      --accent2:   #ff7043;
      --text:      #e0e0f0;
      --muted:     #8888aa;
      --green:     #4caf50;
      --radius:    10px;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body { display: flex; flex-direction: column; }
    header { background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 14px 24px; display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
    header h1 { font-size: 20px; color: var(--accent); font-weight: 700; letter-spacing: 0.5px; }
    header span { color: var(--muted); font-size: 13px; }

    .main { flex: 1; display: flex; overflow: hidden; }

    /* â”€â”€ Preview panel (left 1/3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .preview-panel { width: 33.333%; background: var(--surface);
      border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .preview-header { padding: 12px 16px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; }
    .preview-header h2 { font-size: 13px; color: var(--muted); text-transform: uppercase;
      letter-spacing: 1px; font-weight: 600; }
    .preview-iframe-wrap { flex: 1; position: relative; background: #000; }
    .preview-iframe-wrap iframe { width: 100%; height: 100%; border: none; }
    .preview-placeholder { position: absolute; inset: 0; display: flex; align-items: center;
      justify-content: center; flex-direction: column; gap: 10px; color: var(--muted);
      font-size: 13px; }

    /* â”€â”€ Workspace (right 2/3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs { display: flex; gap: 4px; padding: 12px 20px 0;
      background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { padding: 8px 22px; border: none; border-radius: var(--radius) var(--radius) 0 0;
      background: var(--card); color: var(--muted); cursor: pointer; font-size: 13px;
      font-weight: 600; transition: all 0.15s; border: 1px solid transparent;
      border-bottom: none; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { background: var(--bg); color: var(--text);
      border-color: var(--border); border-bottom-color: var(--bg); }

    /* â”€â”€ Tab content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-content { flex: 1; overflow-y: auto; padding: 20px; display: none; }
    .tab-content.active { display: block; }

    /* â”€â”€ Section card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-card { background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
    .section-card h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
      color: var(--muted); margin-bottom: 16px; }

    /* â”€â”€ Form grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px; }
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label { font-size: 12px; color: var(--muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px; }
    .field input[type="text"],
    .field input[type="number"],
    .field select,
    .field textarea {
      background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); padding: 7px 10px; font-size: 13px; font-family: inherit;
      transition: border-color 0.15s; outline: none; }
    .field input[type="text"]:focus,
    .field input[type="number"]:focus,
    .field select:focus,
    .field textarea:focus { border-color: var(--accent); }
    .field textarea { resize: vertical; min-height: 80px; font-family: 'Consolas', monospace;
      font-size: 12px; line-height: 1.5; }
    .field select option { background: var(--card); }

    /* color picker row */
    .color-row { display: flex; align-items: center; gap: 8px; }
    .field input[type="color"] { width: 36px; height: 30px; border: 1px solid var(--border);
      border-radius: 6px; background: none; cursor: pointer; padding: 2px; }
    .color-hex { background: var(--surface); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); padding: 5px 8px; font-size: 12px;
      font-family: monospace; width: 80px; }

    /* range slider */
    .range-row { display: flex; align-items: center; gap: 8px; }
    .range-row input[type="range"] { flex: 1; accent-color: var(--accent); }
    .range-val { font-size: 12px; color: var(--muted); width: 32px; text-align: right; }

    /* toggle */
    .toggle-row { display: flex; align-items: center; gap: 10px; }
    .toggle { position: relative; width: 40px; height: 22px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: var(--border);
      border-radius: 22px; cursor: pointer; transition: 0.2s; }
    .toggle-slider::before { content: ''; position: absolute; left: 3px; top: 3px;
      width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.2s; }
    .toggle input:checked + .toggle-slider { background: var(--green); }
    .toggle input:checked + .toggle-slider::before { transform: translateX(18px); }
    .toggle-label { font-size: 13px; color: var(--text); }

    /* full-width field */
    .field.full { grid-column: 1 / -1; }

    /* â”€â”€ Level accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .level-card { background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); margin-bottom: 12px; overflow: hidden; }
    .level-header { display: flex; align-items: center; gap: 10px;
      padding: 12px 16px; cursor: pointer; user-select: none;
      border-bottom: 1px solid transparent; transition: border-color 0.15s; }
    .level-header.open { border-bottom-color: var(--border); }
    .level-header .chevron { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
    .level-header.open .chevron { transform: rotate(90deg); }
    .level-title { font-weight: 700; font-size: 14px; flex: 1; }
    .level-badge { font-size: 11px; color: var(--muted); background: var(--card);
      padding: 2px 8px; border-radius: 20px; }
    .remove-btn { background: none; border: none; color: var(--muted); cursor: pointer;
      font-size: 16px; padding: 2px 6px; border-radius: 4px; transition: color 0.15s; }
    .remove-btn:hover { color: #ff4444; }
    .level-body { padding: 16px; display: none; }
    .level-body.open { display: block; }
    .level-subhead { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px;
      color: var(--muted); margin: 16px 0 8px; border-bottom: 1px solid var(--border);
      padding-bottom: 4px; }

    .add-level-btn { display: flex; align-items: center; gap: 8px; padding: 10px 16px;
      background: none; border: 1px dashed var(--border); border-radius: var(--radius);
      color: var(--muted); cursor: pointer; font-size: 13px; width: 100%;
      transition: all 0.15s; }
    .add-level-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Load bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .load-bar { display: flex; align-items: center; gap: 10px;
      padding: 8px 20px; background: var(--surface);
      border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .load-bar label { font-size: 11px; color: var(--muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
    .load-bar select { background: var(--card); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); padding: 5px 10px; font-size: 12px;
      outline: none; cursor: pointer; max-width: 280px; }
    .load-bar select:focus { border-color: var(--accent); }
    .load-bar-divider { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }
    .reset-btn { padding: 5px 14px; background: none; border: 1px solid var(--border);
      border-radius: 6px; color: var(--muted); font-size: 12px; cursor: pointer;
      transition: all 0.15s; }
    .reset-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Coming-soon block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .coming-soon-block { border: 1px dashed #44447a; border-radius: var(--radius);
      padding: 14px 16px; margin-top: 16px; opacity: 0.7; }
    .coming-soon-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .coming-soon-header span { font-size: 13px; font-weight: 700; color: var(--text); }
    .coming-soon-tag { font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.8px; padding: 2px 8px; border-radius: 20px;
      background: #2a2a4a; color: #8888cc; border: 1px solid #44447a; }
    .coming-soon-tag.m6 { background: #1e2e1e; color: #77bb77; border-color: #336633; }
    .coming-soon-tag.active { background: #1a2e1a; color: #66dd66; border-color: #44aa44; }

    /* Apply button row */
    .apply-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
    .apply-btn { padding: 6px 18px; background: #1a3a1a; border: 1px solid #336633;
      border-radius: 6px; color: #77cc77; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: all 0.15s; }
    .apply-btn:hover:not(:disabled) { background: #224422; border-color: #44aa44; color: #88ee88; }
    .apply-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .apply-status { font-size: 12px; color: var(--muted); font-style: italic; }
    .coming-soon-block textarea { width: 100%; background: var(--surface);
      border: 1px solid #44447a; border-radius: 6px; color: #9999bb;
      padding: 8px 10px; font-size: 12px; font-family: inherit; resize: vertical;
      min-height: 60px; outline: none; }
    .coming-soon-note { font-size: 11px; color: #666699; margin-top: 6px; font-style: italic; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer { background: var(--surface); border-top: 1px solid var(--border);
      padding: 14px 24px; display: flex; align-items: center; gap: 14px; flex-shrink: 0; }
    .generate-btn { padding: 11px 28px; background: var(--accent); color: #fff;
      border: none; border-radius: var(--radius); font-size: 15px; font-weight: 700;
      cursor: pointer; transition: background 0.15s; }
    .generate-btn:hover { background: var(--accent2); }
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .result-area { display: none; align-items: center; gap: 12px; flex: 1; }
    .result-area.visible { display: flex; }
    .result-msg { font-size: 13px; color: var(--green); font-weight: 600; }
    .result-btn { padding: 8px 18px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--card); color: var(--text); font-size: 13px; cursor: pointer;
      text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
      transition: border-color 0.15s; }
    .result-btn:hover { border-color: var(--accent); color: var(--accent); }

    .error-msg { color: #ff4444; font-size: 13px; }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<header>
  <h1>Playable Ad Generator</h1>
  <span>Configure â†’ Generate â†’ Preview</span>
</header>

<div class="main">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- PREVIEW PANEL (left 1/3)                           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="preview-panel">
    <div class="preview-header">
      <h2>Live Preview</h2>
      <div style="display:flex; gap:6px">
        <button class="ve-small-btn primary" onclick="veCapturePreview()" style="font-size:11px; padding:4px 10px">ğŸ“¸ Capture</button>
        <button class="ve-small-btn" onclick="previewReload()" style="font-size:11px; padding:4px 10px">â†» Reload</button>
      </div>
    </div>
    <div class="preview-iframe-wrap">
      <iframe id="preview-iframe" src="about:blank"></iframe>
      <div class="preview-placeholder" id="preview-placeholder">
        <div style="font-size:40px; opacity:0.3">ğŸ®</div>
        <div>No build loaded</div>
        <div style="font-size:11px; margin-top:8px">Click "Generate Ad" to preview</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- WORKSPACE (right 2/3) â€” tabs + content            -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="workspace">

    <!-- â”€â”€ TABS â”€â”€ -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="mechanics">Mechanics</button>
      <button class="tab-btn"        data-tab="visual">Visual</button>
      <button class="tab-btn"        data-tab="levels">Levels</button>
      <button class="tab-btn"        data-tab="visual-editor">ğŸ–¼ Visual Editor</button>
    </div>

    <!-- â”€â”€ LOAD BAR â”€â”€ -->
    <div class="load-bar">
      <label>Load build</label>
      <select id="load-build-select">
        <option value="">-- select a previous build --</option>
      </select>
      <div class="load-bar-divider"></div>
      <button class="reset-btn" id="reset-defaults-btn">Reset to Defaults</button>
    </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: MECHANICS                                     -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content active" id="tab-mechanics">
    <div class="section-card">
      <h2>Gameplay Settings</h2>
      <div class="form-grid">

        <div class="field">
          <label>Input Type</label>
          <select id="m_input_type">
            <option value="tap">Tap</option>
            <option value="drag">Drag</option>
            <option value="both">Both</option>
          </select>
        </div>

        <div class="field">
          <label>Card Move Speed</label>
          <select id="m_card_move_speed">
            <option value="slow">Slow</option>
            <option value="medium">Medium</option>
            <option value="fast">Fast</option>
          </select>
        </div>

        <div class="field">
          <label>Animation Type</label>
          <select id="m_animation_type">
            <option value="flip">Flip</option>
            <option value="slide">Slide</option>
            <option value="instant">Instant</option>
          </select>
        </div>

        <div class="field">
          <label>Highlight Valid Moves</label>
          <div class="toggle-row" style="margin-top:4px">
            <label class="toggle">
              <input type="checkbox" id="m_highlight_valid_moves" />
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Show glow on playable cards</span>
          </div>
        </div>

        <div class="field">
          <label>Auto Complete</label>
          <div class="toggle-row" style="margin-top:4px">
            <label class="toggle">
              <input type="checkbox" id="m_auto_complete_enabled" />
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Auto-complete when possible</span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: VISUAL                                        -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-visual">
    <div class="section-card">
      <h2>Colors</h2>
      <div class="form-grid" id="color-fields">
        <!-- injected by JS -->
      </div>
    </div>
    <div class="section-card">
      <h2>Style</h2>
      <div class="form-grid">

        <div class="field">
          <label>UI Theme</label>
          <select id="v_ui_theme">
            <option value="dark">Dark</option>
            <option value="classic">Classic</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>

        <div class="field">
          <label>Card Back Pattern</label>
          <select id="v_card_back_pattern">
            <option value="solid">Solid</option>
            <option value="stripes">Stripes</option>
            <option value="dots">Dots</option>
          </select>
        </div>

        <div class="field">
          <label>Font Family</label>
          <input type="text" id="v_font_family" placeholder="Arial, sans-serif" />
        </div>

      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: LEVELS                                        -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-levels">

    <div class="section-card">
      <h2>Global Level Settings</h2>
      <div class="form-grid">

        <div class="field">
          <label>Target URL</label>
          <input type="text" id="l_target_url" placeholder="https://example.com" />
        </div>

        <div class="field">
          <label>CTA Button Text</label>
          <input type="text" id="l_cta_text" placeholder="Play Now!" />
        </div>

        <div class="field">
          <label>Testing Mode (HUD overlay)</label>
          <div class="toggle-row" style="margin-top:4px">
            <label class="toggle">
              <input type="checkbox" id="l_testing_mode" />
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Show debug HUD</span>
          </div>
        </div>

      </div>
    </div>

    <div id="levels-list">
      <!-- level cards injected by JS -->
    </div>

    <button class="add-level-btn" id="add-level-btn">
      <span>+</span> Add Level
    </button>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- VISUAL EDITOR TAB                                -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <style>
    .ve-section    { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:16px; }
    .ve-path-btns  { display:flex; gap:12px; margin-top:12px; }
    .ve-path-btn   { flex:1; padding:14px 10px; border:2px solid var(--border); background:var(--bg); color:var(--text);
                     border-radius:var(--radius); cursor:pointer; font-size:14px; text-align:center; transition:.15s; }
    .ve-path-btn:hover, .ve-path-btn.selected { border-color:#6366f1; background:#6366f110; }
    .ve-drop-zone  { border:2px dashed var(--border); border-radius:var(--radius); padding:24px; text-align:center;
                     cursor:pointer; color:var(--muted); transition:.15s; position:relative; }
    .ve-drop-zone:hover { border-color:#6366f1; color:var(--text); }
    .ve-drop-zone.has-image { padding:0; overflow:hidden; cursor:default; }
    .ve-canvas-wrap { position:relative; display:inline-block; }
    .ve-canvas-wrap canvas { display:block; }
    .ve-canvas-wrap .ve-draw-canvas { position:absolute; top:0; left:0; cursor:crosshair; }
    .ve-tools      { display:flex; gap:8px; align-items:center; padding:8px 0; flex-wrap:wrap; }
    .ve-tool-btn   { padding:5px 12px; font-size:12px; border:1px solid var(--border); background:var(--bg);
                     color:var(--text); border-radius:var(--radius); cursor:pointer; }
    .ve-tool-btn.active { border-color:#6366f1; background:#6366f120; }
    .ve-tool-btn:hover  { border-color:var(--text); }
    .ve-label      { font-size:12px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px; }
    .ve-suggestion { display:block; width:100%; text-align:left; padding:10px 12px; margin-bottom:6px;
                     background:var(--bg); border:1px solid var(--border); border-radius:var(--radius);
                     color:var(--text); font-size:13px; cursor:pointer; transition:.15s; }
    .ve-suggestion:hover, .ve-suggestion.selected { border-color:#6366f1; background:#6366f110; }
    .ve-variations { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .ve-variation  { position:relative; cursor:pointer; border:3px solid transparent; border-radius:var(--radius); overflow:hidden; }
    .ve-variation:hover, .ve-variation.selected { border-color:#6366f1; }
    .ve-variation img { display:block; width:120px; height:160px; object-fit:cover; }
    .ve-asset-checks { display:flex; gap:16px; margin:10px 0; }
    .ve-asset-checks label { display:flex; align-items:center; gap:6px; cursor:pointer; font-size:14px; }
    .ve-asset-card  { border:2px solid var(--border); border-radius:var(--radius); padding:8px; cursor:pointer;
                      background:var(--bg); transition:.15s; text-align:center; width:110px; }
    .ve-asset-card:hover  { border-color:#6366f1; }
    .ve-asset-card.selected { border-color:#6366f1; background:#6366f110; }
    .ve-asset-card img  { width:90px; height:120px; object-fit:cover; border-radius:3px; display:block; margin:0 auto 6px; }
    .ve-asset-card .ve-ac-name { font-size:12px; font-weight:600; color:var(--text); }
    .ve-asset-card .ve-ac-desc { font-size:11px; color:var(--muted); margin-top:2px; }
    .ve-history    { list-style:none; padding:0; margin:0; }
    .ve-history li { display:flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--border);
                     border-radius:var(--radius); margin-bottom:6px; background:var(--bg); font-size:13px; }
    .ve-badge      { font-size:11px; font-weight:700; padding:2px 7px; border-radius:999px; }
    .ve-badge.A    { background:#0ea5e920; color:#0ea5e9; border:1px solid #0ea5e940; }
    .ve-badge.B    { background:#a855f720; color:#a855f7; border:1px solid #a855f740; }
    .ve-badge.ok   { background:#22c55e20; color:#22c55e; border:1px solid #22c55e40; }
    .ve-status     { font-size:12px; color:var(--muted); }
    .ve-thumb      { width:32px; height:42px; object-fit:cover; border-radius:3px; border:1px solid var(--border); flex-shrink:0; }
    .ve-apply-btn  { width:100%; padding:13px; background:#6366f1; color:#fff; border:none; border-radius:var(--radius);
                     font-size:15px; font-weight:600; cursor:pointer; margin-top:8px; transition:.15s; }
    .ve-apply-btn:hover { background:#4f46e5; }
    .ve-apply-btn:disabled { background:var(--card); color:var(--muted); cursor:default; }
    .ve-small-btn  { padding:6px 14px; font-size:13px; border:1px solid var(--border); background:var(--bg);
                     color:var(--text); border-radius:var(--radius); cursor:pointer; transition:.15s; }
    .ve-small-btn:hover  { border-color:#6366f1; }
    .ve-small-btn.primary { background:#6366f1; border-color:#6366f1; color:#fff; }
    .ve-small-btn.primary:hover { background:#4f46e5; }
    .ve-small-btn:disabled { opacity:.5; cursor:default; }
    .ve-note       { font-size:12px; color:var(--muted); margin-top:4px; }
    .ve-step-header { font-size:14px; font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .ve-step-num   { width:22px; height:22px; border-radius:50%; background:#6366f1; color:#fff;
                     font-size:11px; font-weight:700; display:inline-flex; align-items:center; justify-content:center; flex-shrink:0; }
    .ve-divider    { border:none; border-top:1px solid var(--border); margin:16px 0; }
  </style>

  <div class="tab-content" id="tab-visual-editor">

    <!-- â”€â”€ Applied Changes (grouped by build) â”€â”€ -->
    <!-- ğŸŸ¢ ZONE 1: Applied Changes (Archive/Review) -->
    <div class="ve-section" style="border:2px solid #22c55e">
      <h2 style="margin-bottom:12px; color:#22c55e">âœ“ Applied Changes</h2>
      <div id="ve-applied-list"></div>
      <p class="ve-note" id="ve-applied-empty">No builds yet. Pending changes will move here after a successful build.</p>
    </div>

    <!-- ğŸŸ  ZONE 2: Pending Requests (Active Workflow) -->
    <div class="ve-section" style="border:2px solid #f59e0b">
      <h2 style="margin-bottom:12px; color:#f59e0b">ğŸ“‹ Pending Requests</h2>
      <ul class="ve-history" id="ve-pending-list"></ul>
      <p class="ve-note" id="ve-pending-empty">No pending requests yet.</p>
    </div>

    <!-- ğŸŸ  ZONE 2: Build (Active Workflow) -->
    <div class="ve-section" style="border:2px solid #f59e0b">
      <h2 style="color:#f59e0b">Build</h2>
      <p class="ve-note" style="margin-bottom:10px">Applied changes are automatically included when you click Generate Ad (footer button), or use the button below.</p>
      <div id="ve-asset-preview" style="margin-bottom:12px; display:none">
        <div class="ve-label">Stored image assets (will be embedded in next build):</div>
        <div id="ve-asset-preview-items" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px"></div>
      </div>
      <button class="ve-apply-btn" onclick="onGenerate()" style="background:#f59e0b; border-color:#f59e0b; color:#fff">Build with All Pending Changes</button>
    </div>

    <!-- ğŸ”µ ZONE 3: New Request (Creation) -->
    <div class="ve-section" style="border:2px solid #6366f1">
      <button class="ve-apply-btn" onclick="veShowForm()" style="background:#6366f1; border-color:#6366f1; color:#fff">â• New Request</button>
    </div>

    <!-- â”€â”€ New Request Form â”€â”€ -->
    <div class="ve-section" id="ve-form" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px">
        <h2 style="margin:0">New Request</h2>
        <button class="ve-tool-btn" onclick="veHideForm()">âœ• Cancel</button>
      </div>

      <!-- Step 1 â€” Choose category (shown immediately) -->
      <div id="ve-step-category">
        <div class="ve-step-header"><span class="ve-step-num">1</span> What do you want to change?</div>
        <div class="ve-path-btns">
          <button class="ve-path-btn" id="ve-btn-game-design" onclick="veSelectCategory('game_design')">
            <div style="font-size:22px">ğŸ®</div>
            <div style="font-weight:600; margin-top:6px">Game Design</div>
            <div style="font-size:11px; color:#6366f1; margin-top:2px">Global</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Core mechanics, rules, game-wide settings</div>
          </button>
          <button class="ve-path-btn" id="ve-btn-level-design" onclick="veSelectCategory('level_design')">
            <div style="font-size:22px">ğŸ¯</div>
            <div style="font-weight:600; margin-top:6px">Level Design</div>
            <div style="font-size:11px; color:#0ea5e9; margin-top:2px">Level-specific</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Puzzle layouts, card positions for specific level</div>
          </button>
          <button class="ve-path-btn" id="ve-btn-graphics-ui" onclick="veSelectCategory('graphics_ui')">
            <div style="font-size:22px">ğŸ¨</div>
            <div style="font-weight:600; margin-top:6px">Graphics &amp; UI</div>
            <div style="font-size:11px; color:#6366f1; margin-top:2px">Global</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Colors, fonts, UI elements, visual styling</div>
          </button>
          <button class="ve-path-btn" id="ve-btn-animation" onclick="veSelectCategory('animation')">
            <div style="font-size:22px">âœ¨</div>
            <div style="font-weight:600; margin-top:6px">Animation &amp; Polish</div>
            <div style="font-size:11px; color:#6366f1; margin-top:2px">Global</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Motion, timing, juice, visual effects</div>
          </button>
          <button class="ve-path-btn" id="ve-btn-legacy" onclick="veSelectCategory('legacy')">
            <div style="font-size:22px">ğŸ“</div>
            <div style="font-weight:600; margin-top:6px">Legacy</div>
            <div style="font-size:11px; color:var(--muted); margin-top:2px">Auto-detected</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Free-form requests (advanced users)</div>
          </button>
          <button class="ve-path-btn" id="ve-btn-C" onclick="veSelectPath('C')">
            <div style="font-size:22px">âœï¸</div>
            <div style="font-weight:600; margin-top:6px">Edit an Asset</div>
            <div style="font-size:11px; color:var(--muted); margin-top:2px">Path C</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Select an asset and describe the change</div>
          </button>
        </div>

        <!-- Level selection dropdown (shown only for Level Design) -->
        <div id="ve-step-level" style="display:none; margin-top:16px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">1b</span> Which level are you modifying?</div>
          <select id="ve-level-select" class="ve-select" onchange="veUpdateSelectedLevel()" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg); color:var(--text); font-size:14px">
            <!-- Populated dynamically by JavaScript -->
          </select>
        </div>
      </div>

      <!-- Screenshot section (shown for Path A and B) -->
      <div id="ve-screenshot-section" style="display:none; margin-top:16px">
        <hr class="ve-divider">
        <div class="ve-step-header"><span class="ve-step-num">2</span> Upload a screenshot of the current build</div>
        <div class="ve-drop-zone" id="ve-drop-zone" onclick="document.getElementById('ve-file-input').click()">
          <p>Click to upload or drag &amp; drop a screenshot (PNG / JPG)</p>
          <input type="file" id="ve-file-input" accept="image/*" style="display:none">
        </div>

        <!-- Canvas + tools (shown after upload) -->
        <div id="ve-canvas-area" style="display:none; margin-top:12px">
          <div class="ve-tools">
            <span class="ve-label">Draw:</span>
            <button class="ve-tool-btn active" id="ve-tool-pen"    onclick="veSetTool('pen')">âœ Pen</button>
            <button class="ve-tool-btn"        id="ve-tool-arrow"  onclick="veSetTool('arrow')">â†’ Arrow</button>
            <button class="ve-tool-btn"        id="ve-tool-rect"   onclick="veSetTool('rect')">â–­ Box</button>
            <button class="ve-tool-btn"        id="ve-tool-erase"  onclick="veSetTool('erase')">âŒ« Erase</button>
            <button class="ve-tool-btn"        onclick="veClearDrawing()">Clear</button>
            <input type="color" id="ve-draw-color" value="#ff0000" title="Color" style="width:28px;height:28px;border:none;padding:0;cursor:pointer;border-radius:4px">
            <input type="range" id="ve-draw-size"  min="2" max="20" value="4" style="width:80px" title="Brush size">
            <button class="ve-tool-btn primary" id="ve-save-drawing-btn" onclick="veSaveDrawing()" style="margin-left:auto">ğŸ’¾ Save Drawing</button>
          </div>
          <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap">
            <div>
              <div class="ve-note" style="margin-bottom:4px; text-align:center">Original (clean)</div>
              <div class="ve-canvas-wrap" id="ve-canvas-wrap">
                <canvas id="ve-bg-canvas"></canvas>
                <canvas id="ve-draw-canvas" class="ve-draw-canvas"></canvas>
              </div>
            </div>
            <div id="ve-composite-wrap" style="display:none">
              <div class="ve-note" style="margin-bottom:4px; text-align:center; color:#22c55e; font-weight:600">âœ“ What Claude will see</div>
              <img id="ve-composite-img" style="display:block; border-radius:var(--radius); border:2px solid #22c55e" />
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ PATH A â€” Positioning & Layout â”€â”€ -->
      <div id="ve-path-a-form" style="display:none; margin-top:16px">
        <hr class="ve-divider">
        <div class="ve-step-header"><span class="ve-step-num">2</span> Describe the layout change</div>

        <!-- Left-right layout: Text field (left) + Screenshot (right, optional) -->
        <div style="display:flex; gap:16px; align-items:flex-start; margin-bottom:16px">

          <!-- LEFT: Text description (always visible) -->
          <div style="flex:1; min-width:300px">
            <div class="ve-label">Describe what you want changed:</div>
            <textarea id="ve-text-note" style="width:100%;height:200px;resize:vertical;padding:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;box-sizing:border-box;font-family:inherit"
              placeholder="E.g. 'Move the top row to 4 cards, spread them wider' or 'Add a 3-card column on the left' or 'Remove the draw pile'"></textarea>
            <p class="ve-note" style="margin-top:6px">
              You can submit text-only, or add a screenshot/drawing for more context.<br>
              <strong>Tip:</strong> Reference specific gallery images with @Image01, @Image02, etc. in your text.
            </p>
          </div>

          <!-- RIGHT: Image Gallery (Horizontal) -->
          <div style="flex:1; min-width:300px">
            <div class="ve-label">Reference Images (Optional)</div>

            <!-- Empty state - shown when no images -->
            <div id="ve-a-gallery-empty"
                 style="display:flex; align-items:center; justify-content:center; min-height:180px; border:2px dashed var(--border); border-radius:var(--radius); background:var(--surface); cursor:pointer; transition:all 0.2s"
                 onclick="veShowImageUpload()"
                 ondragover="veGalleryDragOver(event)"
                 ondragleave="veGalleryDragLeave(event)"
                 ondrop="veGalleryDrop(event)">
              <div style="text-align:center; color:var(--muted); padding:20px">
                <div style="font-size:40px; margin-bottom:10px">ğŸ“</div>
                <div style="font-size:14px; font-weight:600; margin-bottom:6px">No reference images yet</div>
                <div style="font-size:12px">Click to upload, drag & drop, or use the Capture button</div>
              </div>
            </div>

            <!-- Image Gallery - horizontal scroll with drag & drop (shown when images exist) -->
            <div id="ve-a-gallery"
                 style="display:none; gap:12px; overflow-x:auto; padding:10px 0; min-height:180px; align-items:flex-start; border:2px dashed var(--border); border-radius:var(--radius); transition:all 0.2s"
                 ondragover="veGalleryDragOver(event)"
                 ondragleave="veGalleryDragLeave(event)"
                 ondrop="veGalleryDrop(event)">
              <!-- Image cards will be inserted here dynamically -->
            </div>

            <!-- Upload button -->
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center">
              <button class="ve-small-btn primary" onclick="veShowImageUpload()">+ Upload Image</button>
              <button class="ve-small-btn" onclick="veShowLibrary()">ğŸ“ Show Library</button>
              <button class="ve-small-btn" onclick="veHideLibrary()">ğŸ“ Hide Library</button>
              <button class="ve-small-btn" onclick="veClearAllImages()" style="background:var(--danger); color:#fff">Clear All</button>
              <input type="file" id="ve-a-file-input" accept="image/*" style="display:none" onchange="veHandleImageUpload(this)">
            </div>
            <p class="ve-note" style="margin-top:6px; font-size:11px">
              Click any image to make it ACTIVE (always sent to Claude). Reference other images with @Image01, @Image02, etc. â€” only ACTIVE + @referenced images are sent.
            </p>
          </div>
        </div>

        <!-- Step 3: Improve or Use As-Is -->
        <hr class="ve-divider" style="margin:20px 0">
        <div class="ve-step-header"><span class="ve-step-num">3</span> Submit your request</div>
        <div style="display:flex; gap:10px; margin-bottom:8px">
          <button class="ve-small-btn primary" id="ve-a-improve-btn" onclick="veImprovePathA()">âœ¨ Improve My Prompt</button>
          <button class="ve-small-btn" id="ve-a-skip-btn" onclick="veSkipImprovePathA()">Use As-Is â†’ Groom it</button>
        </div>
        <div id="ve-a-status" class="ve-note" style="margin-top:6px"></div>

        <!-- Improved prompt result (shown after clicking Improve) -->
        <div id="ve-a-improved-section" style="display:none; margin-top:16px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">4</span> Improved Prompt</div>
          <div style="margin-bottom:12px">
            <div class="ve-label">Claude's suggestion:</div>
            <div id="ve-a-improved-prompt" style="padding:12px; background:var(--bg); border:2px solid #22c55e; border-radius:var(--radius); font-size:14px; line-height:1.6; font-weight:500; margin-top:6px"></div>
          </div>
          <button class="ve-apply-btn" id="ve-a-apply-btn" onclick="veApplyPathA()">âœ¨ Groom it!</button>
        </div>

        <!-- Reasoning from Claude (shown after clicking Apply) -->
        <div id="ve-a-reasoning-section" style="display:none; margin-top:16px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">5</span> Claude's Analysis</div>

          <!-- 1. Simple Explanation -->
          <div style="margin-bottom:16px">
            <div class="ve-label">ğŸ“ What Claude Understands:</div>
            <div id="ve-a-reasoning-simple" style="padding:12px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); font-size:13px; line-height:1.6; margin-top:6px"></div>
          </div>

          <!-- 2. Complexity/Risk Label -->
          <div style="margin-bottom:16px">
            <div class="ve-label">Complexity Assessment:</div>
            <div id="ve-a-reasoning-complexity" style="padding:10px 16px; border-radius:var(--radius); font-size:14px; font-weight:600; margin-top:6px; display:inline-block"></div>
          </div>

          <!-- 3. Technical Details -->
          <div style="margin-bottom:16px">
            <div class="ve-label">ğŸ”§ Technical Details:</div>
            <div id="ve-a-reasoning-technical" style="padding:12px; background:var(--bg); border:1px solid var(--border); border-radius:var(--radius); font-size:12px; line-height:1.6; font-family:monospace; margin-top:6px"></div>
          </div>

          <!-- Approve Button -->
          <button class="ve-apply-btn" id="ve-a-approve-btn" onclick="veApprovePathA()">âœ“ Approve & Add to Pending Requests</button>
        </div>
      </div>

      <!-- â”€â”€ PATH B â”€â”€ -->
      <div id="ve-path-b-form" style="display:none; margin-top:16px">
        <hr class="ve-divider">

        <!-- B Step 1 â€” Rough prompt -->
        <div id="ve-b-prompt-step">
          <div class="ve-step-header"><span class="ve-step-num">3</span> Describe the visual style you want</div>
          <textarea id="ve-rough-prompt" style="width:100%;height:70px;resize:vertical;padding:8px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;box-sizing:border-box"
            placeholder="E.g. 'dark mystical forest background with glowing plants'"></textarea>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
            <button class="ve-small-btn primary" id="ve-enhance-btn" onclick="veEnhancePrompt()">âœ¨ Suggest Better Prompts</button>
            <button class="ve-small-btn" id="ve-skip-enhance-btn" onclick="veSkipEnhance()">Skip â†’ Use As-Is</button>
          </div>
          <div id="ve-b-enhance-status" class="ve-note" style="margin-top:6px"></div>
        </div>

        <!-- B Step 2 â€” Prompt suggestions -->
        <div id="ve-b-suggestions-step" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">4</span> Pick a refined prompt (or edit)</div>
          <div id="ve-suggestions-list"></div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="ve-small-btn primary" id="ve-gen-ref-btn" onclick="veGenerateReference()" disabled>Generate Reference Image</button>
            <button class="ve-small-btn" onclick="veBackToPrompt()">â† Back</button>
          </div>
          <div id="ve-b-gen-status" class="ve-note" style="margin-top:6px"></div>
        </div>

        <!-- B Step 3 â€” Variations -->
        <div id="ve-b-variations-step" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">5</span> Pick a reference image</div>
          <div class="ve-variations" id="ve-variations-list"></div>
          <div style="margin-top:10px; display:flex; gap:8px">
            <button class="ve-small-btn primary" id="ve-ref-confirm-btn" onclick="veConfirmReference()" disabled>Use This Reference</button>
            <button class="ve-small-btn" onclick="veRegenerateReference()">â†» Regenerate</button>
          </div>
          <p class="ve-note">After selecting: you can draw annotations on the reference above before applying.</p>
        </div>

        <!-- B Step 4 â€” Asset browser + selection -->
        <div id="ve-b-assets-step" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">6</span> Select assets to replace</div>
          <p class="ve-note" style="margin-bottom:10px">These are the current project files. Check the ones you want regenerated in the style of the reference image.</p>
          <div id="ve-asset-browser" style="display:flex; gap:14px; flex-wrap:wrap; margin-bottom:12px">
            <!-- asset cards injected by JS -->
          </div>
          <div id="ve-b-asset-status" class="ve-note" style="margin-top:6px"></div>
          <button class="ve-apply-btn" id="ve-b-apply-btn" onclick="veApplyPathB()">Generate &amp; Save Assets</button>
          <p class="ve-note" style="margin-top:8px">New PNGs are saved to <code>static/assets/project/</code> and embedded automatically in the next Build.</p>
        </div>
      </div>

      <!-- â”€â”€ PATH C â€” Direct Asset Edit â”€â”€ -->
      <div id="ve-path-c-form" style="display:none; margin-top:16px">
        <hr class="ve-divider">

        <!-- C Step 1 â€” Pick asset -->
        <div class="ve-step-header"><span class="ve-step-num">2</span> Select the asset to edit</div>
        <p class="ve-note" style="margin-bottom:10px">Click an asset to select it.</p>
        <div id="ve-c-asset-picker" style="display:flex; gap:14px; flex-wrap:wrap; margin-bottom:4px">
          <!-- thumbnails injected by JS -->
        </div>

        <!-- C Step 2 â€” Prompt (shown after asset picked) -->
        <div id="ve-c-prompt-section" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">3</span> Describe the change</div>
          <textarea id="ve-c-prompt" style="width:100%;height:80px;resize:vertical;padding:8px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;box-sizing:border-box"
            placeholder="E.g. 'Make it a red velvet table instead of green felt' or 'Change the card back to gold floral art deco'"></textarea>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
            <button class="ve-small-btn primary" id="ve-c-improve-btn" onclick="veImprovePathC()">âœ¨ Improve My Prompt</button>
            <button class="ve-small-btn" id="ve-c-use-btn" onclick="veUsePathCPrompt()">Use This Prompt</button>
          </div>
          <div id="ve-c-gen-status" class="ve-note" style="margin-top:6px"></div>

          <!-- Reference Images Gallery (shared state, rendered by JS) -->
          <div style="margin-top:20px">
            <div class="ve-label">Reference Images (Optional)</div>
            <p class="ve-note" style="margin-top:4px; margin-bottom:10px; font-size:11px">
              Click any image to make it ACTIVE. Reference images with @Image01, @Image02, etc. in your prompt above.
            </p>

            <!-- Gallery container for Path C (uses same rendering function as Path A) -->
            <div id="ve-c-gallery-display" style="min-height:180px"
                 ondragover="veGalleryDragOver(event)"
                 ondragleave="veGalleryDragLeave(event)"
                 ondrop="veGalleryDrop(event)">
              <!-- Rendered by veRenderImageGallery() -->
            </div>

            <!-- Upload buttons -->
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center">
              <button class="ve-small-btn primary" onclick="veShowImageUpload()">+ Upload Image</button>
              <button class="ve-small-btn" onclick="veShowLibrary()">ğŸ“ Show Library</button>
              <button class="ve-small-btn" onclick="veHideLibrary()">ğŸ“ Hide Library</button>
              <button class="ve-small-btn" onclick="veClearAllImages()" style="background:var(--danger); color:#fff">Clear All</button>
            </div>
          </div>
        </div>

        <!-- C Step 3 â€” Before / After preview + approve (shown after generation) -->
        <div id="ve-c-preview-section" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">4</span> Review the result</div>
          <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:12px">
            <div>
              <div class="ve-note" style="margin-bottom:4px; text-align:center">Before</div>
              <img id="ve-c-before-img" style="display:block; border-radius:var(--radius); border:1px solid var(--border); max-height:200px; width:auto">
            </div>
            <div>
              <div class="ve-note" style="margin-bottom:4px; text-align:center; color:#6366f1; font-weight:600">After</div>
              <img id="ve-c-after-img" style="display:block; border-radius:var(--radius); border:2px solid #6366f1; max-height:200px; width:auto">
            </div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <button class="ve-apply-btn" id="ve-c-approve-btn" onclick="veApproveEditAsset()" style="width:auto; padding:10px 24px">Approve &amp; Save</button>
            <button class="ve-small-btn" id="ve-c-retry-btn" onclick="veRetryEditAsset()">â†» Try Again</button>
          </div>
          <div id="ve-c-approve-status" class="ve-note" style="margin-top:8px"></div>
        </div>
      </div>

    </div><!-- #ve-form -->

    <!-- â”€â”€ Asset Library â”€â”€ HIDDEN FOR NOW -->
    <div class="ve-section" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h2 style="margin:0">Project Assets</h2>
        <button class="ve-small-btn" onclick="veRefreshAssetLibrary()">â†» Refresh</button>
      </div>
      <p class="ve-note" style="margin-bottom:10px">Current files in <code>static/assets/project/</code> â€” these are embedded in every Build.</p>
      <div id="ve-library-grid" style="display:flex; gap:14px; flex-wrap:wrap"></div>
    </div>

    <!-- â”€â”€ Server Log â”€â”€ -->
    <div class="ve-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <h2 style="margin:0">Server Log</h2>
        <div style="display:flex; gap:8px">
          <button class="ve-small-btn" onclick="veRefreshLogs()">â†» Refresh</button>
          <button class="ve-small-btn" onclick="veClearLogView()">Clear view</button>
        </div>
      </div>
      <div id="ve-log-box" style="background:#0d1117; border:1px solid var(--border); border-radius:var(--radius); padding:12px; height:220px; overflow-y:auto; font-family:monospace; font-size:12px; line-height:1.6; color:#e6edf3; white-space:pre-wrap; word-break:break-all;">
        <span style="color:#6e7681">Log will appear here â€” click Refresh or perform an action.</span>
      </div>
      <p class="ve-note" style="margin-top:6px">Shows the last 60 lines from <code>logs/server.log</code>. Auto-refreshes after each API call.</p>
    </div>

  </div><!-- #tab-visual-editor -->

  </div><!-- .workspace -->

</div><!-- .main -->

<!-- â”€â”€ FOOTER â”€â”€ -->
<footer>
  <button class="generate-btn" id="generate-btn">Generate Ad</button>

  <div class="result-area" id="result-area">
    <span class="result-msg" id="result-msg">Build ready!</span>
    <a class="result-btn" id="preview-btn" href="#" target="_blank">Preview</a>
    <button class="result-btn" id="download-btn">Download</button>
  </div>

  <span class="error-msg" id="error-msg"></span>
</footer>

<!-- IMAGE EDIT MODAL -->
<div id="ve-edit-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:10000; overflow:auto">
  <div style="max-width:900px; margin:40px auto; background:var(--bg); border-radius:var(--radius); padding:24px; box-shadow:0 20px 60px rgba(0,0,0,0.5)">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
      <h3 style="margin:0; color:var(--text)">âœï¸ Draw on <span id="ve-edit-image-name">Image</span></h3>
      <button class="ve-small-btn" onclick="veCancelEditImage()">Cancel</button>
    </div>

    <!-- Canvas Container -->
    <div style="position:relative; display:inline-block; border:2px solid var(--border); border-radius:4px; background:#000">
      <canvas id="ve-edit-bg-canvas" style="position:absolute; top:0; left:0"></canvas>
      <canvas id="ve-edit-draw-canvas" style="position:relative"></canvas>
    </div>

    <!-- Drawing Tools -->
    <div style="margin-top:16px; display:flex; gap:12px; align-items:center">
      <label style="font-size:13px; color:var(--text)">
        Color: <input type="color" id="ve-edit-color" value="#ff0000" style="margin-left:4px; width:40px; height:28px; border:none; cursor:pointer">
      </label>
      <label style="font-size:13px; color:var(--text)">
        Size: <input type="range" id="ve-edit-size" min="1" max="20" value="3" style="width:100px; margin-left:4px">
        <span id="ve-edit-size-val">3</span>px
      </label>
      <button class="ve-small-btn" onclick="veClearEditCanvas()">Clear Drawing</button>
    </div>

    <!-- Save Button -->
    <div style="margin-top:20px; padding-top:16px; border-top:1px solid var(--border)">
      <button class="ve-apply-btn" onclick="veSaveEditedImage()">ğŸ’¾ Save as New Image</button>
    </div>
  </div>
</div>

<!-- IMAGE PREVIEW MODAL (Lightbox) -->
<div id="ve-preview-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:10001; cursor:pointer; display:flex; align-items:center; justify-content:center" onclick="veCloseImagePreview()">
  <button onclick="veCloseImagePreview()" style="position:absolute; top:20px; right:20px; width:50px; height:50px; border:none; background:rgba(255,255,255,0.2); color:#fff; font-size:30px; cursor:pointer; border-radius:50%; transition:background 0.2s; z-index:10002" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âœ•</button>
  <img id="ve-preview-image" src="" style="max-width:90%; max-height:90%; object-fit:contain; pointer-events:none">
</div>

<!-- IMAGE NANO BANANA MODAL -->
<div id="ve-nano-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:10000; overflow:auto">
  <div style="max-width:700px; margin:80px auto; background:var(--bg); border-radius:var(--radius); padding:24px; box-shadow:0 20px 60px rgba(0,0,0,0.5)">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
      <h3 style="margin:0; color:var(--text)">âœ¨ AI Modify <span id="ve-nano-image-name">Image</span></h3>
      <button class="ve-small-btn" onclick="veCancelNanoBanana()">Cancel</button>
    </div>

    <!-- Image Preview -->
    <div style="text-align:center; margin-bottom:16px">
      <img id="ve-nano-preview" src="" style="max-width:100%; max-height:300px; border:2px solid var(--border); border-radius:4px">
    </div>

    <!-- Prompt Input -->
    <div style="margin-bottom:16px">
      <label class="ve-label">What do you want to change?</label>
      <textarea id="ve-nano-prompt" placeholder="e.g., Make the cards bigger, change the background to blue, add sparkles, etc." style="width:100%; min-height:100px; padding:10px; border:1px solid var(--border); border-radius:4px; background:var(--surface); color:var(--text); font-size:14px; font-family:inherit; resize:vertical"></textarea>
    </div>

    <!-- Status -->
    <div id="ve-nano-status" class="ve-note" style="margin-bottom:12px; min-height:20px"></div>

    <!-- Generate Buttons -->
    <div style="display:flex; gap:10px">
      <button class="ve-small-btn primary" id="ve-nano-improve-btn" onclick="veImproveNanoBanana()">âœ¨ Improve My Prompt</button>
      <button class="ve-small-btn" id="ve-nano-use-btn" onclick="veUseNanoBananaPrompt()">Use This Prompt</button>
    </div>
  </div>
</div>

<script>
'use strict';

// ============================================================
// COLOR FIELDS CONFIG
// ============================================================
const COLOR_FIELDS = [
  { id: 'v_background_color',   label: 'Background' },
  { id: 'v_table_felt_color',   label: 'Table Felt' },
  { id: 'v_card_face_color',    label: 'Card Face' },
  { id: 'v_card_back_color',    label: 'Card Back' },
  { id: 'v_card_border_color',  label: 'Card Border' },
  { id: 'v_highlight_color',    label: 'Highlight' },
  { id: 'v_button_color',       label: 'Button' },
  { id: 'v_button_text_color',  label: 'Button Text' },
  { id: 'v_primary_text_color', label: 'Primary Text' },
];

// ============================================================
// BUILD COLOR INPUTS
// ============================================================
function buildColorFields() {
  const container = document.getElementById('color-fields');
  COLOR_FIELDS.forEach(({ id, label }) => {
    const field = document.createElement('div');
    field.className = 'field';
    field.innerHTML =
      '<label>' + label + '</label>' +
      '<div class="color-row">' +
        '<input type="color" id="' + id + '" />' +
        '<input type="text" class="color-hex" id="' + id + '_hex" maxlength="7" placeholder="#000000" />' +
      '</div>';
    container.appendChild(field);

    field.querySelector('#' + id).addEventListener('input', function() {
      field.querySelector('#' + id + '_hex').value = this.value;
    });
    field.querySelector('#' + id + '_hex').addEventListener('input', function() {
      if (/^#[0-9a-fA-F]{6}$/.test(this.value)) {
        field.querySelector('#' + id).value = this.value;
      }
    });
  });
}

// ============================================================
// LEVEL MANAGEMENT
// ============================================================
let levelCounter = 0;

function defaultLevel() {
  return {
    level_id:          levelCounter + 1,
    show_draw_pile:    false,
    enter_animation:   'shuffle_in',
    enter_duration_ms: 900,
    layout: {
      foundation_card: '7H',
      tableau: [
        { code: '6S', face_up: true, col: 0, row: 0 },
        { code: '8D', face_up: true, col: 1, row: 0 }
      ],
      draw_pile: [],
      grid: { cell_width: 82, cell_height: 110, origin_x: 0.5, origin_y: 0.18 }
    },
    timings: {
      win_screen_duration_ms:       2000,
      fail_screen_duration_ms:      2000,
      level_transition_duration_ms: 1000
    }
  };
}

function addLevelCard(lvl) {
  levelCounter++;
  const id = 'level_' + Date.now() + '_' + levelCounter;

  const card = document.createElement('div');
  card.className = 'level-card';
  card.dataset.levelId = id;

  const drawPileStr = (lvl.layout.draw_pile || []).join(', ');
  const tableauStr  = JSON.stringify(lvl.layout.tableau || [], null, 2);

  card.innerHTML =
    '<div class="level-header open" data-header="' + id + '">' +
      '<span class="chevron">&#9658;</span>' +
      '<span class="level-title">Level ' + levelCounter + '</span>' +
      '<span class="level-badge" id="' + id + '_badge">' + (lvl.layout.tableau || []).length + ' cards</span>' +
      '<button class="remove-btn" data-remove="' + id + '" title="Remove level">&#10005;</button>' +
    '</div>' +
    '<div class="level-body open" id="' + id + '_body">' +

      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Game Type</label>' +
          '<select id="' + id + '_game_type">' +
            '<option value="solitaire_simplified">Solitaire (Simple)</option>' +
          '</select>' +
        '</div>' +
        '<div class="field">' +
          '<label>Enter Animation</label>' +
          '<select id="' + id + '_enter_animation">' +
            '<option value="shuffle_in">Shuffle In</option>' +
            '<option value="drop_down">Drop Down</option>' +
            '<option value="bulk">Bulk</option>' +
          '</select>' +
        '</div>' +
        '<div class="field">' +
          '<label>Enter Duration (ms)</label>' +
          '<input type="number" id="' + id + '_enter_duration_ms" min="200" max="3000" step="50" value="' + lvl.enter_duration_ms + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Show Draw Pile</label>' +
          '<div class="toggle-row" style="margin-top:4px">' +
            '<label class="toggle">' +
              '<input type="checkbox" id="' + id + '_show_draw_pile" ' + (lvl.show_draw_pile ? 'checked' : '') + ' />' +
              '<span class="toggle-slider"></span>' +
            '</label>' +
            '<span class="toggle-label">Show pile at bottom-left</span>' +
          '</div>' +
        '</div>' +
      '</div>' +

      '<div class="level-subhead">Layout</div>' +
      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Foundation Card</label>' +
          '<input type="text" id="' + id + '_foundation_card" value="' + lvl.layout.foundation_card + '" placeholder="7H" maxlength="3" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Draw Pile (comma-separated)</label>' +
          '<input type="text" id="' + id + '_draw_pile" value="' + drawPileStr + '" placeholder="AS, 2D, QH" />' +
        '</div>' +
      '</div>' +

      '<div class="level-subhead">Tableau Cards (JSON)</div>' +
      '<div class="field full">' +
        '<textarea id="' + id + '_tableau" rows="6">' + tableauStr + '</textarea>' +
      '</div>' +

      '<div class="level-subhead">Grid</div>' +
      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Cell Width (px)</label>' +
          '<input type="number" id="' + id + '_cell_width" min="40" max="160" value="' + lvl.layout.grid.cell_width + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Cell Height (px)</label>' +
          '<input type="number" id="' + id + '_cell_height" min="60" max="200" value="' + lvl.layout.grid.cell_height + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Origin X (0=left, 1=right)</label>' +
          '<div class="range-row">' +
            '<input type="range" id="' + id + '_origin_x" min="0" max="1" step="0.01" value="' + lvl.layout.grid.origin_x + '" />' +
            '<span class="range-val" id="' + id + '_origin_x_val">' + lvl.layout.grid.origin_x + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="field">' +
          '<label>Origin Y (0=top, 1=bottom)</label>' +
          '<div class="range-row">' +
            '<input type="range" id="' + id + '_origin_y" min="0" max="1" step="0.01" value="' + lvl.layout.grid.origin_y + '" />' +
            '<span class="range-val" id="' + id + '_origin_y_val">' + lvl.layout.grid.origin_y + '</span>' +
          '</div>' +
        '</div>' +
      '</div>' +

      '<div class="level-subhead">Timings</div>' +
      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Win Screen (ms)</label>' +
          '<input type="number" id="' + id + '_win_ms" min="500" max="10000" step="100" value="' + lvl.timings.win_screen_duration_ms + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Fail Screen (ms)</label>' +
          '<input type="number" id="' + id + '_fail_ms" min="500" max="10000" step="100" value="' + lvl.timings.fail_screen_duration_ms + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Level Transition (ms)</label>' +
          '<input type="number" id="' + id + '_trans_ms" min="200" max="5000" step="100" value="' + lvl.timings.level_transition_duration_ms + '" />' +
        '</div>' +
      '</div>' +

      '<div class="coming-soon-block" style="border-color:#336633; opacity:1">' +
        '<div class="coming-soon-header">' +
          '<span>&#127918; Describe the Gameplay</span>' +
          '<span class="coming-soon-tag active">AI â€” Active</span>' +
        '</div>' +
        '<textarea id="' + id + '_gameplay_desc" style="border-color:#336633; color:var(--text)" placeholder="e.g. Foundation is 7H. Three columns â€” 6S face-up with 8C behind it, 9H face-up, 10D face-up. Easy chain, no draw pile."></textarea>' +
        '<div class="apply-row">' +
          '<button class="apply-btn" id="' + id + '_apply_btn">Groom it</button>' +
          '<span class="apply-status" id="' + id + '_apply_status"></span>' +
        '</div>' +
      '</div>' +

      '<div class="coming-soon-block">' +
        '<div class="coming-soon-header">' +
          '<span>ğŸ¨ Describe the Creative</span>' +
          '<span class="coming-soon-tag">Future milestone</span>' +
        '</div>' +
        '<textarea id="' + id + '_creative_desc" placeholder="e.g. Wild west desert background, sheriff sitting and relaxing, warm dusty colors, animated tumbleweeds..."></textarea>' +
        '<div class="coming-soon-note">In a future version this will generate visual themes, backgrounds, and character animations for this level.</div>' +
      '</div>' +

    '</div>';

  document.getElementById('levels-list').appendChild(card);

  // Set dropdown values (can't reliably do this in innerHTML)
  document.getElementById(id + '_game_type').value      = lvl.game_type || 'solitaire_simplified';
  document.getElementById(id + '_enter_animation').value = lvl.enter_animation;

  // Range live value labels
  ['origin_x', 'origin_y'].forEach(function(key) {
    var slider = document.getElementById(id + '_' + key);
    var valEl  = document.getElementById(id + '_' + key + '_val');
    slider.addEventListener('input', function() {
      valEl.textContent = parseFloat(slider.value).toFixed(2);
    });
  });

  // Tableau textarea -> update badge
  document.getElementById(id + '_tableau').addEventListener('input', function() {
    try {
      var arr = JSON.parse(this.value);
      document.getElementById(id + '_badge').textContent = arr.length + ' cards';
    } catch(e) {}
  });

  // Toggle header collapse
  card.querySelector('[data-header="' + id + '"]').addEventListener('click', function(e) {
    if (e.target.closest('[data-remove]')) return;
    var header = card.querySelector('[data-header="' + id + '"]');
    var body   = document.getElementById(id + '_body');
    header.classList.toggle('open');
    body.classList.toggle('open');
  });

  // Remove button
  card.querySelector('[data-remove="' + id + '"]').addEventListener('click', function() {
    card.remove();
    renumberLevels();
  });

  // Apply with AI button
  document.getElementById(id + '_apply_btn').addEventListener('click', function() {
    var desc   = document.getElementById(id + '_gameplay_desc').value.trim();
    var btn    = document.getElementById(id + '_apply_btn');
    var status = document.getElementById(id + '_apply_status');

    if (!desc) { status.textContent = 'Write a description first.'; return; }

    var levelIndex = Array.from(document.querySelectorAll('#levels-list .level-card')).indexOf(card);

    btn.disabled      = true;
    btn.textContent   = 'Grooming...';
    status.textContent = '';
    status.style.color = 'var(--muted)';

    fetch('/api/describe/gameplay', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ description: desc, level_index: levelIndex })
    })
    .then(function(r) {
      if (!r.ok) return r.json().then(function(e) { throw new Error(e.detail || 'Unknown error'); });
      return r.json();
    })
    .then(function(data) {
      var layout = data.layout;

      // Update foundation card
      document.getElementById(id + '_foundation_card').value = layout.foundation_card;

      // Update tableau textarea
      document.getElementById(id + '_tableau').value = JSON.stringify(layout.tableau, null, 2);

      // Update tableau badge
      document.getElementById(id + '_badge').textContent = layout.tableau.length + ' cards';

      // Update draw pile (comma-separated)
      document.getElementById(id + '_draw_pile').value = (layout.draw_pile || []).join(', ');

      // Update grid
      document.getElementById(id + '_cell_width').value  = layout.grid.cell_width;
      document.getElementById(id + '_cell_height').value = layout.grid.cell_height;
      document.getElementById(id + '_origin_x').value    = layout.grid.origin_x;
      document.getElementById(id + '_origin_y').value    = layout.grid.origin_y;
      document.getElementById(id + '_origin_x_val').textContent = parseFloat(layout.grid.origin_x).toFixed(2);
      document.getElementById(id + '_origin_y_val').textContent = parseFloat(layout.grid.origin_y).toFixed(2);

      status.style.color = '#66dd66';
      status.textContent = 'Layout applied!';
      setTimeout(function() { status.textContent = ''; }, 4000);
    })
    .catch(function(err) {
      status.style.color = '#ff6666';
      status.textContent = 'Error: ' + err.message;
    })
    .finally(function() {
      btn.disabled    = false;
      btn.textContent = 'Groom it';
    });
  });

  renumberLevels();
}

function renumberLevels() {
  document.querySelectorAll('#levels-list .level-card').forEach(function(card, i) {
    card.querySelector('.level-title').textContent = 'Level ' + (i + 1);
  });
}

// ============================================================
// POPULATE FORM FROM DEFAULTS
// ============================================================
function setVal(id, val) {
  var el = document.getElementById(id);
  if (!el) return;
  if (el.type === 'checkbox') { el.checked = !!val; return; }
  el.value = val;
}

function setColor(id, hex) {
  var picker = document.getElementById(id);
  var text   = document.getElementById(id + '_hex');
  if (picker) picker.value = hex;
  if (text)   text.value   = hex;
}

function populateFromDefaults(defaults) {
  var m = defaults.mechanics;
  setVal('m_input_type',            m.input_type);
  setVal('m_card_move_speed',       m.card_move_speed);
  setVal('m_animation_type',        m.animation_type);
  setVal('m_highlight_valid_moves', m.highlight_valid_moves);
  setVal('m_auto_complete_enabled', m.auto_complete_enabled);

  var v = defaults.visual;
  setColor('v_background_color',   v.background_color);
  setColor('v_table_felt_color',   v.table_felt_color);
  setColor('v_card_face_color',    v.card_face_color);
  setColor('v_card_back_color',    v.card_back_color);
  setColor('v_card_border_color',  v.card_border_color);
  setColor('v_highlight_color',    v.highlight_color);
  setColor('v_button_color',       v.button_color);
  setColor('v_button_text_color',  v.button_text_color);
  setColor('v_primary_text_color', v.primary_text_color);
  setVal('v_ui_theme',          v.ui_theme);
  setVal('v_card_back_pattern', v.card_back_pattern);
  setVal('v_font_family',       v.font_family);

  var l = defaults.levels;
  setVal('l_target_url',   l.target_url);
  setVal('l_cta_text',     l.cta_text);
  setVal('l_testing_mode', l.testing_mode);

  document.getElementById('levels-list').innerHTML = '';
  levelCounter = 0;
  (l.levels || []).forEach(function(lvl) { addLevelCard(lvl); });
}

// ============================================================
// READ CONFIG FROM FORM
// ============================================================
function getColor(id) {
  var hexEl = document.getElementById(id + '_hex');
  if (hexEl && hexEl.value) return hexEl.value;
  var picker = document.getElementById(id);
  return picker ? picker.value : '#000000';
}

function buildConfig() {
  var mechanics = {
    mechanics_version:     '1.0',
    genre:                 'solitaire_simplified',
    input_type:            document.getElementById('m_input_type').value,
    card_move_speed:       document.getElementById('m_card_move_speed').value,
    animation_type:        document.getElementById('m_animation_type').value,
    highlight_valid_moves: document.getElementById('m_highlight_valid_moves').checked,
    auto_complete_enabled: document.getElementById('m_auto_complete_enabled').checked
  };

  var visual = {
    visual_version:      '1.0',
    background_color:    getColor('v_background_color'),
    table_felt_color:    getColor('v_table_felt_color'),
    card_face_color:     getColor('v_card_face_color'),
    card_back_color:     getColor('v_card_back_color'),
    card_back_pattern:   document.getElementById('v_card_back_pattern').value,
    card_border_color:   getColor('v_card_border_color'),
    highlight_color:     getColor('v_highlight_color'),
    button_color:        getColor('v_button_color'),
    button_text_color:   getColor('v_button_text_color'),
    primary_text_color:  getColor('v_primary_text_color'),
    font_family:         document.getElementById('v_font_family').value,
    ui_theme:            document.getElementById('v_ui_theme').value
  };

  var levelCards = document.querySelectorAll('#levels-list .level-card');
  var levelsArr  = [];

  levelCards.forEach(function(card, idx) {
    var id = card.dataset.levelId;
    function g(n) { return document.getElementById(id + '_' + n); }

    var tableau = [];
    try { tableau = JSON.parse(g('tableau').value); } catch(e) {}

    var drawPileRaw = g('draw_pile').value.trim();
    var draw_pile   = drawPileRaw
      ? drawPileRaw.split(',').map(function(s) { return s.trim(); }).filter(Boolean)
      : [];

    levelsArr.push({
      level_id:          idx + 1,
      game_type:         g('game_type').value,
      show_draw_pile:    g('show_draw_pile').checked,
      enter_animation:   g('enter_animation').value,
      enter_duration_ms: parseInt(g('enter_duration_ms').value) || 900,
      layout: {
        foundation_card: g('foundation_card').value.trim(),
        tableau:         tableau,
        draw_pile:       draw_pile,
        grid: {
          cell_width:  parseInt(g('cell_width').value)  || 82,
          cell_height: parseInt(g('cell_height').value) || 110,
          origin_x:    parseFloat(g('origin_x').value)  || 0.5,
          origin_y:    parseFloat(g('origin_y').value)  || 0.18
        }
      },
      timings: {
        win_screen_duration_ms:       parseInt(g('win_ms').value)   || 2000,
        fail_screen_duration_ms:      parseInt(g('fail_ms').value)  || 2000,
        level_transition_duration_ms: parseInt(g('trans_ms').value) || 1000
      }
    });
  });

  var levels = {
    levels_version: '1.0',
    genre:          'solitaire_simplified',
    testing_mode:   document.getElementById('l_testing_mode').checked,
    total_levels:   levelsArr.length,
    target_url:     document.getElementById('l_target_url').value.trim(),
    cta_text:       document.getElementById('l_cta_text').value.trim(),
    levels:         levelsArr
  };

  return { mechanics: mechanics, levels: levels, visual: visual };
}

// ============================================================
// GENERATE
// ============================================================
var lastPlayUrl = null;

// ============================================================
// PREVIEW PANEL
// ============================================================

function previewReload() {
  var iframe = document.getElementById('preview-iframe');
  if (iframe.src && iframe.src !== 'about:blank') {
    iframe.src = iframe.src; // reload
  }
}

function veCapturePreview() {
  var iframe = document.getElementById('preview-iframe');
  if (!iframe.src || iframe.src === 'about:blank') {
    alert('No preview loaded. Generate a build first.');
    return;
  }

  try {
    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    var canvas = iframeDoc.querySelector('canvas');
    if (!canvas) {
      alert('Could not find canvas in preview. Make sure the build is fully loaded.');
      return;
    }

    // For PixiJS WebGL, we need to wait for the next animation frame and use getImageData
    setTimeout(function() {
      try {
        // Try direct canvas capture first (works for 2D canvas)
        var dataUrl = canvas.toDataURL('image/png');

        // Check if it's a blank/black image (WebGL issue)
        if (dataUrl.length < 1000) {
          // Fallback: use html2canvas or manual screenshot
          alert('WebGL canvas capture failed. Please use browser screenshot (Win+Shift+S or Cmd+Shift+4) and drag/drop the image into the Visual Editor screenshot area.');

          // Switch to Visual Editor tab anyway so they can drag/drop
          document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
          document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
          document.querySelector('[data-tab="visual-editor"]').classList.add('active');
          document.getElementById('tab-visual-editor').classList.add('active');
          veShowForm();
          veSelectPath('A');
          return;
        }

        var screenshotB64 = dataUrl.split(',')[1];

        // Capture game state metadata from iframe
        try {
          var iframeWin = iframe.contentWindow;
          veCapturedMetadata = {
            level_number: iframeWin.currentLevel || 0,
            foundation_card: iframeWin.foundation || 'unknown',
            tableau_count: (iframeWin.tableau && iframeWin.tableau.length) || 0,
            draw_pile_count: (iframeWin.drawPile && iframeWin.drawPile.length) || 0,
            game_state: 'captured' // Could be enhanced with more state detection
          };
          console.log('Captured metadata:', veCapturedMetadata);
        } catch (metaErr) {
          console.warn('Could not capture game metadata:', metaErr);
          veCapturedMetadata = null;
        }

        // Switch to Visual Editor tab
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        document.querySelector('[data-tab="visual-editor"]').classList.add('active');
        document.getElementById('tab-visual-editor').classList.add('active');

        // Always open/reset form and select Level Design category (works for first and subsequent captures)
        veShowForm();
        veSelectCategory('level_design');

        // Add captured screenshot to gallery
        setTimeout(function() {
          veAddImageToGallery(dataUrl);
        }, 100);
      } catch (innerErr) {
        alert('Capture failed: ' + innerErr.message + '\n\nUse drag & drop instead: take a screenshot and drag it into the upload area.');
      }
    }, 100); // Small delay for WebGL to finish rendering
  } catch (err) {
    alert('Could not access preview: ' + err.message);
  }
}

// ============================================================
// GENERATE & DOWNLOAD
// ============================================================

function onGenerate() {
  // Check for critical conflicts before building
  var conflicts = {};
  vePendingChanges.forEach(function(req) {
    if (req.category === 'level_design' && req.level_number) {
      var key = req.level_number;
      conflicts[key] = (conflicts[key] || 0) + 1;
    }
  });

  var criticalConflicts = Object.keys(conflicts).filter(function(k) { return conflicts[k] > 1; });

  if (criticalConflicts.length > 0) {
    var msg = 'âš ï¸ Potential Conflicts Detected\n\n';
    msg += 'You have multiple requests targeting the same level(s):\n\n';
    criticalConflicts.forEach(function(lvl) {
      msg += 'â€¢ Level ' + lvl + ': ' + conflicts[lvl] + ' pending requests\n';
    });
    msg += '\nWhen both are applied, the second request may overwrite changes from the first.\n\n';
    msg += 'Recommendation: Review these requests and consider deleting duplicates before building.\n\n';
    msg += 'Do you want to continue building anyway?';

    if (!confirm(msg)) {
      return;  // User cancelled
    }
  }

  var btn     = document.getElementById('generate-btn');
  var errEl   = document.getElementById('error-msg');
  var resultEl = document.getElementById('result-area');

  btn.disabled        = true;
  btn.textContent     = 'Building...';
  errEl.textContent   = '';
  resultEl.classList.remove('visible');

  var config = buildConfig();

  // Determine which endpoint to use
  var endpoint = '/api/generate';
  var payload = config;

  // If there are pending requests, use smart build
  if (vePendingChanges.length > 0) {
    endpoint = '/api/build-with-requests';
    payload = {
      mechanics: config.mechanics,
      levels: config.levels,
      visual: config.visual,
      seed: config.seed,
      pending_requests: vePendingChanges.map(function(req) {
        return {
          category: req.category || 'legacy',
          level_number: req.level_number || null,
          reasoning: req.reasoning || req.note,
          complexity: req.complexity || 'n/a'
        };
      })
    };
    console.log('Using smart build with ' + vePendingChanges.length + ' pending request(s)');
  }

  fetch(endpoint, {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify(payload)
  })
  .then(function(res) {
    if (!res.ok) return res.json().then(function(e) { throw new Error(e.detail || 'Unknown error'); });
    return res.json();
  })
  .then(function(data) {
    lastPlayUrl = data.play_url;
    document.getElementById('preview-btn').href = lastPlayUrl;

    // Show result message with changes summary if available
    var resultMsg = 'Build ready! (' + data.run_id + ')';
    if (data.changes_summary) {
      resultMsg += '\n\nâœ¨ ' + data.changes_summary;
      if (data.skipped_requests && data.skipped_requests.length > 0) {
        resultMsg += '\n\nâš ï¸ Some requests could not be applied:\n' + data.skipped_requests.join('\n');
      }
    }
    document.getElementById('result-msg').textContent = resultMsg;
    resultEl.classList.add('visible');

    // Move pending requests to applied changes
    if (vePendingChanges.length > 0) {
      veAppliedChanges.unshift({
        run_id: data.run_id,
        run_name: data.run_id,
        changes: vePendingChanges.slice()  // Copy the array
      });
      vePendingChanges = [];  // Clear pending
      veRenderPending();
      veRenderApplied();
      console.log('Moved ' + veAppliedChanges[0].changes.length + ' requests to applied');
    }

    // Load into preview panel
    var iframe = document.getElementById('preview-iframe');
    var placeholder = document.getElementById('preview-placeholder');
    iframe.src = data.play_url;
    placeholder.style.display = 'none';

    // Move pending changes to applied (grouped by this build)
    veMovePendingToApplied(data.run_id, data.run_id);
  })
  .catch(function(err) {
    errEl.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Generate Ad';
  });
}

function onDownload() {
  if (!lastPlayUrl) return;
  fetch(lastPlayUrl)
    .then(function(r) { return r.blob(); })
    .then(function(blob) {
      var url = URL.createObjectURL(blob);
      var a   = document.createElement('a');
      a.href     = url;
      a.download = 'playable_ad.html';
      a.click();
      URL.revokeObjectURL(url);
    })
    .catch(function(err) {
      document.getElementById('error-msg').textContent = 'Download failed: ' + err.message;
    });
}

// ============================================================
// TABS
// ============================================================
document.querySelectorAll('.tab-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'visual-editor') {
      veRefreshAssetLibrary();
    }
  });
});

// ============================================================
// WIRE UP + INIT
// ============================================================
document.getElementById('generate-btn').addEventListener('click', onGenerate);
document.getElementById('download-btn').addEventListener('click', onDownload);
document.getElementById('add-level-btn').addEventListener('click', function() {
  addLevelCard(defaultLevel());
});

// ============================================================
// LOAD BAR â€” previous builds + reset to defaults
// ============================================================
var defaultsCache = null;

function loadDefaults() {
  return fetch('/api/defaults')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      defaultsCache = data;
      populateFromDefaults(data);
      document.getElementById('load-build-select').value = '';
    })
    .catch(function(err) {
      document.getElementById('error-msg').textContent = 'Could not load defaults: ' + err.message;
    });
}

function populateBuildList() {
  fetch('/api/runs')
    .then(function(r) { return r.json(); })
    .then(function(runs) {
      var sel = document.getElementById('load-build-select');
      runs.forEach(function(run) {
        if (!run.has_build) return;
        var opt = document.createElement('option');
        opt.value = run.run_id;
        var date = new Date(run.created_at).toLocaleString();
        opt.textContent = run.run_id + '  (' + date + ')';
        sel.appendChild(opt);
      });
    });
}

document.getElementById('load-build-select').addEventListener('change', function() {
  var runId = this.value;
  if (!runId) return;
  fetch('/api/runs/' + runId)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      populateFromDefaults(data);
    })
    .catch(function(err) {
      document.getElementById('error-msg').textContent = 'Could not load build: ' + err.message;
    });
});

document.getElementById('reset-defaults-btn').addEventListener('click', function() {
  if (defaultsCache) {
    populateFromDefaults(defaultsCache);
    document.getElementById('load-build-select').value = '';
  } else {
    loadDefaults();
  }
});

// ============================================================
// VISUAL EDITOR - State (must be declared before INIT)
// ============================================================
var veImageAssets     = {};  // { background: base64, card_back: base64, felt: base64 }
var vePendingChanges  = [];  // changes not yet built (can be deleted)
var veAppliedChanges  = [];  // grouped by build: [{run_id, run_name, changes: [...]}]

// ============================================================
// INIT
// ============================================================
buildColorFields();
loadDefaults();
populateBuildList();
veRenderPending();
veRenderApplied();
veLoadImagesFromDisk(); // Load persisted reference images

// ============================================================
// VISUAL EDITOR - Remaining State
// ============================================================
var veCurrentPath      = null;
var veCurrentCategory  = null;  // game_design, level_design, graphics_ui, animation, legacy
var veSelectedLevel    = null;  // for level_design category
var veScreenshotB64    = null;
var veCompositeB64     = null;  // screenshot + drawing merged â€” sent to Claude
var veCapturedMetadata = null;  // game state metadata from Capture button
var vePathAImages      = [];    // Array of {id, dataUrl, name} for image gallery
var veImageCounter     = 0;     // Global counter for image numbering
var veActiveImageId    = null;  // ID of the currently active image in gallery
var vePathAGalleryVisible = false; // Whether to show gallery for current request (reset each time)
var veChosenPrompt   = null;
var veChosenRefB64   = null;
var veEditAssetName  = null;  // Path C: which asset is being edited
var veEditResultB64  = null;  // Path C: last generated preview (not yet saved)
var veDrawTool       = 'pen';
var veDrawing        = false;
var veLastX          = 0;
var veLastY          = 0;

// â”€â”€ Show / hide form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veShowForm() {
  var form = document.getElementById('ve-form');
  // If form is open and has work in progress, confirm before discarding
  if (form.style.display !== 'none' && (veScreenshotB64 || veEditAssetName)) {
    if (!confirm('You have an unsaved change in progress.\nDiscard it and start a new one?')) {
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      return;
    }
  }
  veResetForm();
  form.style.display = 'block';
  form.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
function veHideForm() {
  document.getElementById('ve-form').style.display = 'none';
  veResetForm();
}
function veResetForm() {
  veCurrentPath      = null;
  veScreenshotB64    = null;
  veCompositeB64     = null;
  veCapturedMetadata = null;
  veChosenPrompt     = null;
  veChosenRefB64     = null;
  veEditAssetName    = null;
  veEditResultB64    = null;
  vePathAGalleryVisible = false; // Hide gallery for new request
  veRenderImageGallery(); // Re-render to show empty state
  document.getElementById('ve-drop-zone').innerHTML =
    '<p>Click to upload or drag &amp; drop a screenshot (PNG / JPG)</p>' +
    '<input type="file" id="ve-file-input" accept="image/*" style="display:none">';
  document.getElementById('ve-drop-zone').classList.remove('has-image');
  document.getElementById('ve-drop-zone').onclick = function() {
    document.getElementById('ve-file-input').click();
  };
  veRewireFileInput();
  document.getElementById('ve-canvas-area').style.display        = 'none';
  document.getElementById('ve-composite-wrap').style.display     = 'none';
  var saveBtn = document.getElementById('ve-save-drawing-btn');
  if (saveBtn) { saveBtn.textContent = 'ğŸ’¾ Save Drawing'; saveBtn.style.background = ''; saveBtn.style.borderColor = ''; saveBtn.style.color = ''; }
  var screenshotSection = document.getElementById('ve-screenshot-section');
  if (screenshotSection) screenshotSection.style.display = 'none';
  var pathAForm = document.getElementById('ve-path-a-form');
  if (pathAForm) pathAForm.style.display = 'none';
  var pathBForm = document.getElementById('ve-path-b-form');
  if (pathBForm) pathBForm.style.display = 'none';
  var pathCForm = document.getElementById('ve-path-c-form');
  if (pathCForm) pathCForm.style.display = 'none';

  // Reset Path A canvas area and improved prompt
  var aDropZone = document.getElementById('ve-a-drop-zone');
  var aCanvasArea = document.getElementById('ve-a-canvas-area');
  if (aDropZone) aDropZone.style.display = 'block';
  if (aCanvasArea) aCanvasArea.style.display = 'none';
  var aCompWrap = document.getElementById('ve-a-composite-wrap');
  if (aCompWrap) aCompWrap.style.display = 'none';
  var aSaveBtn = document.getElementById('ve-a-save-drawing-btn');
  if (aSaveBtn) {
    aSaveBtn.textContent = 'ğŸ’¾ Save';
    aSaveBtn.style.background = '';
    aSaveBtn.style.borderColor = '';
    aSaveBtn.style.color = '';
  }
  var aImprovedSection = document.getElementById('ve-a-improved-section');
  if (aImprovedSection) aImprovedSection.style.display = 'none';
  var aReasoningSection = document.getElementById('ve-a-reasoning-section');
  if (aReasoningSection) aReasoningSection.style.display = 'none';

  // Clear reasoning text content
  var aReasoningSimple = document.getElementById('ve-a-reasoning-simple');
  if (aReasoningSimple) aReasoningSimple.textContent = '';
  var aReasoningComplexity = document.getElementById('ve-a-reasoning-complexity');
  if (aReasoningComplexity) aReasoningComplexity.textContent = '';
  var aTechnicalDetails = document.getElementById('ve-a-technical-details');
  if (aTechnicalDetails) aTechnicalDetails.innerHTML = '';

  var aStatus = document.getElementById('ve-a-status');
  if (aStatus) {
    aStatus.textContent = '';
    aStatus.style.color = '';
  }
  veImprovedPromptA = null;
  window.vePathAApprovalData = null;

  // Note: We DON'T reset the image gallery â€” images persist across requests
  // Images are global references that survive form open/close and page refresh

  // Reset Path B sections (with safety checks)
  var bSuggestionsStep = document.getElementById('ve-b-suggestions-step');
  if (bSuggestionsStep) bSuggestionsStep.style.display = 'none';
  var bVariationsStep = document.getElementById('ve-b-variations-step');
  if (bVariationsStep) bVariationsStep.style.display = 'none';
  var bAssetsStep = document.getElementById('ve-b-assets-step');
  if (bAssetsStep) bAssetsStep.style.display = 'none';

  // Reset Path C sections (with safety checks)
  var cPromptSection = document.getElementById('ve-c-prompt-section');
  if (cPromptSection) cPromptSection.style.display = 'none';
  var cPreviewSection = document.getElementById('ve-c-preview-section');
  if (cPreviewSection) cPreviewSection.style.display = 'none';
  var cAssetPicker = document.getElementById('ve-c-asset-picker');
  if (cAssetPicker) cAssetPicker.innerHTML = '';

  // Reset textareas and status fields (with safety checks)
  var textNote = document.getElementById('ve-text-note');
  if (textNote) textNote.value = '';
  var roughPrompt = document.getElementById('ve-rough-prompt');
  if (roughPrompt) roughPrompt.value = '';

  var bEnhanceStatus = document.getElementById('ve-b-enhance-status');
  if (bEnhanceStatus) bEnhanceStatus.textContent = '';
  var bGenStatus = document.getElementById('ve-b-gen-status');
  if (bGenStatus) bGenStatus.textContent = '';
  var cGenStatus = document.getElementById('ve-c-gen-status');
  if (cGenStatus) cGenStatus.textContent = '';
  var cApproveStatus = document.getElementById('ve-c-approve-status');
  if (cApproveStatus) cApproveStatus.textContent = '';

  // Reset path button selection
  document.querySelectorAll('.ve-path-btn').forEach(function(b) { b.classList.remove('selected'); });
}

// â”€â”€ File input wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veRewireFileInput() {
  var inp = document.getElementById('ve-file-input');
  if (!inp) return;
  inp.addEventListener('change', function() {
    var file = inp.files && inp.files[0];
    if (file) veLoadImage(file);
  });
}
veRewireFileInput();

// Drag & drop on drop zone
// Drag & drop for screenshot upload
(function() {
  var dropZone = document.getElementById('ve-drop-zone');
  if (!dropZone) {
    console.error('ve-drop-zone not found!');
    return;
  }

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '#6366f1';
    console.log('dragover');
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.stopPropagation();
    this.style.borderColor = '';
    console.log('dragleave');
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '';
    console.log('drop', e.dataTransfer.files);
    var file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      veLoadImage(file);
    } else {
      console.warn('No valid image file in drop');
    }
  });

  console.log('Drag/drop listeners attached to ve-drop-zone');
})();

function veLoadImage(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    veScreenshotB64 = e.target.result.split(',')[1]; // strip data-URL prefix
    veSetupCanvases(e.target.result);
  };
  reader.readAsDataURL(file);
}

// â”€â”€ Canvas setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veCalcDisplaySize(w, h) {
  var maxH = 260;
  var maxW = (document.getElementById('ve-form').offsetWidth || 400) - 48;
  var scale = Math.min(1, maxH / h, maxW / w);
  return { dw: Math.round(w * scale), dh: Math.round(h * scale) };
}

function veSetupCanvases(dataUrl) {
  var bgCvs = document.getElementById('ve-bg-canvas');
  var drCvs = document.getElementById('ve-draw-canvas');
  var img   = new Image();
  img.onload = function() {
    var w = img.naturalWidth, h = img.naturalHeight;
    var d = veCalcDisplaySize(w, h);
    // Internal resolution = full (accurate drawing coords)
    bgCvs.width  = drCvs.width  = w;
    bgCvs.height = drCvs.height = h;
    // Display size = constrained thumbnail
    bgCvs.style.width  = drCvs.style.width  = d.dw + 'px';
    bgCvs.style.height = drCvs.style.height = d.dh + 'px';
    bgCvs.getContext('2d').drawImage(img, 0, 0);
    drCvs.getContext('2d').clearRect(0, 0, w, h);
    document.getElementById('ve-canvas-area').style.display = 'block';
    // Reveal the appropriate path form now that a screenshot is loaded
    if (veCurrentPath === 'A') document.getElementById('ve-path-a-form').style.display = 'block';
    if (veCurrentPath === 'B') document.getElementById('ve-path-b-form').style.display = 'block';
    veBindDrawEvents(drCvs);
  };
  img.src = dataUrl;
}

function veLoadRefIntoCanvas(dataUrlOrB64) {
  var src = dataUrlOrB64.startsWith('data:') ? dataUrlOrB64 : 'data:image/png;base64,' + dataUrlOrB64;
  var bgCvs = document.getElementById('ve-bg-canvas');
  var drCvs = document.getElementById('ve-draw-canvas');
  var img   = new Image();
  img.onload = function() {
    var w = img.naturalWidth, h = img.naturalHeight;
    var d = veCalcDisplaySize(w, h);
    bgCvs.width  = drCvs.width  = w;
    bgCvs.height = drCvs.height = h;
    bgCvs.style.width  = drCvs.style.width  = d.dw + 'px';
    bgCvs.style.height = drCvs.style.height = d.dh + 'px';
    bgCvs.getContext('2d').drawImage(img, 0, 0);
    drCvs.getContext('2d').clearRect(0, 0, w, h);
  };
  img.src = src;
}

// â”€â”€ Drawing tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veSaveDrawing() {
  // Detect which path is active and use appropriate canvas IDs
  var bgCvs, drCvs, compWrap, compImg, saveBtn;

  if (veCurrentPath === 'A') {
    bgCvs = document.getElementById('ve-a-bg-canvas');
    drCvs = document.getElementById('ve-a-draw-canvas');
    compWrap = document.getElementById('ve-a-composite-wrap');
    compImg = document.getElementById('ve-a-composite-img');
    saveBtn = document.getElementById('ve-a-save-drawing-btn');
  } else {
    // Path B uses old IDs
    bgCvs = document.getElementById('ve-bg-canvas');
    drCvs = document.getElementById('ve-draw-canvas');
    compWrap = document.getElementById('ve-composite-wrap');
    compImg = document.getElementById('ve-composite-img');
    saveBtn = document.getElementById('ve-save-drawing-btn');
  }

  if (!bgCvs || !drCvs) return;

  // Check drawing canvas has any marks
  var drData = drCvs.getContext('2d').getImageData(0, 0, drCvs.width, drCvs.height).data;
  var hasMarks = false;
  for (var i = 3; i < drData.length; i += 4) { if (drData[i] > 0) { hasMarks = true; break; } }
  if (!hasMarks) {
    alert('Draw something on the screenshot first, then save.');
    return;
  }

  // Composite: draw canvas on top of bg canvas â†’ one merged image
  var merged = document.createElement('canvas');
  merged.width = bgCvs.width;
  merged.height = bgCvs.height;
  var ctx = merged.getContext('2d');
  ctx.drawImage(bgCvs, 0, 0);
  ctx.drawImage(drCvs, 0, 0);

  var dataUrl = merged.toDataURL('image/png');
  veCompositeB64 = dataUrl.split(',')[1];

  // Show composite preview at same display size as bg canvas
  if (compWrap && compImg) {
    compImg.src = dataUrl;
    compImg.style.width = bgCvs.style.width;
    compImg.style.height = bgCvs.style.height;
    compWrap.style.display = 'block';
  }

  // Visual feedback on button
  if (saveBtn) {
    saveBtn.textContent = 'âœ“ Drawing Saved';
    saveBtn.style.background = '#22c55e';
    saveBtn.style.borderColor = '#22c55e';
    saveBtn.style.color = '#fff';
  }

  veLog('Drawing saved â€” composite ready to send to Claude');
}

function veSetTool(t) {
  veDrawTool = t;
  document.querySelectorAll('[id^="ve-tool-"]').forEach(function(b) { b.classList.remove('active'); });
  var btn = document.getElementById('ve-tool-' + t);
  if (btn) btn.classList.add('active');
}

function veClearDrawing() {
  var drCvs = document.getElementById('ve-draw-canvas');
  if (drCvs) drCvs.getContext('2d').clearRect(0, 0, drCvs.width, drCvs.height);
}

function veBindDrawEvents(cvs) {
  // Remove old listeners by cloning
  var originalId = cvs.id;
  var newCvs = cvs.cloneNode(false);
  cvs.parentNode.replaceChild(newCvs, cvs);
  newCvs.id = originalId; // Preserve original ID (ve-a-draw-canvas or ve-draw-canvas)
  newCvs.className = cvs.className;

  function pos(e) {
    var r = newCvs.getBoundingClientRect();
    var scaleX = newCvs.width  / r.width;
    var scaleY = newCvs.height / r.height;
    var clientX = e.touches ? e.touches[0].clientX : e.clientX;
    var clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: (clientX - r.left) * scaleX, y: (clientY - r.top) * scaleY };
  }

  function start(e) {
    e.preventDefault();
    veDrawing = true;
    var p = pos(e);
    veLastX = p.x; veLastY = p.y;
  }
  function move(e) {
    if (!veDrawing) return;
    e.preventDefault();
    var p   = pos(e);
    var ctx = newCvs.getContext('2d');
    // Determine which color/size inputs to use based on canvas ID
    var colorId = originalId === 've-a-draw-canvas' ? 've-a-draw-color' : 've-draw-color';
    var sizeId = originalId === 've-a-draw-canvas' ? 've-a-draw-size' : 've-draw-size';
    var col = document.getElementById(colorId).value;
    var sz  = parseInt(document.getElementById(sizeId).value) || 4;
    if (veDrawTool === 'erase') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = sz * 4;
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = col;
      ctx.lineWidth   = sz;
      ctx.lineCap     = 'round';
      ctx.lineJoin    = 'round';
    }
    ctx.beginPath();
    ctx.moveTo(veLastX, veLastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    veLastX = p.x; veLastY = p.y;
  }
  function end() {
    veDrawing = false;
    var ctx = newCvs.getContext('2d');
    ctx.globalCompositeOperation = 'source-over';
  }

  newCvs.addEventListener('mousedown',  start);
  newCvs.addEventListener('mousemove',  move);
  newCvs.addEventListener('mouseup',    end);
  newCvs.addEventListener('mouseleave', end);
  newCvs.addEventListener('touchstart', start, { passive: false });
  newCvs.addEventListener('touchmove',  move,  { passive: false });
  newCvs.addEventListener('touchend',   end);
}

function veGetAnnotations() {
  var drCvs = document.getElementById('ve-draw-canvas');
  if (!drCvs) return null;
  // Return null if canvas is blank
  var data = drCvs.getContext('2d').getImageData(0, 0, drCvs.width, drCvs.height).data;
  var hasPixels = false;
  for (var i = 3; i < data.length; i += 4) { if (data[i] > 0) { hasPixels = true; break; } }
  if (!hasPixels) return null;
  return drCvs.toDataURL('image/png').split(',')[1];
}

// â”€â”€ Category selection (multi-category Path A) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veSelectCategory(category) {
  veCurrentCategory = category;
  veCurrentPath = 'A';  // All categories use Path A flow

  // Highlight selected category button
  document.querySelectorAll('.ve-path-btn').forEach(function(b) { b.classList.remove('selected'); });
  document.getElementById('ve-btn-' + category.replace('_', '-')).classList.add('selected');

  // Show/hide level dropdown (only for level_design)
  var levelSection = document.getElementById('ve-step-level');
  if (category === 'level_design') {
    // Populate level dropdown with existing levels
    var select = document.getElementById('ve-level-select');
    var currentLevels = getLevelCount();  // Get from Levels tab
    select.innerHTML = '';
    for (var i = 1; i <= currentLevels; i++) {
      var opt = document.createElement('option');
      opt.value = i;
      opt.textContent = 'Level ' + i;
      select.appendChild(opt);
    }
    // Add "Add new level" option (user specifies number in text)
    var newOpt = document.createElement('option');
    newOpt.value = -1;
    newOpt.textContent = 'â• Add new level (specify number in description)';
    select.appendChild(newOpt);

    levelSection.style.display = 'block';
    veSelectedLevel = currentLevels > 0 ? 1 : null;  // Default to Level 1 if exists, else null
  } else {
    levelSection.style.display = 'none';
    veSelectedLevel = null;
  }

  // Show Path A form
  document.getElementById('ve-path-a-form').style.display = 'block';
  document.getElementById('ve-path-b-form').style.display = 'none';
  document.getElementById('ve-path-c-form').style.display = 'none';

  veWirePathAUpload();
}

// Helper: get current number of levels from Levels tab
function getLevelCount() {
  var container = document.getElementById('levels-container');
  if (!container) return 3;  // Default fallback
  // Count only .level-card elements (not other children)
  return container.querySelectorAll('.level-card').length;
}

// Update selected level when dropdown changes
function veUpdateSelectedLevel() {
  var select = document.getElementById('ve-level-select');
  var val = parseInt(select.value);
  if (val === -1) {
    // "Add new level" selected - user will specify number in text
    // Set to null so backend uses text detection
    veSelectedLevel = null;
  } else {
    veSelectedLevel = val;
  }
}

// â”€â”€ Path selection (legacy for Path C) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veSelectPath(path) {
  veCurrentPath = path;
  document.querySelectorAll('.ve-path-btn').forEach(function(b) { b.classList.remove('selected'); });
  document.getElementById('ve-btn-' + path).classList.add('selected');

  // Screenshot section: visible for B only (Path A has its own upload, C doesn't need it)
  document.getElementById('ve-screenshot-section').style.display = (path === 'B') ? 'block' : 'none';

  // Path forms: A and C show immediately, B shows after screenshot
  document.getElementById('ve-path-a-form').style.display = 'none';
  document.getElementById('ve-path-b-form').style.display = 'none';
  document.getElementById('ve-path-c-form').style.display = 'none';

  if (path === 'A') {
    document.getElementById('ve-path-a-form').style.display = 'block';
    veWirePathAUpload();
  } else if (path === 'C') {
    document.getElementById('ve-path-c-form').style.display = 'block';
    veCLoadAssets();
  } else if (path === 'B') {
    // Path B form shows after screenshot upload
    if (veScreenshotB64) {
      document.getElementById('ve-path-b-form').style.display = 'block';
    }
  }
}

// â”€â”€ PATH A â€” Upload handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veWirePathAUpload() {
  var inp = document.getElementById('ve-a-file-input');
  if (!inp) return;
  // Remove old listeners by cloning
  var newInp = inp.cloneNode(true);
  inp.parentNode.replaceChild(newInp, inp);

  newInp.addEventListener('change', function() {
    var file = newInp.files && newInp.files[0];
    if (file) veLoadPathAImage(file);
  });

  // Drag & drop on Path A drop zone
  var dropZone = document.getElementById('ve-a-drop-zone');
  if (!dropZone) return;

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '#6366f1';
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.stopPropagation();
    this.style.borderColor = '';
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '';
    var file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      veLoadPathAImage(file);
    }
  });
}

function veLoadPathAImage(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    veScreenshotB64 = e.target.result.split(',')[1];
    veSetupPathACanvases(e.target.result);
  };
  reader.readAsDataURL(file);
}

function veSetupPathACanvases(dataUrl) {
  var bgCvs = document.getElementById('ve-a-bg-canvas');
  var drCvs = document.getElementById('ve-a-draw-canvas');

  if (!bgCvs || !drCvs) {
    console.error('Path A canvases not found');
    return;
  }

  var img = new Image();
  img.onload = function() {
    var w = img.naturalWidth, h = img.naturalHeight;
    var maxH = 200;
    var scale = Math.min(1, maxH / h);
    var dw = Math.round(w * scale);
    var dh = Math.round(h * scale);

    bgCvs.width = drCvs.width = w;
    bgCvs.height = drCvs.height = h;
    bgCvs.style.width = drCvs.style.width = dw + 'px';
    bgCvs.style.height = drCvs.style.height = dh + 'px';
    bgCvs.getContext('2d').drawImage(img, 0, 0);
    drCvs.getContext('2d').clearRect(0, 0, w, h);

    // Hide drop zone, show canvas area
    document.getElementById('ve-a-drop-zone').style.display = 'none';
    document.getElementById('ve-a-canvas-area').style.display = 'block';

    // Hide composite wrap (from previous drawing)
    var compWrap = document.getElementById('ve-a-composite-wrap');
    if (compWrap) compWrap.style.display = 'none';

    // Reset save button
    var saveBtn = document.getElementById('ve-a-save-drawing-btn');
    if (saveBtn) {
      saveBtn.textContent = 'ğŸ’¾ Save';
      saveBtn.style.background = '';
      saveBtn.style.borderColor = '';
      saveBtn.style.color = '';
    }

    veBindDrawEvents(drCvs);
  };
  img.src = dataUrl;
}

// â”€â”€ PATH A â€” Improve prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var veImprovedPromptA = null;

function veImprovePathA() {
  var note = document.getElementById('ve-text-note').value.trim();
  var status = document.getElementById('ve-a-status');

  // Require at least text OR screenshot
  if (!note && !veScreenshotB64) {
    status.textContent = 'Enter a text description or upload a screenshot first.';
    status.style.color = '';
    return;
  }

  var improveBtn = document.getElementById('ve-a-improve-btn');
  var skipBtn = document.getElementById('ve-a-skip-btn');

  improveBtn.disabled = true;
  skipBtn.disabled = true;
  improveBtn.textContent = 'Thinking...';
  status.textContent = 'Asking Claude to improve your prompt...';
  status.style.color = '';

  // Prepare payload (text + optional screenshot)
  var screenshotToSend = null;
  if (veScreenshotB64) {
    screenshotToSend = veCompositeB64 || veScreenshotB64;
  }

  var payload = {
    text_prompt: note,
    screenshot: screenshotToSend,
    has_drawing: !!veCompositeB64,
    game_metadata: veCapturedMetadata
  };

  // TODO: Replace with real /api/visual/improve-prompt endpoint
  // For now, simulate with timeout
  setTimeout(function() {
    // Simulated improved prompt
    if (note) {
      veImprovedPromptA = note + " â€” optimized for clarity: ensure cards are clearly visible, maintain proper spacing, and verify layout is solvable";
    } else {
      veImprovedPromptA = "Based on the screenshot: adjust card positions to improve playability, ensure all cards are accessible, and optimize the layout for better visual flow";
    }

    document.getElementById('ve-a-improved-prompt').textContent = veImprovedPromptA;
    document.getElementById('ve-a-improved-section').style.display = 'block';

    status.textContent = 'âœ“ Prompt improved!';
    status.style.color = '#22c55e';
    improveBtn.disabled = false;
    skipBtn.disabled = false;
    improveBtn.textContent = 'âœ¨ Improve My Prompt';

    // Scroll to result
    document.getElementById('ve-a-improved-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 2000);
}

function veSkipImprovePathA() {
  var note = document.getElementById('ve-text-note').value.trim();
  var btn = document.getElementById('ve-a-skip-btn');

  // Show loading state
  btn.disabled = true;
  btn.textContent = 'Grooming...';

  // Skip improvement, use original prompt
  veImprovedPromptA = note;

  // Go straight to apply
  veApplyPathA();
}

// â”€â”€ PATH A â€” Apply layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Parse @ImageXX references from text and gather images to send
function veParseAndGatherImages(text) {
  var imagesToSend = [];
  var imageIds = new Set(); // Track IDs to avoid duplicates

  // Always include the active image if one exists
  if (veActiveImageId) {
    var activeImg = vePathAImages.find(function(img) { return img.id === veActiveImageId; });
    if (activeImg) {
      imagesToSend.push(activeImg.dataUrl);
      imageIds.add(veActiveImageId);
    }
  }

  // Parse @ImageXX references from text
  if (text) {
    // Match @Image01, @Image02, etc. (case-insensitive)
    var regex = /@Image(\d{2})/gi;
    var matches = text.matchAll(regex);

    for (var match of matches) {
      var imageNum = parseInt(match[1], 10);

      // Find the image with this number
      var img = vePathAImages.find(function(i) {
        // Extract number from "Image 01" -> 1
        var numStr = i.name.replace('Image ', '');
        return parseInt(numStr, 10) === imageNum;
      });

      // Add if found and not already included
      if (img && !imageIds.has(img.id)) {
        imagesToSend.push(img.dataUrl);
        imageIds.add(img.id);
      }
    }
  }

  return imagesToSend;
}

function veApplyPathA() {
  var btn = document.getElementById('ve-a-apply-btn');
  var status = document.getElementById('ve-a-status');
  var note = document.getElementById('ve-text-note').value.trim();

  // Use improved prompt if available, otherwise original
  var promptToUse = veImprovedPromptA || note;

  // Require at least text OR screenshot
  if (!promptToUse && !veScreenshotB64) {
    status.textContent = 'Enter a text description or upload a screenshot.';
    status.style.color = '';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Grooming...';
  status.textContent = '';

  // Determine what to send
  var screenshotToSend = null;
  var hasDrawing = false;

  if (veScreenshotB64) {
    screenshotToSend = veCompositeB64 || veScreenshotB64;
    hasDrawing = !!veCompositeB64;
  }

  // Parse @ImageXX references and gather images to send
  var referenceImages = veParseAndGatherImages(promptToUse);

  var payload = {
    screenshot: screenshotToSend,
    annotations: null,
    nanobanana_reference: null,
    reference_images: referenceImages.length > 0 ? referenceImages : null,
    has_drawing: hasDrawing,
    text_note: promptToUse || null,
    level_index: veSelectedLevel || null,
    game_metadata: veCapturedMetadata,
    category: veCurrentCategory || 'legacy'
  };

  fetch('/api/visual/layout', {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    // Apply layout to form fields (only for level_design and legacy categories)
    if (data.layout) {
      var levelCards = document.querySelectorAll('.level-card');
      if (levelCards.length > 0) {
        var card   = levelCards[0];
        var cardId = card.dataset.levelId;
        var layout = data.layout;
        var fc  = document.getElementById(cardId + '_foundation_card');
        var tab = document.getElementById(cardId + '_tableau');
        var dp  = document.getElementById(cardId + '_draw_pile');
        var cw  = document.getElementById(cardId + '_cell_width');
        var ch  = document.getElementById(cardId + '_cell_height');
        if (fc)  fc.value  = layout.foundation_card;
        if (tab) tab.value = JSON.stringify(layout.tableau, null, 2);
        if (dp)  dp.value  = (layout.draw_pile || []).join(', ');
        if (cw)  cw.value  = layout.grid.cell_width;
        if (ch)  ch.value  = layout.grid.cell_height;
        var badge = card.querySelector('.tableau-badge');
        if (badge) badge.textContent = (layout.tableau || []).length + ' cards';
        veLog('Path A applied to level card "' + cardId + '": foundation=' + layout.foundation_card + ', ' + (layout.tableau||[]).length + ' tableau cards');
      } else {
        veLog('Warning: no level cards found in form â€” switch to Levels tab and add a level first');
      }
    } else {
      // Non-layout category (Game Design, Graphics & UI, Animation) - no form fields to update
      veLog('Received reasoning for ' + (data.category || 'unknown') + ' category - no layout changes');
    }

    // Store data for approval
    window.vePathAApprovalData = {
      layout: data.layout,
      solve_sequence: data.solve_sequence,
      reasoning: data.reasoning || {},
      category: data.category || 'legacy',
      level_number: data.level_number || null
    };

    // Show reasoning section
    var reasoning = data.reasoning || {};
    var reasoningSimple = reasoning.simple || "I understand your request and will create a new layout based on your description.";
    var reasoningComplexity = reasoning.complexity || "moderate";
    var layout = data.layout;

    // 1. Simple explanation
    document.getElementById('ve-a-reasoning-simple').textContent = reasoningSimple;

    // 2. Complexity label with color coding
    var complexityEl = document.getElementById('ve-a-reasoning-complexity');
    var complexityText = '';
    var complexityColor = '';

    if (reasoningComplexity === 'easy') {
      complexityText = 'âš¡ Easy & Simple';
      complexityColor = 'background:#22c55e; color:#fff';
    } else if (reasoningComplexity === 'risky') {
      complexityText = 'ğŸ”´ Complicated & Risky';
      complexityColor = 'background:#ef4444; color:#fff';
    } else {
      complexityText = 'âš ï¸ Moderate';
      complexityColor = 'background:#f59e0b; color:#fff';
    }

    complexityEl.textContent = complexityText;
    complexityEl.style.cssText += complexityColor;

    // 3. Technical details (only for layout categories)
    var techHtml = '';
    if (layout) {
      techHtml += 'Foundation: ' + layout.foundation_card + '\n';
      techHtml += 'Tableau: ' + layout.tableau.length + ' cards in ' +
              (Math.max.apply(null, layout.tableau.map(function(c) { return c.col; })) + 1) + ' columns\n';
      if (layout.draw_pile && layout.draw_pile.length > 0) {
        techHtml += 'Draw pile: ' + layout.draw_pile.length + ' cards\n';
      }
      techHtml += 'Grid: ' + layout.grid.cell_width + 'x' + layout.grid.cell_height + ', origin (' + layout.grid.origin_x + ', ' + layout.grid.origin_y + ')\n';
      if (data.solve_sequence && data.solve_sequence.length > 0) {
        techHtml += '\nSolve sequence: ' + data.solve_sequence.join(' â†’ ');
      }
    } else {
      // Non-layout category - show category info instead
      var categoryName = data.category || 'unknown';
      var categoryLabels = {
        'game_design': 'ğŸ® Game Design (Global)',
        'graphics_ui': 'ğŸ¨ Graphics & UI (Global)',
        'animation': 'âœ¨ Animation & Polish (Global)',
        'edit_asset': 'âœï¸ Edit Asset',
        'legacy': 'ğŸ“ Legacy'
      };
      techHtml += 'Category: ' + (categoryLabels[categoryName] || categoryName) + '\n';
      techHtml += 'Scope: Affects entire game (no specific level)\n';
      techHtml += '\nNote: Changes will be applied when you build.';
    }

    document.getElementById('ve-a-reasoning-technical').textContent = techHtml;

    // Show reasoning section, hide improved prompt section
    document.getElementById('ve-a-improved-section').style.display = 'none';
    document.getElementById('ve-a-reasoning-section').style.display = 'block';

    if (layout) {
      status.textContent = 'âœ“ Layout analyzed! Review the reasoning below.';
    } else {
      status.textContent = 'âœ“ Request analyzed! Review the reasoning below.';
    }
    status.style.color = '#22c55e';

    // Scroll to reasoning
    document.getElementById('ve-a-reasoning-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = '';
  })
  .finally(function() {
    btn.disabled = false;
    btn.textContent = 'âœ¨ Groom it!';

    // Re-enable skip button if it was used
    var skipBtn = document.getElementById('ve-a-skip-btn');
    if (skipBtn) {
      skipBtn.disabled = false;
      skipBtn.textContent = 'Use As-Is â†’ Groom it';
    }
  });
}

// â”€â”€ PATH A â€” Approve and add to pending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veApprovePathA() {
  if (!window.vePathAApprovalData) {
    alert('No layout to approve. Please apply a change first.');
    return;
  }

  var data = window.vePathAApprovalData;
  var reasoning = data.reasoning || {};

  // Add to pending changes
  veAddPendingChange(
    'A',
    veScreenshotB64,
    veCompositeB64 || null,
    data.solve_sequence ? 'Solve: ' + data.solve_sequence.join(' â†’ ') : 'Layout updated',
    data.category || 'legacy',
    data.level_number || null,
    reasoning.simple || 'Layout updated',
    reasoning.complexity || 'n/a'
  );

  veLog('Path A approved and added to pending requests');

  // Show success message
  var status = document.getElementById('ve-a-status');
  status.textContent = 'âœ“ Added to Pending Requests!';
  status.style.color = '#22c55e';

  // Close form after brief delay
  setTimeout(function() {
    veHideForm();
  }, 1500);
}

// â”€â”€ PATH A â€” Image Gallery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veShowImageUpload() {
  document.getElementById('ve-a-file-input').click();
}

function veHandleImageUpload(input) {
  var file = input.files && input.files[0];
  if (file && file.type.startsWith('image/')) {
    var reader = new FileReader();
    reader.onload = function(e) {
      veAddImageToGallery(e.target.result);
    };
    reader.readAsDataURL(file);
  }
  // Reset input so same file can be uploaded again
  input.value = '';
}

function veAddImageToGallery(dataUrl, skipSave) {
  veImageCounter++;
  var imageNum = String(veImageCounter).padStart(2, '0');
  var imageName = 'Image ' + imageNum;

  vePathAImages.push({
    id: veImageCounter,
    dataUrl: dataUrl,
    name: imageName
  });

  // Newly added image becomes active
  veActiveImageId = veImageCounter;

  // Show the gallery (user has chosen to use images for this request)
  vePathAGalleryVisible = true;

  // Save to disk (unless we're loading from disk)
  if (!skipSave) {
    veSaveImageToDisk(dataUrl, veImageCounter);
  }

  veRenderImageGallery();
}

function veSaveImageToDisk(dataUrl, imageNumber) {
  fetch('/api/visual/save-image', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      image_data: dataUrl,
      image_number: imageNumber
    })
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    console.log('Image saved to disk:', data.filename);
  })
  .catch(function(err) {
    console.error('Failed to save image to disk:', err);
  });
}

function veLoadImagesFromDisk() {
  fetch('/api/visual/list-images')
    .then(function(res) { return res.json(); })
    .then(function(data) {
      var images = data.images || [];
      console.log('Loading ' + images.length + ' images from disk');

      if (images.length === 0) {
        veRenderImageGallery();
        return;
      }

      // Set counter to highest existing number
      var maxNumber = Math.max.apply(null, images.map(function(img) { return img.number; }));
      veImageCounter = maxNumber;

      // Load each image
      images.forEach(function(img) {
        // Fetch the image and convert to data URL
        fetch(img.url)
          .then(function(res) { return res.blob(); })
          .then(function(blob) {
            var reader = new FileReader();
            reader.onload = function(e) {
              var imageNum = String(img.number).padStart(2, '0');
              var imageName = 'Image ' + imageNum;

              vePathAImages.push({
                id: img.number,
                dataUrl: e.target.result,
                name: imageName
              });

              // Make the highest numbered image active
              if (img.number === maxNumber) {
                veActiveImageId = img.number;
              }

              veRenderImageGallery();
            };
            reader.readAsDataURL(blob);
          })
          .catch(function(err) {
            console.error('Failed to load image ' + img.filename + ':', err);
          });
      });
    })
    .catch(function(err) {
      console.error('Failed to load images from disk:', err);
      veRenderImageGallery(); // Render empty state
    });
}

function veSetActiveImage(imageId) {
  veActiveImageId = imageId;
  veRenderImageGallery();
}

function veRemoveImage(imageId) {
  vePathAImages = vePathAImages.filter(function(img) { return img.id !== imageId; });

  // If we removed the active image, set a new active
  if (veActiveImageId === imageId) {
    if (vePathAImages.length > 0) {
      // Make the last image active
      veActiveImageId = vePathAImages[vePathAImages.length - 1].id;
    } else {
      veActiveImageId = null;
    }
  }

  // Delete from disk
  fetch('/api/visual/delete-image', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ image_number: imageId })
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    console.log('Image deleted from disk:', data.deleted);
  })
  .catch(function(err) {
    console.error('Failed to delete image from disk:', err);
  });

  veRenderImageGallery();
}

function veShowLibrary() {
  // Show the gallery even if no images have been uploaded in this session
  if (vePathAImages.length > 0) {
    vePathAGalleryVisible = true;
    veRenderImageGallery();
  } else {
    alert('No images in library yet. Upload or capture an image first.');
  }
}

function veHideLibrary() {
  vePathAGalleryVisible = false;
  veRenderImageGallery();
}

function veClearAllImages() {
  if (!confirm('Are you sure you want to delete all reference images for this project?\n\nThis will permanently delete all images from disk.')) {
    return;
  }

  // Clear from disk
  fetch('/api/visual/clear-all-images', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
    console.log('Cleared all images:', data.deleted_count + ' files deleted');

    // Clear local state
    vePathAImages = [];
    veActiveImageId = null;
    veImageCounter = 0;

    veRenderImageGallery();
  })
  .catch(function(err) {
    console.error('Failed to clear images:', err);
    alert('Error clearing images. Check console for details.');
  });
}

// â”€â”€ IMAGE EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var veEditingImageId = null;

function veEditImage(imageId) {
  // Find the image
  var img = vePathAImages.find(function(i) { return i.id === imageId; });
  if (!img) return;

  veEditingImageId = imageId;

  // Show modal
  var modal = document.getElementById('ve-edit-modal');
  modal.style.display = 'block';

  // Update title
  document.getElementById('ve-edit-image-name').textContent = img.name;

  // Set up canvas
  var bgCanvas = document.getElementById('ve-edit-bg-canvas');
  var drawCanvas = document.getElementById('ve-edit-draw-canvas');

  var tempImg = new Image();
  tempImg.onload = function() {
    // Size canvases to match image
    var width = tempImg.width;
    var height = tempImg.height;

    bgCanvas.width = width;
    bgCanvas.height = height;
    drawCanvas.width = width;
    drawCanvas.height = height;

    // Draw background image
    var bgCtx = bgCanvas.getContext('2d');
    bgCtx.drawImage(tempImg, 0, 0);

    // Clear drawing canvas
    var drawCtx = drawCanvas.getContext('2d');
    drawCtx.clearRect(0, 0, width, height);

    // Bind drawing events
    veBindEditDrawEvents(drawCanvas);
  };
  tempImg.src = img.dataUrl;
}

function veBindEditDrawEvents(canvas) {
  var ctx = canvas.getContext('2d');
  var drawing = false;
  var lastX = 0;
  var lastY = 0;

  // Get color and size inputs
  var colorInput = document.getElementById('ve-edit-color');
  var sizeInput = document.getElementById('ve-edit-size');
  var sizeVal = document.getElementById('ve-edit-size-val');

  // Update size display
  sizeInput.oninput = function() {
    sizeVal.textContent = this.value;
  };

  function getMousePos(e) {
    var rect = canvas.getBoundingClientRect();
    return {
      x: (e.clientX - rect.left) * (canvas.width / rect.width),
      y: (e.clientY - rect.top) * (canvas.height / rect.height)
    };
  }

  canvas.onmousedown = function(e) {
    drawing = true;
    var pos = getMousePos(e);
    lastX = pos.x;
    lastY = pos.y;
  };

  canvas.onmousemove = function(e) {
    if (!drawing) return;
    var pos = getMousePos(e);

    ctx.strokeStyle = colorInput.value;
    ctx.lineWidth = parseInt(sizeInput.value);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();

    lastX = pos.x;
    lastY = pos.y;
  };

  canvas.onmouseup = function() {
    drawing = false;
  };

  canvas.onmouseleave = function() {
    drawing = false;
  };
}

function veClearEditCanvas() {
  var canvas = document.getElementById('ve-edit-draw-canvas');
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function veCancelEditImage() {
  document.getElementById('ve-edit-modal').style.display = 'none';
  veEditingImageId = null;
}

function veSaveEditedImage() {
  // Merge background and drawing
  var bgCanvas = document.getElementById('ve-edit-bg-canvas');
  var drawCanvas = document.getElementById('ve-edit-draw-canvas');

  var mergedCanvas = document.createElement('canvas');
  mergedCanvas.width = bgCanvas.width;
  mergedCanvas.height = bgCanvas.height;

  var ctx = mergedCanvas.getContext('2d');
  ctx.drawImage(bgCanvas, 0, 0);
  ctx.drawImage(drawCanvas, 0, 0);

  // Convert to data URL
  var dataUrl = mergedCanvas.toDataURL('image/png');

  // Add to gallery as new image
  veAddImageToGallery(dataUrl);

  // Close modal
  veCancelEditImage();

  console.log('Saved edited image as new numbered image');
}

// â”€â”€ IMAGE PREVIEW MODAL (Lightbox) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veOpenImagePreview(dataUrl) {
  var modal = document.getElementById('ve-preview-modal');
  var img = document.getElementById('ve-preview-image');
  img.src = dataUrl;
  modal.style.display = 'flex';
}

function veCloseImagePreview() {
  var modal = document.getElementById('ve-preview-modal');
  modal.style.display = 'none';
}

// â”€â”€ NANO BANANA MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var veNanoBananaImageId = null;

function veNanoBananaImage(imageId) {
  // Find the image
  var img = vePathAImages.find(function(i) { return i.id === imageId; });
  if (!img) return;

  veNanoBananaImageId = imageId;

  // Show modal
  var modal = document.getElementById('ve-nano-modal');
  modal.style.display = 'block';

  // Update title and preview
  document.getElementById('ve-nano-image-name').textContent = img.name;
  document.getElementById('ve-nano-preview').src = img.dataUrl;

  // Clear prompt and status
  document.getElementById('ve-nano-prompt').value = '';
  document.getElementById('ve-nano-status').textContent = '';
}

function veCancelNanoBanana() {
  document.getElementById('ve-nano-modal').style.display = 'none';
  veNanoBananaImageId = null;
}

// Nano Banana - Improve prompt
function veImproveNanoBanana() {
  var prompt = document.getElementById('ve-nano-prompt').value.trim();
  if (!prompt) {
    document.getElementById('ve-nano-status').textContent = 'Write a description first.';
    return;
  }

  // Find the source image
  var img = vePathAImages.find(function(i) { return i.id === veNanoBananaImageId; });
  if (!img) return;

  var improveBtn = document.getElementById('ve-nano-improve-btn');
  var useBtn = document.getElementById('ve-nano-use-btn');
  var status = document.getElementById('ve-nano-status');
  var promptField = document.getElementById('ve-nano-prompt');

  improveBtn.disabled = true;
  useBtn.disabled = true;
  status.textContent = 'âœ¨ Claude is improving your prompt...';
  status.style.color = 'var(--primary)';

  fetch('/api/nanobanana/enhance-prompt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      rough_prompt: prompt,
      screenshot: img.dataUrl
    })
  })
  .then(function(res) { return res.ok ? res.json() : res.json().then(function(e) { throw new Error(e.detail); }); })
  .then(function(data) {
    var suggestions = data.suggestions || [];
    if (suggestions.length > 0) {
      // Use the first suggestion
      promptField.value = suggestions[0];
      status.textContent = 'âœ“ Prompt improved! Click "Use This Prompt" to generate.';
      status.style.color = 'var(--success)';
    } else {
      throw new Error('No suggestions returned');
    }
  })
  .catch(function(err) {
    status.textContent = 'âŒ Error: ' + err.message;
    status.style.color = 'var(--danger)';
  })
  .finally(function() {
    improveBtn.disabled = false;
    useBtn.disabled = false;
  });
}

// Nano Banana - Use prompt and generate
function veUseNanoBananaPrompt() {
  veSubmitNanoBananaEdit();
}

function veSubmitNanoBananaEdit() {
  var prompt = document.getElementById('ve-nano-prompt').value.trim();
  if (!prompt) {
    alert('Please describe what you want to change');
    return;
  }

  // Find the source image BEFORE closing modal
  var img = vePathAImages.find(function(i) { return i.id === veNanoBananaImageId; });
  if (!img) return;

  // Store references before closing modal
  var sourceImageDataUrl = img.dataUrl;
  var promptText = prompt;

  // Close modal immediately
  veCancelNanoBanana();

  // Add loading placeholder to gallery (using encodeURIComponent instead of btoa for Unicode support)
  var loadingSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">' +
    '<rect width="400" height="300" fill="#1a1b26"/>' +
    '<text x="200" y="130" font-family="Arial" font-size="18" fill="#6366f1" text-anchor="middle">Generating...</text>' +
    '<text x="200" y="160" font-family="Arial" font-size="14" fill="#9ca3af" text-anchor="middle">AI is modifying your image</text>' +
    '<circle cx="200" cy="200" r="20" fill="none" stroke="#6366f1" stroke-width="3">' +
    '<animateTransform attributeName="transform" type="rotate" from="0 200 200" to="360 200 200" dur="1s" repeatCount="indefinite"/>' +
    '</circle>' +
    '</svg>';
  var loadingPlaceholder = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(loadingSvg);

  // Add placeholder and get its ID
  veImageCounter++;
  var placeholderId = veImageCounter;
  var imageNum = String(veImageCounter).padStart(2, '0');
  var imageName = 'Image ' + imageNum;

  vePathAImages.push({
    id: placeholderId,
    dataUrl: loadingPlaceholder,
    name: imageName
  });

  veActiveImageId = placeholderId;
  vePathAGalleryVisible = true;
  veRenderImageGallery();

  // Call Nano Banana API
  fetch('/api/nanobanana/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      prompt: promptText,
      reference_image: sourceImageDataUrl,
      num_variations: 1
    })
  })
  .then(function(res) {
    if (!res.ok) {
      return res.json().then(function(err) {
        throw new Error(err.detail || 'API error');
      });
    }
    return res.json();
  })
  .then(function(data) {
    // Replace placeholder with actual image
    var newImageData = data.images && data.images[0];
    if (newImageData) {
      // Convert raw base64 to data URL if needed
      if (!newImageData.startsWith('data:')) {
        newImageData = 'data:image/png;base64,' + newImageData;
      }

      // Find and replace the placeholder
      var placeholderIndex = vePathAImages.findIndex(function(i) { return i.id === placeholderId; });
      if (placeholderIndex !== -1) {
        vePathAImages[placeholderIndex].dataUrl = newImageData;
        veSaveImageToDisk(newImageData, placeholderId);
      }
      veRenderImageGallery();
    } else {
      throw new Error('No image data returned from API');
    }

    console.log('Nano Banana generated new image from prompt:', promptText);
  })
  .catch(function(err) {
    // Replace placeholder with error image
    var errorSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">' +
      '<rect width="400" height="300" fill="#1a1b26"/>' +
      '<text x="200" y="140" font-family="Arial" font-size="18" fill="#ef4444" text-anchor="middle">Error</text>' +
      '<text x="200" y="170" font-family="Arial" font-size="12" fill="#9ca3af" text-anchor="middle">' + err.message + '</text>' +
      '</svg>';
    var errorPlaceholder = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(errorSvg);

    var placeholderIndex = vePathAImages.findIndex(function(i) { return i.id === placeholderId; });
    if (placeholderIndex !== -1) {
      vePathAImages[placeholderIndex].dataUrl = errorPlaceholder;
    }
    veRenderImageGallery();
    console.error('Nano Banana error:', err);
  });
}

function veRenderImageGallery() {
  var gallery = document.getElementById('ve-a-gallery');
  var emptyState = document.getElementById('ve-a-gallery-empty');
  var pathCDisplay = document.getElementById('ve-c-gallery-display');

  // Render in Path A location
  if (gallery && emptyState) {
    gallery.innerHTML = '';

    // Toggle between empty state and gallery based on visibility flag
    if (!vePathAGalleryVisible || vePathAImages.length === 0) {
      emptyState.style.display = 'flex';
      gallery.style.display = 'none';
    } else {
      emptyState.style.display = 'none';
      gallery.style.display = 'flex';
    }
  }

  // Also render in Path C location if it exists
  if (pathCDisplay) {
    // Clear children without removing the element's attributes/handlers
    while (pathCDisplay.firstChild) {
      pathCDisplay.removeChild(pathCDisplay.firstChild);
    }

    if (!vePathAGalleryVisible || vePathAImages.length === 0) {
      // Show empty state in Path C
      pathCDisplay.style.display = 'flex';
      pathCDisplay.style.alignItems = 'center';
      pathCDisplay.style.justifyContent = 'center';
      pathCDisplay.style.border = '2px dashed var(--border)';
      pathCDisplay.style.borderRadius = 'var(--radius)';
      pathCDisplay.style.background = 'var(--surface)';
      pathCDisplay.style.cursor = 'pointer';

      var emptyContent = document.createElement('div');
      emptyContent.style.cssText = 'text-align:center; color:var(--muted); padding:20px';
      emptyContent.innerHTML = '<div style="font-size:40px; margin-bottom:10px">ğŸ“</div>' +
        '<div style="font-size:14px; font-weight:600; margin-bottom:6px">No reference images yet</div>' +
        '<div style="font-size:12px">Click "Upload Image" or "Show Library" to add images</div>';
      emptyContent.onclick = veShowImageUpload;
      pathCDisplay.appendChild(emptyContent);
      return;
    } else {
      // Show gallery in Path C
      pathCDisplay.style.display = 'flex';
      pathCDisplay.style.gap = '12px';
      pathCDisplay.style.overflowX = 'auto';
      pathCDisplay.style.padding = '10px 0';
      pathCDisplay.style.alignItems = 'flex-start';
      pathCDisplay.style.border = '2px dashed var(--border)';
      pathCDisplay.style.borderRadius = 'var(--radius)';
      pathCDisplay.style.background = 'transparent';
      pathCDisplay.style.cursor = 'default';

      // Render images into Path C gallery
      vePathAImages.forEach(function(img) {
        var card = veCreateImageCard(img);
        pathCDisplay.appendChild(card);
      });

      // Auto-scroll Path C gallery too
      setTimeout(function() {
        pathCDisplay.scrollLeft = pathCDisplay.scrollWidth;
      }, 0);
    }
  }

  // Render into Path A gallery if visible
  if (!gallery || !vePathAGalleryVisible || vePathAImages.length === 0) return;

  vePathAImages.forEach(function(img, index) {
    var card = veCreateImageCard(img);
    gallery.appendChild(card);
  });

  // Auto-scroll to the right (newest image)
  setTimeout(function() {
    gallery.scrollLeft = gallery.scrollWidth;
  }, 0);
}

// Create an image card (reusable for both Path A and Path C)
function veCreateImageCard(img) {
  var isActive = (img.id === veActiveImageId);

  var card = document.createElement('div');
    card.style.cssText = 'position:relative; flex-shrink:0; width:120px; padding:8px; border:2px solid ' +
      (isActive ? '#6366f1' : 'var(--border)') +
      '; border-radius:var(--radius); background:var(--surface)' +
      (isActive ? '; box-shadow:0 0 12px rgba(99,102,241,0.5)' : '') +
      '; cursor:pointer; transition:all 0.2s';

    // Click to make active
    card.onclick = function(e) {
      // Don't trigger if clicking remove button
      if (e.target.textContent === 'âœ•') return;
      veSetActiveImage(img.id);
    };

    // Image number
    var numLabel = document.createElement('div');
    numLabel.textContent = img.name;
    numLabel.style.cssText = 'font-size:11px; font-weight:600; margin-bottom:6px; color:' + (isActive ? '#6366f1' : 'var(--text)');
    card.appendChild(numLabel);

    // Image thumbnail
    var imgEl = document.createElement('img');
    imgEl.src = img.dataUrl;
    imgEl.style.cssText = 'width:100%; height:120px; object-fit:cover; border-radius:4px; display:block; pointer-events:auto; cursor:zoom-in';
    imgEl.ondblclick = function(e) {
      e.stopPropagation(); // Prevent card click
      veOpenImagePreview(img.dataUrl);
    };
    card.appendChild(imgEl);

    // Edit button (top-left)
    var editBtn = document.createElement('button');
    editBtn.textContent = 'âœï¸';
    editBtn.className = 've-tool-btn';
    editBtn.style.cssText = 'position:absolute; top:4px; left:4px; width:24px; height:24px; padding:0; font-size:14px; background:var(--bg); opacity:0.8';
    editBtn.title = 'Draw on this image';
    editBtn.onclick = function(e) {
      e.stopPropagation(); // Prevent card click
      veEditImage(img.id);
    };
    card.appendChild(editBtn);

    // Magic button (bottom-left, next to Edit)
    var magicBtn = document.createElement('button');
    magicBtn.textContent = 'âœ¨';
    magicBtn.className = 've-tool-btn';
    magicBtn.style.cssText = 'position:absolute; top:32px; left:4px; width:24px; height:24px; padding:0; font-size:14px; background:var(--bg); opacity:0.8';
    magicBtn.title = 'AI modify this image';
    magicBtn.onclick = function(e) {
      e.stopPropagation(); // Prevent card click
      veNanoBananaImage(img.id);
    };
    card.appendChild(magicBtn);

    // Remove button (top-right)
    var removeBtn = document.createElement('button');
    removeBtn.textContent = 'âœ•';
    removeBtn.className = 've-tool-btn';
    removeBtn.style.cssText = 'position:absolute; top:4px; right:4px; width:24px; height:24px; padding:0; font-size:14px; background:var(--bg); opacity:0.8';
    removeBtn.onclick = function(e) {
      e.stopPropagation(); // Prevent card click
      if (confirm('Remove ' + img.name + '?')) {
        veRemoveImage(img.id);
      }
    };
    card.appendChild(removeBtn);

    // Active indicator
    if (isActive) {
      var badge = document.createElement('div');
      badge.textContent = 'ACTIVE';
      badge.style.cssText = 'position:absolute; bottom:8px; left:8px; right:8px; background:#6366f1; color:#fff; font-size:9px; font-weight:700; text-align:center; padding:3px; border-radius:3px; pointer-events:none';
      card.appendChild(badge);
    }

    return card;
}

// Drag & Drop handlers for image gallery (works for both empty state and gallery)
function veGalleryDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  var target = event.currentTarget;
  if (target) {
    target.style.borderColor = '#6366f1';
    target.style.backgroundColor = 'rgba(99, 102, 241, 0.05)';
  }
}

function veGalleryDragLeave(event) {
  event.preventDefault();
  event.stopPropagation();
  var target = event.currentTarget;
  if (target) {
    target.style.borderColor = 'var(--border)';
    target.style.backgroundColor = target.id === 've-a-gallery-empty' ? 'var(--surface)' : 'transparent';
  }
}

function veGalleryDrop(event) {
  event.preventDefault();
  event.stopPropagation();

  var target = event.currentTarget;
  if (target) {
    target.style.borderColor = 'var(--border)';
    target.style.backgroundColor = target.id === 've-a-gallery-empty' ? 'var(--surface)' : 'transparent';
  }

  var files = event.dataTransfer && event.dataTransfer.files;
  if (!files || files.length === 0) return;

  // Process all dropped image files
  for (var i = 0; i < files.length; i++) {
    var file = files[i];
    if (file.type.startsWith('image/')) {
      (function(f) {
        var reader = new FileReader();
        reader.onload = function(e) {
          veAddImageToGallery(e.target.result);
        };
        reader.readAsDataURL(f);
      })(file);
    }
  }
}

// â”€â”€ PATH B â€” Prompt enhancement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veEnhancePrompt() {
  if (!veScreenshotB64) { document.getElementById('ve-b-enhance-status').textContent = 'Upload a screenshot first.'; return; }
  var rough = document.getElementById('ve-rough-prompt').value.trim();
  if (!rough) { document.getElementById('ve-b-enhance-status').textContent = 'Write a description first.'; return; }

  var btn    = document.getElementById('ve-enhance-btn');
  var status = document.getElementById('ve-b-enhance-status');
  btn.disabled    = true;
  btn.textContent = 'Asking Claude...';
  status.textContent = '';

  fetch('/api/nanobanana/enhance-prompt', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ rough_prompt: rough, screenshot: veScreenshotB64 })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    veShowSuggestions(data.suggestions);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'âœ¨ Suggest Better Prompts';
  });
}

function veSkipEnhance() {
  var rough = document.getElementById('ve-rough-prompt').value.trim();
  if (!rough) { document.getElementById('ve-b-enhance-status').textContent = 'Write a description first.'; return; }
  veChosenPrompt = rough;
  veShowSuggestions([rough]);
}

function veShowSuggestions(suggestions) {
  var list = document.getElementById('ve-suggestions-list');
  list.innerHTML = '';
  suggestions.forEach(function(s, i) {
    var btn = document.createElement('button');
    btn.className   = 've-suggestion';
    btn.textContent = s;
    btn.onclick     = function() {
      veChosenPrompt = s;
      document.querySelectorAll('.ve-suggestion').forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      document.getElementById('ve-gen-ref-btn').disabled = false;
    };
    list.appendChild(btn);
  });
  document.getElementById('ve-b-suggestions-step').style.display = 'block';
  document.getElementById('ve-gen-ref-btn').disabled = true;
}

function veBackToPrompt() {
  document.getElementById('ve-b-suggestions-step').style.display = 'none';
  veChosenPrompt = null;
}

// â”€â”€ PATH B â€” Generate reference â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veGenerateReference() {
  if (!veChosenPrompt) return;
  var btn    = document.getElementById('ve-gen-ref-btn');
  var status = document.getElementById('ve-b-gen-status');
  btn.disabled    = true;
  btn.textContent = 'Generating...';
  status.textContent = 'Sending to Nanobanana (Google Gemini)...';

  fetch('/api/nanobanana/generate', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt: veChosenPrompt, reference_image: veScreenshotB64, num_variations: 2 })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    status.textContent = '';
    veShowVariations(data.images || []);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Generate Reference Image';
  });
}

function veRegenerateReference() {
  veGenerateReference();
}

function veShowVariations(images) {
  var list = document.getElementById('ve-variations-list');
  list.innerHTML = '';
  images.forEach(function(b64, i) {
    var wrap = document.createElement('div');
    wrap.className = 've-variation';
    var img = document.createElement('img');
    img.src = 'data:image/png;base64,' + b64;
    wrap.appendChild(img);
    wrap.onclick = function() {
      document.querySelectorAll('.ve-variation').forEach(function(v) { v.classList.remove('selected'); });
      wrap.classList.add('selected');
      veChosenRefB64 = b64;
      document.getElementById('ve-ref-confirm-btn').disabled = false;
      // Load selected reference into canvas so user can annotate it
      veLoadRefIntoCanvas(b64);
    };
    list.appendChild(wrap);
  });
  document.getElementById('ve-b-variations-step').style.display = 'block';
  document.getElementById('ve-ref-confirm-btn').disabled = true;
}

function veConfirmReference() {
  if (!veChosenRefB64) return;
  document.getElementById('ve-b-assets-step').style.display = 'block';
  document.getElementById('ve-b-asset-status').textContent = '';
  veLoadAssetBrowser();
}

function veLoadAssetBrowser() {
  var browser = document.getElementById('ve-asset-browser');
  browser.innerHTML = '<span style="color:var(--muted);font-size:13px">Loading assets...</span>';
  fetch('/api/assets/list')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      browser.innerHTML = '';
      (data.assets || []).forEach(function(asset) {
        var card = document.createElement('div');
        card.className = 've-asset-card selected'; // default all selected
        card.dataset.assetName = asset.name;
        card.onclick = function() { card.classList.toggle('selected'); };

        var img = document.createElement('img');
        if (asset.preview) {
          img.src = 'data:image/png;base64,' + asset.preview;
        } else {
          img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
          img.style.background = '#333';
        }

        var nameEl = document.createElement('div');
        nameEl.className = 've-ac-name';
        nameEl.textContent = asset.name.replace('_', ' ');

        var descEl = document.createElement('div');
        descEl.className = 've-ac-desc';
        descEl.textContent = asset.description;

        card.appendChild(img);
        card.appendChild(nameEl);
        card.appendChild(descEl);
        browser.appendChild(card);
      });
    })
    .catch(function() {
      browser.innerHTML = '<span style="color:#f97583">Could not load assets. Is the server running?</span>';
    });
}

// â”€â”€ PATH B â€” Apply assets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veApplyPathB() {
  var btn    = document.getElementById('ve-b-apply-btn');
  var status = document.getElementById('ve-b-asset-status');
  if (!veChosenRefB64) { status.textContent = 'Select a reference image first.'; return; }

  var assetNames = [];
  document.querySelectorAll('.ve-asset-card.selected').forEach(function(card) {
    if (card.dataset.assetName) assetNames.push(card.dataset.assetName);
  });
  if (assetNames.length === 0) { status.textContent = 'Select at least one asset (click to toggle).'; return; }

  btn.disabled    = true;
  btn.textContent = 'Generating assets...';
  status.textContent = 'Sending to Nanobanana...';

  fetch('/api/assets/replace', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ asset_names: assetNames, reference_image: veChosenRefB64, annotations: veGetAnnotations() })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    // Assets saved to disk on server â€” clear in-memory overrides (build will read from files)
    assetNames.forEach(function(n) { delete veImageAssets[n]; });
    veUpdateAssetPreview();
    veAddPendingChange('B', veChosenRefB64, null, 'Saved to disk: ' + assetNames.join(', '));
    status.textContent = 'Assets saved to static/assets/project/. Next Build will include them.';
    setTimeout(function() { veHideForm(); }, 3000);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Generate & Apply Assets';
  });
}

// â”€â”€ PATH C â€” Direct Asset Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function veCLoadAssets() {
  var picker = document.getElementById('ve-c-asset-picker');
  picker.innerHTML = '<span style="color:var(--muted);font-size:13px">Loading assets...</span>';
  fetch('/api/assets/list')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      picker.innerHTML = '';
      (data.assets || []).forEach(function(asset) {
        var card = document.createElement('div');
        card.className = 've-asset-card';
        card.dataset.assetName = asset.name;
        card.style.cursor = 'pointer';
        card.onclick = function() { vePickEditAsset(asset.name, card); };

        var img = document.createElement('img');
        img.src = asset.preview ? 'data:image/png;base64,' + asset.preview
                                : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';

        var nameEl = document.createElement('div');
        nameEl.className = 've-ac-name';
        nameEl.textContent = asset.name.replace('_', ' ');

        var descEl = document.createElement('div');
        descEl.className = 've-ac-desc';
        descEl.textContent = asset.description;

        card.appendChild(img);
        card.appendChild(nameEl);
        card.appendChild(descEl);
        picker.appendChild(card);
      });
    })
    .catch(function() {
      picker.innerHTML = '<span style="color:#f97583">Could not load assets.</span>';
    });
}

function vePickEditAsset(name, cardEl) {
  veEditAssetName = name;
  // Visual selection â€” radio-like (only one at a time)
  document.querySelectorAll('#ve-c-asset-picker .ve-asset-card').forEach(function(c) {
    c.classList.remove('selected');
  });
  cardEl.classList.add('selected');
  // Reveal prompt section
  document.getElementById('ve-c-prompt-section').style.display = 'block';
  document.getElementById('ve-c-preview-section').style.display = 'none';
  document.getElementById('ve-c-gen-status').textContent = '';
  document.getElementById('ve-c-approve-status').textContent = '';
  document.getElementById('ve-c-prompt').focus();
}

// Path C - Improve prompt workflow
function veImprovePathC() {
  var prompt = document.getElementById('ve-c-prompt').value.trim();
  if (!prompt) {
    document.getElementById('ve-c-gen-status').textContent = 'Write a description first.';
    return;
  }

  if (!veEditAssetName) {
    document.getElementById('ve-c-gen-status').textContent = 'Select an asset first.';
    return;
  }

  var improveBtn = document.getElementById('ve-c-improve-btn');
  var useBtn = document.getElementById('ve-c-use-btn');
  var status = document.getElementById('ve-c-gen-status');
  var promptField = document.getElementById('ve-c-prompt');

  improveBtn.disabled = true;
  useBtn.disabled = true;
  status.textContent = 'âœ¨ Claude is improving your prompt...';
  status.style.color = 'var(--primary)';

  // Get the current asset image as screenshot
  fetch('/api/assets/list')
    .then(function(res) { return res.json(); })
    .then(function(data) {
      var assets = data.assets || [];
      var asset = assets.find(function(a) { return a.name === veEditAssetName; });
      if (!asset || !asset.preview) {
        throw new Error('Asset image not found');
      }

      var assetImageB64 = 'data:image/png;base64,' + asset.preview;

      // Call enhance-prompt
      return fetch('/api/nanobanana/enhance-prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          rough_prompt: prompt,
          screenshot: assetImageB64
        })
      });
    })
    .then(function(res) { return res.ok ? res.json() : res.json().then(function(e) { throw new Error(e.detail); }); })
    .then(function(data) {
      var suggestions = data.suggestions || [];
      if (suggestions.length > 0) {
        // Use the first suggestion
        promptField.value = suggestions[0];
        status.textContent = 'âœ“ Prompt improved! Click "Use This Prompt" to generate.';
        status.style.color = 'var(--success)';
      } else {
        throw new Error('No suggestions returned');
      }
    })
    .catch(function(err) {
      status.textContent = 'âŒ Error: ' + err.message;
      status.style.color = 'var(--danger)';
    })
    .finally(function() {
      improveBtn.disabled = false;
      useBtn.disabled = false;
    });
}

function veUsePathCPrompt() {
  veEditAsset();
}

function veEditAsset() {
  var btn    = document.getElementById('ve-c-improve-btn');
  var useBtn = document.getElementById('ve-c-use-btn');
  var status = document.getElementById('ve-c-gen-status');
  var prompt = document.getElementById('ve-c-prompt').value.trim();
  if (!veEditAssetName) { status.textContent = 'Select an asset first.'; return; }
  if (!prompt)          { status.textContent = 'Write a description of the change.'; return; }

  btn.disabled    = true;
  useBtn.disabled = true;
  btn.textContent = 'Generating...';
  useBtn.textContent = 'Generating...';
  status.textContent = 'Sending to Gemini...';
  status.style.color = '';
  document.getElementById('ve-c-preview-section').style.display = 'none';

  // Parse @ImageXX references and gather images to send (same as Path A)
  var referenceImages = veParseAndGatherImages(prompt);

  fetch('/api/assets/edit-preview', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      asset_name: veEditAssetName,
      prompt: prompt,
      reference_images: referenceImages.length > 0 ? referenceImages : null
    })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    veEditResultB64 = data.result_b64;
    status.textContent = '';

    // Load the current asset as "before"
    var beforeImg = document.getElementById('ve-c-before-img');
    var afterImg  = document.getElementById('ve-c-after-img');
    fetch('/api/assets/list')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var slot = (d.assets || []).find(function(a) { return a.name === veEditAssetName; });
        if (slot && slot.preview) {
          beforeImg.src = 'data:image/png;base64,' + slot.preview;
        }
      });
    afterImg.src = 'data:image/png;base64,' + veEditResultB64;

    document.getElementById('ve-c-preview-section').style.display = 'block';
    document.getElementById('ve-c-approve-status').textContent = '';
    veRefreshLogs();
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = 'var(--danger)';
  })
  .finally(function() {
    btn.disabled    = false;
    useBtn.disabled = false;
    btn.textContent = 'âœ¨ Improve My Prompt';
    useBtn.textContent = 'Use This Prompt';
  });
}

function veApproveEditAsset() {
  if (!veEditResultB64 || !veEditAssetName) return;
  var btn    = document.getElementById('ve-c-approve-btn');
  var status = document.getElementById('ve-c-approve-status');
  btn.disabled    = true;
  btn.textContent = 'Saving...';
  status.textContent = '';

  fetch('/api/assets/approve', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ asset_name: veEditAssetName, image_b64: veEditResultB64 })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function() {
    delete veImageAssets[veEditAssetName];
    veUpdateAssetPreview();
    veAddPendingChange('C', null, null, 'Saved: ' + veEditAssetName.replace('_', ' '), 'edit_asset');
    status.textContent = 'Saved to static/assets/project/. Next Build will include it.';
    status.style.color = '#22c55e';
    veRefreshLogs();
    setTimeout(function() { veHideForm(); }, 2500);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = '';
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Approve & Save';
  });
}

function veRetryEditAsset() {
  document.getElementById('ve-c-preview-section').style.display = 'none';
  document.getElementById('ve-c-approve-status').textContent = '';
  veEditResultB64 = null;
  veEditAsset();
}

// â”€â”€ Asset preview panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veUpdateAssetPreview() {
  var panel = document.getElementById('ve-asset-preview');
  var items = document.getElementById('ve-asset-preview-items');
  items.innerHTML = '';
  var names = Object.keys(veImageAssets);
  if (names.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';
  names.forEach(function(name) {
    var wrap = document.createElement('div');
    wrap.style.textAlign = 'center';
    var img = document.createElement('img');
    img.src = 'data:image/png;base64,' + veImageAssets[name];
    img.style.cssText = 'width:60px;height:80px;object-fit:cover;border-radius:4px;border:1px solid var(--border);display:block';
    var lbl = document.createElement('div');
    lbl.textContent = name;
    lbl.style.cssText = 'font-size:11px;color:var(--muted);margin-top:4px';
    wrap.appendChild(img); wrap.appendChild(lbl);
    items.appendChild(wrap);
  });
}

// â”€â”€ History log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Change queue management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function veAddPendingChange(type, thumbCleanB64, thumbMarkedB64, note, category, level_number, reasoning, complexity) {
  var change = {
    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    type: type,
    clean: thumbCleanB64,
    marked: thumbMarkedB64,
    note: note,
    timestamp: new Date().toLocaleString(),
    category: category || 'legacy',
    level_number: level_number || null,
    reasoning: reasoning || note,
    complexity: complexity || 'n/a'
  };
  vePendingChanges.push(change);
  veCheckConflicts();  // Check for level conflicts
  veRenderPending();
}

function veCheckConflicts() {
  // Count how many pending requests target each level
  var levelCounts = {};

  vePendingChanges.forEach(function(req) {
    if (req.category === 'level_design' && req.level_number) {
      var key = 'level_' + req.level_number;
      levelCounts[key] = (levelCounts[key] || 0) + 1;
    }
  });

  // Mark requests with conflicts
  vePendingChanges.forEach(function(req) {
    if (req.category === 'level_design' && req.level_number) {
      var key = 'level_' + req.level_number;
      req.has_conflict = levelCounts[key] > 1;
    } else {
      req.has_conflict = false;
    }
  });
}

function veDeletePendingChange(changeId) {
  if (!confirm('Delete this pending change?')) return;
  vePendingChanges = vePendingChanges.filter(function(c) { return c.id !== changeId; });
  veCheckConflicts();  // Recheck conflicts after deletion
  veRenderPending();
}

// Shared function to create a request card (used by both pending and applied)
function veCreateRequestCard(item, showDeleteBtn, showStatusBtns) {
  var li = document.createElement('li');
  li.style.cssText = 'flex-wrap:wrap;cursor:pointer;transition:background 0.2s';

  // Double-click to view details
  li.ondblclick = function() {
    veShowRequestDetails(item);
  };

  // Hover effect
  li.onmouseenter = function() {
    li.style.background = 'var(--surface)';
  };
  li.onmouseleave = function() {
    li.style.background = '';
  };

  // Thumbnails (if any)
  if (item.clean || item.marked) {
    var thumbRow = document.createElement('div');
    thumbRow.style.cssText = 'display:flex;gap:6px;align-items:flex-end;margin-right:8px';

    if (item.clean) {
      var wrap1 = document.createElement('div');
      wrap1.style.cssText = 'text-align:center';
      var lbl1 = document.createElement('div');
      lbl1.style.cssText = 'font-size:10px;color:var(--muted);margin-bottom:2px';
      lbl1.textContent = 'Original';
      var img1 = document.createElement('img');
      img1.src = 'data:image/png;base64,' + item.clean;
      img1.className = 've-thumb';
      wrap1.appendChild(lbl1);
      wrap1.appendChild(img1);
      thumbRow.appendChild(wrap1);
    }

    if (item.marked) {
      var wrap2 = document.createElement('div');
      wrap2.style.cssText = 'text-align:center';
      var lbl2 = document.createElement('div');
      lbl2.style.cssText = 'font-size:10px;color:#6366f1;font-weight:600;margin-bottom:2px';
      lbl2.textContent = 'âœ Analyzed';
      var img2 = document.createElement('img');
      img2.src = 'data:image/png;base64,' + item.marked;
      img2.className = 've-thumb';
      img2.style.border = '2px solid #6366f1';
      wrap2.appendChild(lbl2);
      wrap2.appendChild(img2);
      thumbRow.appendChild(wrap2);
    }

    li.appendChild(thumbRow);
  }

  // Category badge
  var badgeText = '';
  var badgeStyle = '';
  if (item.category === 'game_design') {
    badgeText = 'ğŸ® Game Design (Global)';
    badgeStyle = 'background:#6366f120;color:#6366f1;border:1px solid #6366f140';
  } else if (item.category === 'level_design') {
    badgeText = 'ğŸ¯ Level ' + (item.level_number || '?');
    badgeStyle = 'background:#0ea5e920;color:#0ea5e9;border:1px solid #0ea5e940';
  } else if (item.category === 'graphics_ui') {
    badgeText = 'ğŸ¨ Graphics & UI (Global)';
    badgeStyle = 'background:#a855f720;color:#a855f7;border:1px solid #a855f740';
  } else if (item.category === 'animation') {
    badgeText = 'âœ¨ Animation (Global)';
    badgeStyle = 'background:#f59e0b20;color:#f59e0b;border:1px solid #f59e0b40';
  } else if (item.category === 'edit_asset') {
    badgeText = 'âœï¸ Edit Asset';
    badgeStyle = 'background:#ec489920;color:#ec4899;border:1px solid #ec489940';
  } else {
    badgeText = 'ğŸ“ Legacy';
    badgeStyle = 'background:var(--muted)20;color:var(--muted);border:1px solid var(--muted)40';
  }

  var badge = document.createElement('span');
  badge.className = 've-badge';
  badge.textContent = badgeText;
  badge.style.cssText = badgeStyle + ';font-size:11px;padding:4px 8px';

  // Complexity badge (if applicable)
  var complexityBadge = null;
  if (item.complexity && item.complexity !== 'n/a') {
    complexityBadge = document.createElement('span');
    complexityBadge.className = 've-badge';
    complexityBadge.textContent = item.complexity;
    if (item.complexity === 'easy') {
      complexityBadge.style.cssText = 'background:#22c55e20;color:#22c55e;border:1px solid #22c55e40;font-size:11px;padding:4px 8px;margin-left:6px';
    } else if (item.complexity === 'risky') {
      complexityBadge.style.cssText = 'background:#f9758320;color:#f97583;border:1px solid #f9758340;font-size:11px;padding:4px 8px;margin-left:6px';
    } else {
      complexityBadge.style.cssText = 'background:#f59e0b20;color:#f59e0b;border:1px solid #f59e0b40;font-size:11px;padding:4px 8px;margin-left:6px';
    }
  }

  // Create content wrapper
  var contentWrap = document.createElement('div');
  contentWrap.style.cssText = 'flex:1;display:flex;flex-direction:column;gap:12px';

  // Badge row
  var badgeRow = document.createElement('div');
  badgeRow.style.display = 'flex';
  badgeRow.style.alignItems = 'center';
  badgeRow.appendChild(badge);
  if (complexityBadge) badgeRow.appendChild(complexityBadge);

  // Main description (first sentence or up to 200 chars)
  var reasoning = item.reasoning || item.note || '';
  var mainDesc = reasoning.split('.')[0] + '.'; // First sentence
  if (mainDesc.length > 200) mainDesc = reasoning.substring(0, 200) + '...';

  var mainDescDiv = document.createElement('div');
  mainDescDiv.style.cssText = 'font-size:14px;color:var(--text);line-height:1.6;font-weight:500';
  mainDescDiv.textContent = mainDesc;

  // Technical details (rest of reasoning, smaller and muted)
  var techDetails = reasoning.substring(mainDesc.length).trim();
  var techDetailsDiv = null;
  if (techDetails && techDetails.length > 3) {
    techDetailsDiv = document.createElement('div');
    techDetailsDiv.style.cssText = 'font-size:12px;color:var(--muted);line-height:1.5;margin-top:4px';
    techDetailsDiv.textContent = techDetails;
  }

  contentWrap.appendChild(badgeRow);
  contentWrap.appendChild(mainDescDiv);
  if (techDetailsDiv) contentWrap.appendChild(techDetailsDiv);

  // Add conflict warning if applicable
  if (item.has_conflict) {
    var warning = document.createElement('div');
    warning.style.cssText = 'font-size:12px;color:#f59e0b;background:#f59e0b10;padding:6px 10px;border-left:3px solid #f59e0b;border-radius:4px;margin-top:4px';
    warning.innerHTML = 'âš ï¸ <strong>Conflict:</strong> Another pending request also modifies Level ' + item.level_number + '. These requests may conflict when applied together.';
    contentWrap.appendChild(warning);
  }

  li.appendChild(contentWrap);

  // Status buttons (only for applied)
  if (showStatusBtns) {
    var btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display:flex;flex-direction:column;gap:6px;margin-left:12px';

    // Resolved button
    var resolvedBtn = document.createElement('button');
    resolvedBtn.className = 've-small-btn';
    resolvedBtn.textContent = 'âœ“ Resolved';
    resolvedBtn.dataset.status = 'resolved';
    var isResolved = item.status === 'resolved';
    resolvedBtn.style.cssText = 'font-size:12px;padding:6px 12px;white-space:nowrap;' +
      (isResolved ? 'background:#22c55e;border-color:#22c55e;color:#fff;font-weight:600' : 'background:var(--bg);border-color:var(--border);color:var(--text)');
    resolvedBtn.onclick = function(e) {
      e.stopPropagation();
      veSetRequestStatus(item, 'resolved');
    };

    // Not Resolved button
    var notResolvedBtn = document.createElement('button');
    notResolvedBtn.className = 've-small-btn';
    notResolvedBtn.textContent = 'âœ— Not Resolved';
    notResolvedBtn.dataset.status = 'not_resolved';
    var isNotResolved = item.status === 'not_resolved';
    notResolvedBtn.style.cssText = 'font-size:12px;padding:6px 12px;white-space:nowrap;' +
      (isNotResolved ? 'background:#f97583;border-color:#f97583;color:#fff;font-weight:600' : 'background:var(--bg);border-color:var(--border);color:var(--text)');
    notResolvedBtn.onclick = function(e) {
      e.stopPropagation();
      veSetRequestStatus(item, 'not_resolved');
    };

    // Duplicate & Edit button
    var duplicateBtn = document.createElement('button');
    duplicateBtn.className = 've-small-btn';
    duplicateBtn.textContent = 'ğŸ“‹ Duplicate & Edit';
    duplicateBtn.style.cssText = 'font-size:12px;padding:6px 12px;white-space:nowrap;background:#6366f1;border-color:#6366f1;color:#fff';
    duplicateBtn.onclick = function(e) {
      e.stopPropagation();
      veDuplicateRequest(item);
    };

    btnContainer.appendChild(resolvedBtn);
    btnContainer.appendChild(notResolvedBtn);
    btnContainer.appendChild(duplicateBtn);
    li.appendChild(btnContainer);
  }

  // Delete button (only for pending)
  if (showDeleteBtn) {
    var deleteBtn = document.createElement('button');
    deleteBtn.className = 've-small-btn';
    deleteBtn.textContent = 'âŒ';
    deleteBtn.style.cssText = 'font-size:14px;padding:6px 12px;background:#f9758320;border-color:#f97583;color:#f97583';
    deleteBtn.onclick = function(e) {
      e.stopPropagation(); // Don't trigger double-click
      veDeletePendingChange(item.id);
    };
    li.appendChild(deleteBtn);
  }

  return li;
}

// Set request status (resolved / not_resolved)
function veSetRequestStatus(item, status) {
  if (item.status === status) {
    // Clicking same status again clears it
    item.status = null;
  } else {
    item.status = status;
  }
  veRenderApplied();
}

// Duplicate a request and open form for editing
function veDuplicateRequest(item) {
  // Show visual feedback
  var allDuplicateBtns = document.querySelectorAll('button');
  var clickedBtn = null;
  allDuplicateBtns.forEach(function(btn) {
    if (btn.textContent.includes('Duplicate & Edit')) {
      btn.disabled = true;
      btn.textContent = 'Grooming...';
      clickedBtn = btn;
    }
  });

  // Short delay for visual feedback
  setTimeout(function() {
    // Show form
    veShowForm();

  // Select the category
  if (item.category) {
    veSelectCategory(item.category);
  }

  // If level_design, select the level
  if (item.category === 'level_design' && item.level_number) {
    setTimeout(function() {
      var levelSelect = document.getElementById('ve-level-select');
      if (levelSelect) {
        levelSelect.value = item.level_number;
        veUpdateSelectedLevel();
      }
    }, 100);
  }

  // Pre-fill screenshot if available
  if (item.clean) {
    veScreenshotB64 = item.clean;
    setTimeout(function() {
      veSetupPathACanvases('data:image/png;base64,' + item.clean);
    }, 200);
  }

  // Pre-fill text note
  setTimeout(function() {
    var textNote = document.getElementById('ve-text-note');
    if (textNote && item.reasoning) {
      textNote.value = item.reasoning;
    }
  }, 300);

  // Scroll to form
  setTimeout(function() {
    document.getElementById('ve-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 400);

  // Restore button state
  setTimeout(function() {
    if (clickedBtn) {
      clickedBtn.disabled = false;
      clickedBtn.textContent = 'ğŸ“‹ Duplicate & Edit';
    }
  }, 500);

  console.log('Duplicated request - form pre-filled with:', item.category, item.level_number);
  }, 300); // Close the initial setTimeout
}

// Show request details in popup
function veShowRequestDetails(item) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px';
  modal.onclick = function() { modal.remove(); };

  var popup = document.createElement('div');
  popup.style.cssText = 'background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:24px;max-width:700px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)';
  popup.onclick = function(e) { e.stopPropagation(); };

  // Category badge
  var categoryLabels = {
    'game_design': 'ğŸ® Game Design (Global)',
    'level_design': 'ğŸ¯ Level ' + (item.level_number || '?'),
    'graphics_ui': 'ğŸ¨ Graphics & UI (Global)',
    'animation': 'âœ¨ Animation (Global)',
    'edit_asset': 'âœï¸ Edit Asset',
    'legacy': 'ğŸ“ Legacy'
  };

  popup.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px">' +
    '<div><h2 style="margin:0;font-size:18px">' + (categoryLabels[item.category] || 'Request Details') + '</h2>' +
    (item.complexity && item.complexity !== 'n/a' ? '<div style="margin-top:8px;font-size:12px;color:var(--muted)">Complexity: <strong>' + item.complexity + '</strong></div>' : '') +
    '</div>' +
    '<button onclick="this.closest(\'.modal\').remove()" style="font-size:24px;background:none;border:none;color:var(--muted);cursor:pointer;line-height:1">Ã—</button>' +
    '</div>' +
    '<div style="margin-bottom:16px"><strong style="font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Full Description:</strong></div>' +
    '<div style="font-size:15px;line-height:1.8;color:var(--text);white-space:pre-wrap">' + (item.reasoning || item.note || 'No description available') + '</div>' +
    (item.timestamp ? '<div style="margin-top:20px;font-size:12px;color:var(--muted);border-top:1px solid var(--border);padding-top:12px">Created: ' + item.timestamp + '</div>' : '') +
    '<div style="margin-top:16px;text-align:center"><button onclick="this.closest(\'.modal\').remove()" class="ve-small-btn" style="padding:8px 20px">Close</button></div>';

  popup.className = 'modal';
  modal.appendChild(popup);
  document.body.appendChild(modal);
}

function veRenderPending() {
  var list = document.getElementById('ve-pending-list');
  var empty = document.getElementById('ve-pending-empty');
  list.innerHTML = '';
  if (vePendingChanges.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  vePendingChanges.forEach(function(item) {
    var card = veCreateRequestCard(item, true, false); // delete=true, status=false
    list.appendChild(card);
  });
}

function veRenderApplied() {
  var container = document.getElementById('ve-applied-list');
  var empty = document.getElementById('ve-applied-empty');
  container.innerHTML = '';
  if (veAppliedChanges.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  veAppliedChanges.forEach(function(build) {
    // Build header
    var buildHeader = document.createElement('div');
    buildHeader.style.cssText = 'font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;gap:8px';
    buildHeader.innerHTML = '<span>ğŸ“¦ ' + build.run_name + '</span><span style="font-size:10px;color:var(--muted);font-weight:400;margin-left:auto">' + build.changes.length + ' change(s)</span>';
    container.appendChild(buildHeader);

    // Changes in this build (use same card design as pending)
    var list = document.createElement('ul');
    list.className = 've-history';
    list.style.marginBottom = '16px';
    build.changes.forEach(function(item) {
      var card = veCreateRequestCard(item, false, true); // delete=false, status=true
      list.appendChild(card);
    });
    container.appendChild(list);
  });
}

function veMovePendingToApplied(run_id, run_name) {
  if (vePendingChanges.length === 0) return;
  veAppliedChanges.unshift({
    run_id: run_id,
    run_name: run_name,
    changes: vePendingChanges.slice() // copy array
  });
  vePendingChanges = [];
  veRenderPending();
  veRenderApplied();
}

// â”€â”€ Log viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veRefreshAssetLibrary() {
  var grid = document.getElementById('ve-library-grid');
  if (!grid) return;
  grid.innerHTML = '<span style="color:var(--muted);font-size:13px">Loading...</span>';
  fetch('/api/assets/list')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      grid.innerHTML = '';
      (data.assets || []).forEach(function(asset) {
        var card = document.createElement('div');
        card.style.cssText = 'border:1px solid var(--border);border-radius:var(--radius);padding:8px;text-align:center;width:110px;background:var(--bg)';

        var img = document.createElement('img');
        img.style.cssText = 'width:90px;height:120px;object-fit:cover;border-radius:3px;display:block;margin:0 auto 6px';
        img.src = asset.preview ? 'data:image/png;base64,' + asset.preview
                                : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQI12NgAAIABQAABjE+ibYAAAAASUVORK5CYII=';

        var nameEl = document.createElement('div');
        nameEl.style.cssText = 'font-size:12px;font-weight:600;color:var(--text)';
        nameEl.textContent = asset.name.replace('_', ' ');

        var stateEl = document.createElement('div');
        stateEl.style.cssText = 'font-size:11px;color:var(--muted);margin-top:2px';
        stateEl.textContent = asset.has_file ? 'custom' : 'placeholder';

        card.appendChild(img); card.appendChild(nameEl); card.appendChild(stateEl);
        grid.appendChild(card);
      });
    })
    .catch(function() {
      grid.innerHTML = '<span style="color:#f97583;font-size:13px">Could not load. Is the server running?</span>';
    });
}

function veRefreshLogs() {
  fetch('/api/logs?n=60')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var box = document.getElementById('ve-log-box');
      if (!box) return;
      if (!data.lines || data.lines.length === 0) {
        box.textContent = '(no log entries yet)';
        return;
      }
      // Color-code by level
      box.innerHTML = data.lines.map(function(line) {
        var color = '#e6edf3';
        if (line.includes('ERROR'))   color = '#f97583';
        if (line.includes('WARNING')) color = '#e3b341';
        if (line.includes('INFO'))    color = '#79c0ff';
        return '<span style="color:' + color + '">' + line.replace(/</g, '&lt;') + '</span>';
      }).join('\n');
      box.scrollTop = box.scrollHeight;
    })
    .catch(function() { /* server may not be running yet */ });
}

function veClearLogView() {
  var box = document.getElementById('ve-log-box');
  if (box) box.innerHTML = '<span style="color:#6e7681">View cleared. Click Refresh to reload.</span>';
}

function veLog(msg) {
  // Append to log box immediately (client-side echo), then refresh from server
  var box = document.getElementById('ve-log-box');
  if (box) {
    var now = new Date().toLocaleTimeString();
    box.innerHTML += '\n<span style="color:#3fb950">[client ' + now + '] ' + msg.replace(/</g, '&lt;') + '</span>';
    box.scrollTop = box.scrollHeight;
  }
  setTimeout(veRefreshLogs, 800); // pull server log shortly after
}

// â”€â”€ Patch buildConfig to include veImageAssets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _origBuildConfig = buildConfig;
buildConfig = function() {
  var cfg = _origBuildConfig();
  if (veImageAssets.background) cfg.visual.background_image = veImageAssets.background;
  if (veImageAssets.card_back)  cfg.visual.card_back_image  = veImageAssets.card_back;
  if (veImageAssets.felt)       cfg.visual.felt_image       = veImageAssets.felt;
  return cfg;
};
</script>

</body>
</html>
