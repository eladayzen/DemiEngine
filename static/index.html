<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Playable Ad Generator</title>
  <style>
    /* â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg:        #12121e;
      --surface:   #1c1c2e;
      --card:      #24243a;
      --border:    #35355a;
      --accent:    #ff5722;
      --accent2:   #ff7043;
      --text:      #e0e0f0;
      --muted:     #8888aa;
      --green:     #4caf50;
      --radius:    10px;
    }
    html, body { height: 100%; background: var(--bg); color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body { display: flex; flex-direction: column; }
    header { background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 14px 24px; display: flex; align-items: center; gap: 16px; flex-shrink: 0; }
    header h1 { font-size: 20px; color: var(--accent); font-weight: 700; letter-spacing: 0.5px; }
    header span { color: var(--muted); font-size: 13px; }

    .main { flex: 1; display: flex; overflow: hidden; }

    /* â”€â”€ Preview panel (left 1/3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .preview-panel { width: 33.333%; background: var(--surface);
      border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .preview-header { padding: 12px 16px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; }
    .preview-header h2 { font-size: 13px; color: var(--muted); text-transform: uppercase;
      letter-spacing: 1px; font-weight: 600; }
    .preview-iframe-wrap { flex: 1; position: relative; background: #000; }
    .preview-iframe-wrap iframe { width: 100%; height: 100%; border: none; }
    .preview-placeholder { position: absolute; inset: 0; display: flex; align-items: center;
      justify-content: center; flex-direction: column; gap: 10px; color: var(--muted);
      font-size: 13px; }

    /* â”€â”€ Workspace (right 2/3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs { display: flex; gap: 4px; padding: 12px 20px 0;
      background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { padding: 8px 22px; border: none; border-radius: var(--radius) var(--radius) 0 0;
      background: var(--card); color: var(--muted); cursor: pointer; font-size: 13px;
      font-weight: 600; transition: all 0.15s; border: 1px solid transparent;
      border-bottom: none; }
    .tab-btn:hover { color: var(--text); }
    .tab-btn.active { background: var(--bg); color: var(--text);
      border-color: var(--border); border-bottom-color: var(--bg); }

    /* â”€â”€ Tab content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-content { flex: 1; overflow-y: auto; padding: 20px; display: none; }
    .tab-content.active { display: block; }

    /* â”€â”€ Section card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-card { background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
    .section-card h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
      color: var(--muted); margin-bottom: 16px; }

    /* â”€â”€ Form grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 14px; }
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field label { font-size: 12px; color: var(--muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px; }
    .field input[type="text"],
    .field input[type="number"],
    .field select,
    .field textarea {
      background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); padding: 7px 10px; font-size: 13px; font-family: inherit;
      transition: border-color 0.15s; outline: none; }
    .field input[type="text"]:focus,
    .field input[type="number"]:focus,
    .field select:focus,
    .field textarea:focus { border-color: var(--accent); }
    .field textarea { resize: vertical; min-height: 80px; font-family: 'Consolas', monospace;
      font-size: 12px; line-height: 1.5; }
    .field select option { background: var(--card); }

    /* color picker row */
    .color-row { display: flex; align-items: center; gap: 8px; }
    .field input[type="color"] { width: 36px; height: 30px; border: 1px solid var(--border);
      border-radius: 6px; background: none; cursor: pointer; padding: 2px; }
    .color-hex { background: var(--surface); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); padding: 5px 8px; font-size: 12px;
      font-family: monospace; width: 80px; }

    /* range slider */
    .range-row { display: flex; align-items: center; gap: 8px; }
    .range-row input[type="range"] { flex: 1; accent-color: var(--accent); }
    .range-val { font-size: 12px; color: var(--muted); width: 32px; text-align: right; }

    /* toggle */
    .toggle-row { display: flex; align-items: center; gap: 10px; }
    .toggle { position: relative; width: 40px; height: 22px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: var(--border);
      border-radius: 22px; cursor: pointer; transition: 0.2s; }
    .toggle-slider::before { content: ''; position: absolute; left: 3px; top: 3px;
      width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.2s; }
    .toggle input:checked + .toggle-slider { background: var(--green); }
    .toggle input:checked + .toggle-slider::before { transform: translateX(18px); }
    .toggle-label { font-size: 13px; color: var(--text); }

    /* full-width field */
    .field.full { grid-column: 1 / -1; }

    /* â”€â”€ Level accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .level-card { background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); margin-bottom: 12px; overflow: hidden; }
    .level-header { display: flex; align-items: center; gap: 10px;
      padding: 12px 16px; cursor: pointer; user-select: none;
      border-bottom: 1px solid transparent; transition: border-color 0.15s; }
    .level-header.open { border-bottom-color: var(--border); }
    .level-header .chevron { font-size: 10px; color: var(--muted); transition: transform 0.2s; }
    .level-header.open .chevron { transform: rotate(90deg); }
    .level-title { font-weight: 700; font-size: 14px; flex: 1; }
    .level-badge { font-size: 11px; color: var(--muted); background: var(--card);
      padding: 2px 8px; border-radius: 20px; }
    .remove-btn { background: none; border: none; color: var(--muted); cursor: pointer;
      font-size: 16px; padding: 2px 6px; border-radius: 4px; transition: color 0.15s; }
    .remove-btn:hover { color: #ff4444; }
    .level-body { padding: 16px; display: none; }
    .level-body.open { display: block; }
    .level-subhead { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px;
      color: var(--muted); margin: 16px 0 8px; border-bottom: 1px solid var(--border);
      padding-bottom: 4px; }

    .add-level-btn { display: flex; align-items: center; gap: 8px; padding: 10px 16px;
      background: none; border: 1px dashed var(--border); border-radius: var(--radius);
      color: var(--muted); cursor: pointer; font-size: 13px; width: 100%;
      transition: all 0.15s; }
    .add-level-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Load bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .load-bar { display: flex; align-items: center; gap: 10px;
      padding: 8px 20px; background: var(--surface);
      border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .load-bar label { font-size: 11px; color: var(--muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
    .load-bar select { background: var(--card); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); padding: 5px 10px; font-size: 12px;
      outline: none; cursor: pointer; max-width: 280px; }
    .load-bar select:focus { border-color: var(--accent); }
    .load-bar-divider { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }
    .reset-btn { padding: 5px 14px; background: none; border: 1px solid var(--border);
      border-radius: 6px; color: var(--muted); font-size: 12px; cursor: pointer;
      transition: all 0.15s; }
    .reset-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Coming-soon block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .coming-soon-block { border: 1px dashed #44447a; border-radius: var(--radius);
      padding: 14px 16px; margin-top: 16px; opacity: 0.7; }
    .coming-soon-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .coming-soon-header span { font-size: 13px; font-weight: 700; color: var(--text); }
    .coming-soon-tag { font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.8px; padding: 2px 8px; border-radius: 20px;
      background: #2a2a4a; color: #8888cc; border: 1px solid #44447a; }
    .coming-soon-tag.m6 { background: #1e2e1e; color: #77bb77; border-color: #336633; }
    .coming-soon-tag.active { background: #1a2e1a; color: #66dd66; border-color: #44aa44; }

    /* Apply button row */
    .apply-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
    .apply-btn { padding: 6px 18px; background: #1a3a1a; border: 1px solid #336633;
      border-radius: 6px; color: #77cc77; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: all 0.15s; }
    .apply-btn:hover:not(:disabled) { background: #224422; border-color: #44aa44; color: #88ee88; }
    .apply-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .apply-status { font-size: 12px; color: var(--muted); font-style: italic; }
    .coming-soon-block textarea { width: 100%; background: var(--surface);
      border: 1px solid #44447a; border-radius: 6px; color: #9999bb;
      padding: 8px 10px; font-size: 12px; font-family: inherit; resize: vertical;
      min-height: 60px; outline: none; }
    .coming-soon-note { font-size: 11px; color: #666699; margin-top: 6px; font-style: italic; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer { background: var(--surface); border-top: 1px solid var(--border);
      padding: 14px 24px; display: flex; align-items: center; gap: 14px; flex-shrink: 0; }
    .generate-btn { padding: 11px 28px; background: var(--accent); color: #fff;
      border: none; border-radius: var(--radius); font-size: 15px; font-weight: 700;
      cursor: pointer; transition: background 0.15s; }
    .generate-btn:hover { background: var(--accent2); }
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .result-area { display: none; align-items: center; gap: 12px; flex: 1; }
    .result-area.visible { display: flex; }
    .result-msg { font-size: 13px; color: var(--green); font-weight: 600; }
    .result-btn { padding: 8px 18px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--card); color: var(--text); font-size: 13px; cursor: pointer;
      text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
      transition: border-color 0.15s; }
    .result-btn:hover { border-color: var(--accent); color: var(--accent); }

    .error-msg { color: #ff4444; font-size: 13px; }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<header>
  <h1>Playable Ad Generator</h1>
  <span>Configure â†’ Generate â†’ Preview</span>
</header>

<div class="main">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- PREVIEW PANEL (left 1/3)                           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="preview-panel">
    <div class="preview-header">
      <h2>Live Preview</h2>
      <div style="display:flex; gap:6px">
        <button class="ve-small-btn primary" onclick="veCapturePreview()" style="font-size:11px; padding:4px 10px">ğŸ“¸ Capture</button>
        <button class="ve-small-btn" onclick="previewReload()" style="font-size:11px; padding:4px 10px">â†» Reload</button>
      </div>
    </div>
    <div class="preview-iframe-wrap">
      <iframe id="preview-iframe" src="about:blank"></iframe>
      <div class="preview-placeholder" id="preview-placeholder">
        <div style="font-size:40px; opacity:0.3">ğŸ®</div>
        <div>No build loaded</div>
        <div style="font-size:11px; margin-top:8px">Click "Generate Ad" to preview</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- WORKSPACE (right 2/3) â€” tabs + content            -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="workspace">

    <!-- â”€â”€ TABS â”€â”€ -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="mechanics">Mechanics</button>
      <button class="tab-btn"        data-tab="visual">Visual</button>
      <button class="tab-btn"        data-tab="levels">Levels</button>
      <button class="tab-btn"        data-tab="visual-editor">ğŸ–¼ Visual Editor</button>
    </div>

    <!-- â”€â”€ LOAD BAR â”€â”€ -->
    <div class="load-bar">
      <label>Load build</label>
      <select id="load-build-select">
        <option value="">-- select a previous build --</option>
      </select>
      <div class="load-bar-divider"></div>
      <button class="reset-btn" id="reset-defaults-btn">Reset to Defaults</button>
    </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: MECHANICS                                     -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content active" id="tab-mechanics">
    <div class="section-card">
      <h2>Gameplay Settings</h2>
      <div class="form-grid">

        <div class="field">
          <label>Input Type</label>
          <select id="m_input_type">
            <option value="tap">Tap</option>
            <option value="drag">Drag</option>
            <option value="both">Both</option>
          </select>
        </div>

        <div class="field">
          <label>Card Move Speed</label>
          <select id="m_card_move_speed">
            <option value="slow">Slow</option>
            <option value="medium">Medium</option>
            <option value="fast">Fast</option>
          </select>
        </div>

        <div class="field">
          <label>Animation Type</label>
          <select id="m_animation_type">
            <option value="flip">Flip</option>
            <option value="slide">Slide</option>
            <option value="instant">Instant</option>
          </select>
        </div>

        <div class="field">
          <label>Highlight Valid Moves</label>
          <div class="toggle-row" style="margin-top:4px">
            <label class="toggle">
              <input type="checkbox" id="m_highlight_valid_moves" />
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Show glow on playable cards</span>
          </div>
        </div>

        <div class="field">
          <label>Auto Complete</label>
          <div class="toggle-row" style="margin-top:4px">
            <label class="toggle">
              <input type="checkbox" id="m_auto_complete_enabled" />
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Auto-complete when possible</span>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: VISUAL                                        -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-visual">
    <div class="section-card">
      <h2>Colors</h2>
      <div class="form-grid" id="color-fields">
        <!-- injected by JS -->
      </div>
    </div>
    <div class="section-card">
      <h2>Style</h2>
      <div class="form-grid">

        <div class="field">
          <label>UI Theme</label>
          <select id="v_ui_theme">
            <option value="dark">Dark</option>
            <option value="classic">Classic</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>

        <div class="field">
          <label>Card Back Pattern</label>
          <select id="v_card_back_pattern">
            <option value="solid">Solid</option>
            <option value="stripes">Stripes</option>
            <option value="dots">Dots</option>
          </select>
        </div>

        <div class="field">
          <label>Font Family</label>
          <input type="text" id="v_font_family" placeholder="Arial, sans-serif" />
        </div>

      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TAB: LEVELS                                        -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-content" id="tab-levels">

    <div class="section-card">
      <h2>Global Level Settings</h2>
      <div class="form-grid">

        <div class="field">
          <label>Target URL</label>
          <input type="text" id="l_target_url" placeholder="https://example.com" />
        </div>

        <div class="field">
          <label>CTA Button Text</label>
          <input type="text" id="l_cta_text" placeholder="Play Now!" />
        </div>

        <div class="field">
          <label>Testing Mode (HUD overlay)</label>
          <div class="toggle-row" style="margin-top:4px">
            <label class="toggle">
              <input type="checkbox" id="l_testing_mode" />
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Show debug HUD</span>
          </div>
        </div>

      </div>
    </div>

    <div id="levels-list">
      <!-- level cards injected by JS -->
    </div>

    <button class="add-level-btn" id="add-level-btn">
      <span>+</span> Add Level
    </button>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- VISUAL EDITOR TAB                                -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <style>
    .ve-section    { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:16px; }
    .ve-path-btns  { display:flex; gap:12px; margin-top:12px; }
    .ve-path-btn   { flex:1; padding:14px 10px; border:2px solid var(--border); background:var(--bg); color:var(--text);
                     border-radius:var(--radius); cursor:pointer; font-size:14px; text-align:center; transition:.15s; }
    .ve-path-btn:hover, .ve-path-btn.selected { border-color:#6366f1; background:#6366f110; }
    .ve-drop-zone  { border:2px dashed var(--border); border-radius:var(--radius); padding:24px; text-align:center;
                     cursor:pointer; color:var(--muted); transition:.15s; position:relative; }
    .ve-drop-zone:hover { border-color:#6366f1; color:var(--text); }
    .ve-drop-zone.has-image { padding:0; overflow:hidden; cursor:default; }
    .ve-canvas-wrap { position:relative; display:inline-block; }
    .ve-canvas-wrap canvas { display:block; }
    .ve-canvas-wrap .ve-draw-canvas { position:absolute; top:0; left:0; cursor:crosshair; }
    .ve-tools      { display:flex; gap:8px; align-items:center; padding:8px 0; flex-wrap:wrap; }
    .ve-tool-btn   { padding:5px 12px; font-size:12px; border:1px solid var(--border); background:var(--bg);
                     color:var(--text); border-radius:var(--radius); cursor:pointer; }
    .ve-tool-btn.active { border-color:#6366f1; background:#6366f120; }
    .ve-tool-btn:hover  { border-color:var(--text); }
    .ve-label      { font-size:12px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px; }
    .ve-suggestion { display:block; width:100%; text-align:left; padding:10px 12px; margin-bottom:6px;
                     background:var(--bg); border:1px solid var(--border); border-radius:var(--radius);
                     color:var(--text); font-size:13px; cursor:pointer; transition:.15s; }
    .ve-suggestion:hover, .ve-suggestion.selected { border-color:#6366f1; background:#6366f110; }
    .ve-variations { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .ve-variation  { position:relative; cursor:pointer; border:3px solid transparent; border-radius:var(--radius); overflow:hidden; }
    .ve-variation:hover, .ve-variation.selected { border-color:#6366f1; }
    .ve-variation img { display:block; width:120px; height:160px; object-fit:cover; }
    .ve-asset-checks { display:flex; gap:16px; margin:10px 0; }
    .ve-asset-checks label { display:flex; align-items:center; gap:6px; cursor:pointer; font-size:14px; }
    .ve-asset-card  { border:2px solid var(--border); border-radius:var(--radius); padding:8px; cursor:pointer;
                      background:var(--bg); transition:.15s; text-align:center; width:110px; }
    .ve-asset-card:hover  { border-color:#6366f1; }
    .ve-asset-card.selected { border-color:#6366f1; background:#6366f110; }
    .ve-asset-card img  { width:90px; height:120px; object-fit:cover; border-radius:3px; display:block; margin:0 auto 6px; }
    .ve-asset-card .ve-ac-name { font-size:12px; font-weight:600; color:var(--text); }
    .ve-asset-card .ve-ac-desc { font-size:11px; color:var(--muted); margin-top:2px; }
    .ve-history    { list-style:none; padding:0; margin:0; }
    .ve-history li { display:flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--border);
                     border-radius:var(--radius); margin-bottom:6px; background:var(--bg); font-size:13px; }
    .ve-badge      { font-size:11px; font-weight:700; padding:2px 7px; border-radius:999px; }
    .ve-badge.A    { background:#0ea5e920; color:#0ea5e9; border:1px solid #0ea5e940; }
    .ve-badge.B    { background:#a855f720; color:#a855f7; border:1px solid #a855f740; }
    .ve-badge.ok   { background:#22c55e20; color:#22c55e; border:1px solid #22c55e40; }
    .ve-status     { font-size:12px; color:var(--muted); }
    .ve-thumb      { width:32px; height:42px; object-fit:cover; border-radius:3px; border:1px solid var(--border); flex-shrink:0; }
    .ve-apply-btn  { width:100%; padding:13px; background:#6366f1; color:#fff; border:none; border-radius:var(--radius);
                     font-size:15px; font-weight:600; cursor:pointer; margin-top:8px; transition:.15s; }
    .ve-apply-btn:hover { background:#4f46e5; }
    .ve-apply-btn:disabled { background:var(--card); color:var(--muted); cursor:default; }
    .ve-small-btn  { padding:6px 14px; font-size:13px; border:1px solid var(--border); background:var(--bg);
                     color:var(--text); border-radius:var(--radius); cursor:pointer; transition:.15s; }
    .ve-small-btn:hover  { border-color:#6366f1; }
    .ve-small-btn.primary { background:#6366f1; border-color:#6366f1; color:#fff; }
    .ve-small-btn.primary:hover { background:#4f46e5; }
    .ve-small-btn:disabled { opacity:.5; cursor:default; }
    .ve-note       { font-size:12px; color:var(--muted); margin-top:4px; }
    .ve-step-header { font-size:14px; font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .ve-step-num   { width:22px; height:22px; border-radius:50%; background:#6366f1; color:#fff;
                     font-size:11px; font-weight:700; display:inline-flex; align-items:center; justify-content:center; flex-shrink:0; }
    .ve-divider    { border:none; border-top:1px solid var(--border); margin:16px 0; }
  </style>

  <div class="tab-content" id="tab-visual-editor">

    <!-- â”€â”€ Asset Library â”€â”€ -->
    <div class="ve-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h2 style="margin:0">Project Assets</h2>
        <button class="ve-small-btn" onclick="veRefreshAssetLibrary()">â†» Refresh</button>
      </div>
      <p class="ve-note" style="margin-bottom:10px">Current files in <code>static/assets/project/</code> â€” these are embedded in every Build.</p>
      <div id="ve-library-grid" style="display:flex; gap:14px; flex-wrap:wrap"></div>
    </div>

    <!-- â”€â”€ Pending Changes (to be built) â”€â”€ -->
    <div class="ve-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <h2 style="margin:0">ğŸ“‹ Pending Requests</h2>
        <button class="ve-small-btn primary" onclick="veShowForm()">+ New Request</button>
      </div>
      <ul class="ve-history" id="ve-pending-list"></ul>
      <p class="ve-note" id="ve-pending-empty">No pending requests. Click "+ New Request" to start.</p>
    </div>

    <!-- â”€â”€ Applied Changes (grouped by build) â”€â”€ -->
    <div class="ve-section">
      <h2 style="margin-bottom:12px">âœ“ Applied Changes</h2>
      <div id="ve-applied-list"></div>
      <p class="ve-note" id="ve-applied-empty">No builds yet. Pending changes will move here after a successful build.</p>
    </div>

    <!-- â”€â”€ New Request Form â”€â”€ -->
    <div class="ve-section" id="ve-form" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px">
        <h2 style="margin:0">New Request</h2>
        <button class="ve-tool-btn" onclick="veHideForm()">âœ• Cancel</button>
      </div>

      <!-- Step 1 â€” Choose path (shown immediately) -->
      <div id="ve-step-path">
        <div class="ve-step-header"><span class="ve-step-num">1</span> What do you want to change?</div>
        <div class="ve-path-btns">
          <button class="ve-path-btn" id="ve-btn-A" onclick="veSelectPath('A')">
            <div style="font-size:22px">ğŸ“</div>
            <div style="font-weight:600; margin-top:6px">Positioning &amp; Layout</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Move cards, change grid, resize areas</div>
          </button>
          <button class="ve-path-btn" id="ve-btn-B" onclick="veSelectPath('B')">
            <div style="font-size:22px">ğŸ¨</div>
            <div style="font-weight:600; margin-top:6px">Style from Reference</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Generate assets from a reference image</div>
          </button>
          <button class="ve-path-btn" id="ve-btn-C" onclick="veSelectPath('C')">
            <div style="font-size:22px">âœï¸</div>
            <div style="font-weight:600; margin-top:6px">Edit an Asset</div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px">Select an asset and describe the change</div>
          </button>
        </div>
      </div>

      <!-- Screenshot section (shown for Path A and B) -->
      <div id="ve-screenshot-section" style="display:none; margin-top:16px">
        <hr class="ve-divider">
        <div class="ve-step-header"><span class="ve-step-num">2</span> Upload a screenshot of the current build</div>
        <div class="ve-drop-zone" id="ve-drop-zone" onclick="document.getElementById('ve-file-input').click()">
          <p>Click to upload or drag &amp; drop a screenshot (PNG / JPG)</p>
          <input type="file" id="ve-file-input" accept="image/*" style="display:none">
        </div>

        <!-- Canvas + tools (shown after upload) -->
        <div id="ve-canvas-area" style="display:none; margin-top:12px">
          <div class="ve-tools">
            <span class="ve-label">Draw:</span>
            <button class="ve-tool-btn active" id="ve-tool-pen"    onclick="veSetTool('pen')">âœ Pen</button>
            <button class="ve-tool-btn"        id="ve-tool-arrow"  onclick="veSetTool('arrow')">â†’ Arrow</button>
            <button class="ve-tool-btn"        id="ve-tool-rect"   onclick="veSetTool('rect')">â–­ Box</button>
            <button class="ve-tool-btn"        id="ve-tool-erase"  onclick="veSetTool('erase')">âŒ« Erase</button>
            <button class="ve-tool-btn"        onclick="veClearDrawing()">Clear</button>
            <input type="color" id="ve-draw-color" value="#ff0000" title="Color" style="width:28px;height:28px;border:none;padding:0;cursor:pointer;border-radius:4px">
            <input type="range" id="ve-draw-size"  min="2" max="20" value="4" style="width:80px" title="Brush size">
            <button class="ve-tool-btn primary" id="ve-save-drawing-btn" onclick="veSaveDrawing()" style="margin-left:auto">ğŸ’¾ Save Drawing</button>
          </div>
          <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap">
            <div>
              <div class="ve-note" style="margin-bottom:4px; text-align:center">Original (clean)</div>
              <div class="ve-canvas-wrap" id="ve-canvas-wrap">
                <canvas id="ve-bg-canvas"></canvas>
                <canvas id="ve-draw-canvas" class="ve-draw-canvas"></canvas>
              </div>
            </div>
            <div id="ve-composite-wrap" style="display:none">
              <div class="ve-note" style="margin-bottom:4px; text-align:center; color:#22c55e; font-weight:600">âœ“ What Claude will see</div>
              <img id="ve-composite-img" style="display:block; border-radius:var(--radius); border:2px solid #22c55e" />
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ PATH A â€” Positioning & Layout â”€â”€ -->
      <div id="ve-path-a-form" style="display:none; margin-top:16px">
        <hr class="ve-divider">
        <div class="ve-step-header"><span class="ve-step-num">2</span> Describe the layout change</div>

        <!-- Left-right layout: Text field (left) + Screenshot (right, optional) -->
        <div style="display:flex; gap:16px; align-items:flex-start; margin-bottom:16px">

          <!-- LEFT: Text description (always visible) -->
          <div style="flex:1; min-width:300px">
            <div class="ve-label">Describe what you want changed:</div>
            <textarea id="ve-text-note" style="width:100%;height:200px;resize:vertical;padding:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;box-sizing:border-box;font-family:inherit"
              placeholder="E.g. 'Move the top row to 4 cards, spread them wider' or 'Add a 3-card column on the left' or 'Remove the draw pile'"></textarea>
            <p class="ve-note" style="margin-top:6px">You can submit text-only, or add a screenshot/drawing for more context.</p>
          </div>

          <!-- RIGHT: Screenshot upload + canvas (optional) -->
          <div style="flex:1; min-width:300px">
            <div class="ve-label">Optional: Add a screenshot</div>

            <!-- Upload area (shown when no screenshot) -->
            <div id="ve-a-drop-zone" class="ve-drop-zone" onclick="document.getElementById('ve-a-file-input').click()" style="margin-bottom:8px">
              <p style="font-size:12px">Click or drag screenshot<br>(or use Capture button)</p>
              <input type="file" id="ve-a-file-input" accept="image/*" style="display:none">
            </div>

            <!-- Canvas area (shown after upload) -->
            <div id="ve-a-canvas-area" style="display:none">
              <div class="ve-tools" style="margin-bottom:8px; font-size:11px">
                <button class="ve-tool-btn active" id="ve-a-tool-pen" onclick="veSetTool('pen')">âœ Pen</button>
                <button class="ve-tool-btn" id="ve-a-tool-arrow" onclick="veSetTool('arrow')">â†’ Arrow</button>
                <button class="ve-tool-btn" id="ve-a-tool-rect" onclick="veSetTool('rect')">â–­ Box</button>
                <button class="ve-tool-btn" id="ve-a-tool-erase" onclick="veSetTool('erase')">âŒ« Erase</button>
                <button class="ve-tool-btn" onclick="veClearDrawing()">Clear</button>
                <input type="color" id="ve-a-draw-color" value="#ff0000" style="width:24px;height:24px;border:none;padding:0;cursor:pointer;border-radius:3px">
                <button class="ve-tool-btn primary" id="ve-a-save-drawing-btn" onclick="veSaveDrawing()" style="margin-left:auto; font-size:11px">ğŸ’¾ Save</button>
              </div>
              <div style="display:flex; gap:8px">
                <div>
                  <div class="ve-note" style="font-size:10px; margin-bottom:2px">Original</div>
                  <div class="ve-canvas-wrap">
                    <canvas id="ve-a-bg-canvas"></canvas>
                    <canvas id="ve-a-draw-canvas" class="ve-draw-canvas"></canvas>
                  </div>
                </div>
                <div id="ve-a-composite-wrap" style="display:none">
                  <div class="ve-note" style="font-size:10px; margin-bottom:2px; color:#22c55e">âœ“ With marks</div>
                  <img id="ve-a-composite-img" style="display:block; border-radius:4px; border:2px solid #22c55e; max-width:150px" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Improve or Use As-Is -->
        <hr class="ve-divider" style="margin:20px 0">
        <div class="ve-step-header"><span class="ve-step-num">3</span> Submit your request</div>
        <div style="display:flex; gap:10px; margin-bottom:8px">
          <button class="ve-small-btn primary" id="ve-a-improve-btn" onclick="veImprovePathA()">âœ¨ Improve My Prompt</button>
          <button class="ve-small-btn" id="ve-a-skip-btn" onclick="veSkipImprovePathA()">Use As-Is â†’ Apply Now</button>
        </div>
        <div id="ve-a-status" class="ve-note" style="margin-top:6px"></div>

        <!-- Improved prompt result (shown after clicking Improve) -->
        <div id="ve-a-improved-section" style="display:none; margin-top:16px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">4</span> Improved Prompt</div>
          <div style="margin-bottom:12px">
            <div class="ve-label">Claude's suggestion:</div>
            <div id="ve-a-improved-prompt" style="padding:12px; background:var(--bg); border:2px solid #22c55e; border-radius:var(--radius); font-size:14px; line-height:1.6; font-weight:500; margin-top:6px"></div>
          </div>
          <button class="ve-apply-btn" id="ve-a-apply-btn" onclick="veApplyPathA()">âœ¨ Groom it!</button>
        </div>

        <!-- Reasoning from Claude (shown after clicking Apply) -->
        <div id="ve-a-reasoning-section" style="display:none; margin-top:16px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">5</span> Claude's Analysis</div>

          <!-- 1. Simple Explanation -->
          <div style="margin-bottom:16px">
            <div class="ve-label">ğŸ“ What Claude Understands:</div>
            <div id="ve-a-reasoning-simple" style="padding:12px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); font-size:13px; line-height:1.6; margin-top:6px"></div>
          </div>

          <!-- 2. Complexity/Risk Label -->
          <div style="margin-bottom:16px">
            <div class="ve-label">Complexity Assessment:</div>
            <div id="ve-a-reasoning-complexity" style="padding:10px 16px; border-radius:var(--radius); font-size:14px; font-weight:600; margin-top:6px; display:inline-block"></div>
          </div>

          <!-- 3. Technical Details -->
          <div style="margin-bottom:16px">
            <div class="ve-label">ğŸ”§ Technical Details:</div>
            <div id="ve-a-reasoning-technical" style="padding:12px; background:var(--bg); border:1px solid var(--border); border-radius:var(--radius); font-size:12px; line-height:1.6; font-family:monospace; margin-top:6px"></div>
          </div>

          <!-- Approve Button -->
          <button class="ve-apply-btn" id="ve-a-approve-btn" onclick="veApprovePathA()">âœ“ Approve & Add to Pending Requests</button>
        </div>
      </div>

      <!-- â”€â”€ PATH B â”€â”€ -->
      <div id="ve-path-b-form" style="display:none; margin-top:16px">
        <hr class="ve-divider">

        <!-- B Step 1 â€” Rough prompt -->
        <div id="ve-b-prompt-step">
          <div class="ve-step-header"><span class="ve-step-num">3</span> Describe the visual style you want</div>
          <textarea id="ve-rough-prompt" style="width:100%;height:70px;resize:vertical;padding:8px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;box-sizing:border-box"
            placeholder="E.g. 'dark mystical forest background with glowing plants'"></textarea>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
            <button class="ve-small-btn primary" id="ve-enhance-btn" onclick="veEnhancePrompt()">âœ¨ Suggest Better Prompts</button>
            <button class="ve-small-btn" id="ve-skip-enhance-btn" onclick="veSkipEnhance()">Skip â†’ Use As-Is</button>
          </div>
          <div id="ve-b-enhance-status" class="ve-note" style="margin-top:6px"></div>
        </div>

        <!-- B Step 2 â€” Prompt suggestions -->
        <div id="ve-b-suggestions-step" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">4</span> Pick a refined prompt (or edit)</div>
          <div id="ve-suggestions-list"></div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button class="ve-small-btn primary" id="ve-gen-ref-btn" onclick="veGenerateReference()" disabled>Generate Reference Image</button>
            <button class="ve-small-btn" onclick="veBackToPrompt()">â† Back</button>
          </div>
          <div id="ve-b-gen-status" class="ve-note" style="margin-top:6px"></div>
        </div>

        <!-- B Step 3 â€” Variations -->
        <div id="ve-b-variations-step" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">5</span> Pick a reference image</div>
          <div class="ve-variations" id="ve-variations-list"></div>
          <div style="margin-top:10px; display:flex; gap:8px">
            <button class="ve-small-btn primary" id="ve-ref-confirm-btn" onclick="veConfirmReference()" disabled>Use This Reference</button>
            <button class="ve-small-btn" onclick="veRegenerateReference()">â†» Regenerate</button>
          </div>
          <p class="ve-note">After selecting: you can draw annotations on the reference above before applying.</p>
        </div>

        <!-- B Step 4 â€” Asset browser + selection -->
        <div id="ve-b-assets-step" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">6</span> Select assets to replace</div>
          <p class="ve-note" style="margin-bottom:10px">These are the current project files. Check the ones you want regenerated in the style of the reference image.</p>
          <div id="ve-asset-browser" style="display:flex; gap:14px; flex-wrap:wrap; margin-bottom:12px">
            <!-- asset cards injected by JS -->
          </div>
          <div id="ve-b-asset-status" class="ve-note" style="margin-top:6px"></div>
          <button class="ve-apply-btn" id="ve-b-apply-btn" onclick="veApplyPathB()">Generate &amp; Save Assets</button>
          <p class="ve-note" style="margin-top:8px">New PNGs are saved to <code>static/assets/project/</code> and embedded automatically in the next Build.</p>
        </div>
      </div>

      <!-- â”€â”€ PATH C â€” Direct Asset Edit â”€â”€ -->
      <div id="ve-path-c-form" style="display:none; margin-top:16px">
        <hr class="ve-divider">

        <!-- C Step 1 â€” Pick asset -->
        <div class="ve-step-header"><span class="ve-step-num">2</span> Select the asset to edit</div>
        <p class="ve-note" style="margin-bottom:10px">Click an asset to select it.</p>
        <div id="ve-c-asset-picker" style="display:flex; gap:14px; flex-wrap:wrap; margin-bottom:4px">
          <!-- thumbnails injected by JS -->
        </div>

        <!-- C Step 2 â€” Prompt (shown after asset picked) -->
        <div id="ve-c-prompt-section" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">3</span> Describe the change</div>
          <textarea id="ve-c-prompt" style="width:100%;height:80px;resize:vertical;padding:8px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;box-sizing:border-box"
            placeholder="E.g. 'Make it a red velvet table instead of green felt' or 'Change the card back to gold floral art deco'"></textarea>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
            <button class="ve-small-btn primary" id="ve-c-gen-btn" onclick="veEditAsset()">Generate Preview</button>
          </div>
          <div id="ve-c-gen-status" class="ve-note" style="margin-top:6px"></div>
        </div>

        <!-- C Step 3 â€” Before / After preview + approve (shown after generation) -->
        <div id="ve-c-preview-section" style="display:none; margin-top:14px">
          <hr class="ve-divider">
          <div class="ve-step-header"><span class="ve-step-num">4</span> Review the result</div>
          <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:12px">
            <div>
              <div class="ve-note" style="margin-bottom:4px; text-align:center">Before</div>
              <img id="ve-c-before-img" style="display:block; border-radius:var(--radius); border:1px solid var(--border); max-height:200px; width:auto">
            </div>
            <div>
              <div class="ve-note" style="margin-bottom:4px; text-align:center; color:#6366f1; font-weight:600">After</div>
              <img id="ve-c-after-img" style="display:block; border-radius:var(--radius); border:2px solid #6366f1; max-height:200px; width:auto">
            </div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <button class="ve-apply-btn" id="ve-c-approve-btn" onclick="veApproveEditAsset()" style="width:auto; padding:10px 24px">Approve &amp; Save</button>
            <button class="ve-small-btn" id="ve-c-retry-btn" onclick="veRetryEditAsset()">â†» Try Again</button>
          </div>
          <div id="ve-c-approve-status" class="ve-note" style="margin-top:8px"></div>
        </div>
      </div>

    </div><!-- #ve-form -->

    <!-- â”€â”€ Build with changes â”€â”€ -->
    <div class="ve-section">
      <h2>Build</h2>
      <p class="ve-note" style="margin-bottom:10px">Applied changes are automatically included when you click Generate Ad (footer button), or use the button below.</p>
      <div id="ve-asset-preview" style="margin-bottom:12px; display:none">
        <div class="ve-label">Stored image assets (will be embedded in next build):</div>
        <div id="ve-asset-preview-items" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px"></div>
      </div>
      <button class="ve-apply-btn" onclick="onGenerate()">Build Ad with All Changes</button>
    </div>

    <!-- â”€â”€ Server Log â”€â”€ -->
    <div class="ve-section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <h2 style="margin:0">Server Log</h2>
        <div style="display:flex; gap:8px">
          <button class="ve-small-btn" onclick="veRefreshLogs()">â†» Refresh</button>
          <button class="ve-small-btn" onclick="veClearLogView()">Clear view</button>
        </div>
      </div>
      <div id="ve-log-box" style="background:#0d1117; border:1px solid var(--border); border-radius:var(--radius); padding:12px; height:220px; overflow-y:auto; font-family:monospace; font-size:12px; line-height:1.6; color:#e6edf3; white-space:pre-wrap; word-break:break-all;">
        <span style="color:#6e7681">Log will appear here â€” click Refresh or perform an action.</span>
      </div>
      <p class="ve-note" style="margin-top:6px">Shows the last 60 lines from <code>logs/server.log</code>. Auto-refreshes after each API call.</p>
    </div>

  </div><!-- #tab-visual-editor -->

  </div><!-- .workspace -->

</div><!-- .main -->

<!-- â”€â”€ FOOTER â”€â”€ -->
<footer>
  <button class="generate-btn" id="generate-btn">Generate Ad</button>

  <div class="result-area" id="result-area">
    <span class="result-msg" id="result-msg">Build ready!</span>
    <a class="result-btn" id="preview-btn" href="#" target="_blank">Preview</a>
    <button class="result-btn" id="download-btn">Download</button>
  </div>

  <span class="error-msg" id="error-msg"></span>
</footer>

<script>
'use strict';

// ============================================================
// COLOR FIELDS CONFIG
// ============================================================
const COLOR_FIELDS = [
  { id: 'v_background_color',   label: 'Background' },
  { id: 'v_table_felt_color',   label: 'Table Felt' },
  { id: 'v_card_face_color',    label: 'Card Face' },
  { id: 'v_card_back_color',    label: 'Card Back' },
  { id: 'v_card_border_color',  label: 'Card Border' },
  { id: 'v_highlight_color',    label: 'Highlight' },
  { id: 'v_button_color',       label: 'Button' },
  { id: 'v_button_text_color',  label: 'Button Text' },
  { id: 'v_primary_text_color', label: 'Primary Text' },
];

// ============================================================
// BUILD COLOR INPUTS
// ============================================================
function buildColorFields() {
  const container = document.getElementById('color-fields');
  COLOR_FIELDS.forEach(({ id, label }) => {
    const field = document.createElement('div');
    field.className = 'field';
    field.innerHTML =
      '<label>' + label + '</label>' +
      '<div class="color-row">' +
        '<input type="color" id="' + id + '" />' +
        '<input type="text" class="color-hex" id="' + id + '_hex" maxlength="7" placeholder="#000000" />' +
      '</div>';
    container.appendChild(field);

    field.querySelector('#' + id).addEventListener('input', function() {
      field.querySelector('#' + id + '_hex').value = this.value;
    });
    field.querySelector('#' + id + '_hex').addEventListener('input', function() {
      if (/^#[0-9a-fA-F]{6}$/.test(this.value)) {
        field.querySelector('#' + id).value = this.value;
      }
    });
  });
}

// ============================================================
// LEVEL MANAGEMENT
// ============================================================
let levelCounter = 0;

function defaultLevel() {
  return {
    level_id:          levelCounter + 1,
    show_draw_pile:    false,
    enter_animation:   'shuffle_in',
    enter_duration_ms: 900,
    layout: {
      foundation_card: '7H',
      tableau: [
        { code: '6S', face_up: true, col: 0, row: 0 },
        { code: '8D', face_up: true, col: 1, row: 0 }
      ],
      draw_pile: [],
      grid: { cell_width: 82, cell_height: 110, origin_x: 0.5, origin_y: 0.18 }
    },
    timings: {
      win_screen_duration_ms:       2000,
      fail_screen_duration_ms:      2000,
      level_transition_duration_ms: 1000
    }
  };
}

function addLevelCard(lvl) {
  levelCounter++;
  const id = 'level_' + Date.now() + '_' + levelCounter;

  const card = document.createElement('div');
  card.className = 'level-card';
  card.dataset.levelId = id;

  const drawPileStr = (lvl.layout.draw_pile || []).join(', ');
  const tableauStr  = JSON.stringify(lvl.layout.tableau || [], null, 2);

  card.innerHTML =
    '<div class="level-header open" data-header="' + id + '">' +
      '<span class="chevron">&#9658;</span>' +
      '<span class="level-title">Level ' + levelCounter + '</span>' +
      '<span class="level-badge" id="' + id + '_badge">' + (lvl.layout.tableau || []).length + ' cards</span>' +
      '<button class="remove-btn" data-remove="' + id + '" title="Remove level">&#10005;</button>' +
    '</div>' +
    '<div class="level-body open" id="' + id + '_body">' +

      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Game Type</label>' +
          '<select id="' + id + '_game_type">' +
            '<option value="solitaire_simplified">Solitaire (Simple)</option>' +
          '</select>' +
        '</div>' +
        '<div class="field">' +
          '<label>Enter Animation</label>' +
          '<select id="' + id + '_enter_animation">' +
            '<option value="shuffle_in">Shuffle In</option>' +
            '<option value="drop_down">Drop Down</option>' +
            '<option value="bulk">Bulk</option>' +
          '</select>' +
        '</div>' +
        '<div class="field">' +
          '<label>Enter Duration (ms)</label>' +
          '<input type="number" id="' + id + '_enter_duration_ms" min="200" max="3000" step="50" value="' + lvl.enter_duration_ms + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Show Draw Pile</label>' +
          '<div class="toggle-row" style="margin-top:4px">' +
            '<label class="toggle">' +
              '<input type="checkbox" id="' + id + '_show_draw_pile" ' + (lvl.show_draw_pile ? 'checked' : '') + ' />' +
              '<span class="toggle-slider"></span>' +
            '</label>' +
            '<span class="toggle-label">Show pile at bottom-left</span>' +
          '</div>' +
        '</div>' +
      '</div>' +

      '<div class="level-subhead">Layout</div>' +
      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Foundation Card</label>' +
          '<input type="text" id="' + id + '_foundation_card" value="' + lvl.layout.foundation_card + '" placeholder="7H" maxlength="3" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Draw Pile (comma-separated)</label>' +
          '<input type="text" id="' + id + '_draw_pile" value="' + drawPileStr + '" placeholder="AS, 2D, QH" />' +
        '</div>' +
      '</div>' +

      '<div class="level-subhead">Tableau Cards (JSON)</div>' +
      '<div class="field full">' +
        '<textarea id="' + id + '_tableau" rows="6">' + tableauStr + '</textarea>' +
      '</div>' +

      '<div class="level-subhead">Grid</div>' +
      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Cell Width (px)</label>' +
          '<input type="number" id="' + id + '_cell_width" min="40" max="160" value="' + lvl.layout.grid.cell_width + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Cell Height (px)</label>' +
          '<input type="number" id="' + id + '_cell_height" min="60" max="200" value="' + lvl.layout.grid.cell_height + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Origin X (0=left, 1=right)</label>' +
          '<div class="range-row">' +
            '<input type="range" id="' + id + '_origin_x" min="0" max="1" step="0.01" value="' + lvl.layout.grid.origin_x + '" />' +
            '<span class="range-val" id="' + id + '_origin_x_val">' + lvl.layout.grid.origin_x + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="field">' +
          '<label>Origin Y (0=top, 1=bottom)</label>' +
          '<div class="range-row">' +
            '<input type="range" id="' + id + '_origin_y" min="0" max="1" step="0.01" value="' + lvl.layout.grid.origin_y + '" />' +
            '<span class="range-val" id="' + id + '_origin_y_val">' + lvl.layout.grid.origin_y + '</span>' +
          '</div>' +
        '</div>' +
      '</div>' +

      '<div class="level-subhead">Timings</div>' +
      '<div class="form-grid">' +
        '<div class="field">' +
          '<label>Win Screen (ms)</label>' +
          '<input type="number" id="' + id + '_win_ms" min="500" max="10000" step="100" value="' + lvl.timings.win_screen_duration_ms + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Fail Screen (ms)</label>' +
          '<input type="number" id="' + id + '_fail_ms" min="500" max="10000" step="100" value="' + lvl.timings.fail_screen_duration_ms + '" />' +
        '</div>' +
        '<div class="field">' +
          '<label>Level Transition (ms)</label>' +
          '<input type="number" id="' + id + '_trans_ms" min="200" max="5000" step="100" value="' + lvl.timings.level_transition_duration_ms + '" />' +
        '</div>' +
      '</div>' +

      '<div class="coming-soon-block" style="border-color:#336633; opacity:1">' +
        '<div class="coming-soon-header">' +
          '<span>&#127918; Describe the Gameplay</span>' +
          '<span class="coming-soon-tag active">AI â€” Active</span>' +
        '</div>' +
        '<textarea id="' + id + '_gameplay_desc" style="border-color:#336633; color:var(--text)" placeholder="e.g. Foundation is 7H. Three columns â€” 6S face-up with 8C behind it, 9H face-up, 10D face-up. Easy chain, no draw pile."></textarea>' +
        '<div class="apply-row">' +
          '<button class="apply-btn" id="' + id + '_apply_btn">Apply with AI</button>' +
          '<span class="apply-status" id="' + id + '_apply_status"></span>' +
        '</div>' +
      '</div>' +

      '<div class="coming-soon-block">' +
        '<div class="coming-soon-header">' +
          '<span>ğŸ¨ Describe the Creative</span>' +
          '<span class="coming-soon-tag">Future milestone</span>' +
        '</div>' +
        '<textarea id="' + id + '_creative_desc" placeholder="e.g. Wild west desert background, sheriff sitting and relaxing, warm dusty colors, animated tumbleweeds..."></textarea>' +
        '<div class="coming-soon-note">In a future version this will generate visual themes, backgrounds, and character animations for this level.</div>' +
      '</div>' +

    '</div>';

  document.getElementById('levels-list').appendChild(card);

  // Set dropdown values (can't reliably do this in innerHTML)
  document.getElementById(id + '_game_type').value      = lvl.game_type || 'solitaire_simplified';
  document.getElementById(id + '_enter_animation').value = lvl.enter_animation;

  // Range live value labels
  ['origin_x', 'origin_y'].forEach(function(key) {
    var slider = document.getElementById(id + '_' + key);
    var valEl  = document.getElementById(id + '_' + key + '_val');
    slider.addEventListener('input', function() {
      valEl.textContent = parseFloat(slider.value).toFixed(2);
    });
  });

  // Tableau textarea -> update badge
  document.getElementById(id + '_tableau').addEventListener('input', function() {
    try {
      var arr = JSON.parse(this.value);
      document.getElementById(id + '_badge').textContent = arr.length + ' cards';
    } catch(e) {}
  });

  // Toggle header collapse
  card.querySelector('[data-header="' + id + '"]').addEventListener('click', function(e) {
    if (e.target.closest('[data-remove]')) return;
    var header = card.querySelector('[data-header="' + id + '"]');
    var body   = document.getElementById(id + '_body');
    header.classList.toggle('open');
    body.classList.toggle('open');
  });

  // Remove button
  card.querySelector('[data-remove="' + id + '"]').addEventListener('click', function() {
    card.remove();
    renumberLevels();
  });

  // Apply with AI button
  document.getElementById(id + '_apply_btn').addEventListener('click', function() {
    var desc   = document.getElementById(id + '_gameplay_desc').value.trim();
    var btn    = document.getElementById(id + '_apply_btn');
    var status = document.getElementById(id + '_apply_status');

    if (!desc) { status.textContent = 'Write a description first.'; return; }

    var levelIndex = Array.from(document.querySelectorAll('#levels-list .level-card')).indexOf(card);

    btn.disabled      = true;
    btn.textContent   = 'Thinking...';
    status.textContent = '';
    status.style.color = 'var(--muted)';

    fetch('/api/describe/gameplay', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ description: desc, level_index: levelIndex })
    })
    .then(function(r) {
      if (!r.ok) return r.json().then(function(e) { throw new Error(e.detail || 'Unknown error'); });
      return r.json();
    })
    .then(function(data) {
      var layout = data.layout;

      // Update foundation card
      document.getElementById(id + '_foundation_card').value = layout.foundation_card;

      // Update tableau textarea
      document.getElementById(id + '_tableau').value = JSON.stringify(layout.tableau, null, 2);

      // Update tableau badge
      document.getElementById(id + '_badge').textContent = layout.tableau.length + ' cards';

      // Update draw pile (comma-separated)
      document.getElementById(id + '_draw_pile').value = (layout.draw_pile || []).join(', ');

      // Update grid
      document.getElementById(id + '_cell_width').value  = layout.grid.cell_width;
      document.getElementById(id + '_cell_height').value = layout.grid.cell_height;
      document.getElementById(id + '_origin_x').value    = layout.grid.origin_x;
      document.getElementById(id + '_origin_y').value    = layout.grid.origin_y;
      document.getElementById(id + '_origin_x_val').textContent = parseFloat(layout.grid.origin_x).toFixed(2);
      document.getElementById(id + '_origin_y_val').textContent = parseFloat(layout.grid.origin_y).toFixed(2);

      status.style.color = '#66dd66';
      status.textContent = 'Layout applied!';
      setTimeout(function() { status.textContent = ''; }, 4000);
    })
    .catch(function(err) {
      status.style.color = '#ff6666';
      status.textContent = 'Error: ' + err.message;
    })
    .finally(function() {
      btn.disabled    = false;
      btn.textContent = 'Apply with AI';
    });
  });

  renumberLevels();
}

function renumberLevels() {
  document.querySelectorAll('#levels-list .level-card').forEach(function(card, i) {
    card.querySelector('.level-title').textContent = 'Level ' + (i + 1);
  });
}

// ============================================================
// POPULATE FORM FROM DEFAULTS
// ============================================================
function setVal(id, val) {
  var el = document.getElementById(id);
  if (!el) return;
  if (el.type === 'checkbox') { el.checked = !!val; return; }
  el.value = val;
}

function setColor(id, hex) {
  var picker = document.getElementById(id);
  var text   = document.getElementById(id + '_hex');
  if (picker) picker.value = hex;
  if (text)   text.value   = hex;
}

function populateFromDefaults(defaults) {
  var m = defaults.mechanics;
  setVal('m_input_type',            m.input_type);
  setVal('m_card_move_speed',       m.card_move_speed);
  setVal('m_animation_type',        m.animation_type);
  setVal('m_highlight_valid_moves', m.highlight_valid_moves);
  setVal('m_auto_complete_enabled', m.auto_complete_enabled);

  var v = defaults.visual;
  setColor('v_background_color',   v.background_color);
  setColor('v_table_felt_color',   v.table_felt_color);
  setColor('v_card_face_color',    v.card_face_color);
  setColor('v_card_back_color',    v.card_back_color);
  setColor('v_card_border_color',  v.card_border_color);
  setColor('v_highlight_color',    v.highlight_color);
  setColor('v_button_color',       v.button_color);
  setColor('v_button_text_color',  v.button_text_color);
  setColor('v_primary_text_color', v.primary_text_color);
  setVal('v_ui_theme',          v.ui_theme);
  setVal('v_card_back_pattern', v.card_back_pattern);
  setVal('v_font_family',       v.font_family);

  var l = defaults.levels;
  setVal('l_target_url',   l.target_url);
  setVal('l_cta_text',     l.cta_text);
  setVal('l_testing_mode', l.testing_mode);

  document.getElementById('levels-list').innerHTML = '';
  levelCounter = 0;
  (l.levels || []).forEach(function(lvl) { addLevelCard(lvl); });
}

// ============================================================
// READ CONFIG FROM FORM
// ============================================================
function getColor(id) {
  var hexEl = document.getElementById(id + '_hex');
  if (hexEl && hexEl.value) return hexEl.value;
  var picker = document.getElementById(id);
  return picker ? picker.value : '#000000';
}

function buildConfig() {
  var mechanics = {
    mechanics_version:     '1.0',
    genre:                 'solitaire_simplified',
    input_type:            document.getElementById('m_input_type').value,
    card_move_speed:       document.getElementById('m_card_move_speed').value,
    animation_type:        document.getElementById('m_animation_type').value,
    highlight_valid_moves: document.getElementById('m_highlight_valid_moves').checked,
    auto_complete_enabled: document.getElementById('m_auto_complete_enabled').checked
  };

  var visual = {
    visual_version:      '1.0',
    background_color:    getColor('v_background_color'),
    table_felt_color:    getColor('v_table_felt_color'),
    card_face_color:     getColor('v_card_face_color'),
    card_back_color:     getColor('v_card_back_color'),
    card_back_pattern:   document.getElementById('v_card_back_pattern').value,
    card_border_color:   getColor('v_card_border_color'),
    highlight_color:     getColor('v_highlight_color'),
    button_color:        getColor('v_button_color'),
    button_text_color:   getColor('v_button_text_color'),
    primary_text_color:  getColor('v_primary_text_color'),
    font_family:         document.getElementById('v_font_family').value,
    ui_theme:            document.getElementById('v_ui_theme').value
  };

  var levelCards = document.querySelectorAll('#levels-list .level-card');
  var levelsArr  = [];

  levelCards.forEach(function(card, idx) {
    var id = card.dataset.levelId;
    function g(n) { return document.getElementById(id + '_' + n); }

    var tableau = [];
    try { tableau = JSON.parse(g('tableau').value); } catch(e) {}

    var drawPileRaw = g('draw_pile').value.trim();
    var draw_pile   = drawPileRaw
      ? drawPileRaw.split(',').map(function(s) { return s.trim(); }).filter(Boolean)
      : [];

    levelsArr.push({
      level_id:          idx + 1,
      game_type:         g('game_type').value,
      show_draw_pile:    g('show_draw_pile').checked,
      enter_animation:   g('enter_animation').value,
      enter_duration_ms: parseInt(g('enter_duration_ms').value) || 900,
      layout: {
        foundation_card: g('foundation_card').value.trim(),
        tableau:         tableau,
        draw_pile:       draw_pile,
        grid: {
          cell_width:  parseInt(g('cell_width').value)  || 82,
          cell_height: parseInt(g('cell_height').value) || 110,
          origin_x:    parseFloat(g('origin_x').value)  || 0.5,
          origin_y:    parseFloat(g('origin_y').value)  || 0.18
        }
      },
      timings: {
        win_screen_duration_ms:       parseInt(g('win_ms').value)   || 2000,
        fail_screen_duration_ms:      parseInt(g('fail_ms').value)  || 2000,
        level_transition_duration_ms: parseInt(g('trans_ms').value) || 1000
      }
    });
  });

  var levels = {
    levels_version: '1.0',
    genre:          'solitaire_simplified',
    testing_mode:   document.getElementById('l_testing_mode').checked,
    total_levels:   levelsArr.length,
    target_url:     document.getElementById('l_target_url').value.trim(),
    cta_text:       document.getElementById('l_cta_text').value.trim(),
    levels:         levelsArr
  };

  return { mechanics: mechanics, levels: levels, visual: visual };
}

// ============================================================
// GENERATE
// ============================================================
var lastPlayUrl = null;

// ============================================================
// PREVIEW PANEL
// ============================================================

function previewReload() {
  var iframe = document.getElementById('preview-iframe');
  if (iframe.src && iframe.src !== 'about:blank') {
    iframe.src = iframe.src; // reload
  }
}

function veCapturePreview() {
  var iframe = document.getElementById('preview-iframe');
  if (!iframe.src || iframe.src === 'about:blank') {
    alert('No preview loaded. Generate a build first.');
    return;
  }

  try {
    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    var canvas = iframeDoc.querySelector('canvas');
    if (!canvas) {
      alert('Could not find canvas in preview. Make sure the build is fully loaded.');
      return;
    }

    // For PixiJS WebGL, we need to wait for the next animation frame and use getImageData
    setTimeout(function() {
      try {
        // Try direct canvas capture first (works for 2D canvas)
        var dataUrl = canvas.toDataURL('image/png');

        // Check if it's a blank/black image (WebGL issue)
        if (dataUrl.length < 1000) {
          // Fallback: use html2canvas or manual screenshot
          alert('WebGL canvas capture failed. Please use browser screenshot (Win+Shift+S or Cmd+Shift+4) and drag/drop the image into the Visual Editor screenshot area.');

          // Switch to Visual Editor tab anyway so they can drag/drop
          document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
          document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
          document.querySelector('[data-tab="visual-editor"]').classList.add('active');
          document.getElementById('tab-visual-editor').classList.add('active');
          veShowForm();
          veSelectPath('A');
          return;
        }

        var screenshotB64 = dataUrl.split(',')[1];

        // Capture game state metadata from iframe
        try {
          var iframeWin = iframe.contentWindow;
          veCapturedMetadata = {
            level_number: iframeWin.currentLevel || 0,
            foundation_card: iframeWin.foundation || 'unknown',
            tableau_count: (iframeWin.tableau && iframeWin.tableau.length) || 0,
            draw_pile_count: (iframeWin.drawPile && iframeWin.drawPile.length) || 0,
            game_state: 'captured' // Could be enhanced with more state detection
          };
          console.log('Captured metadata:', veCapturedMetadata);
        } catch (metaErr) {
          console.warn('Could not capture game metadata:', metaErr);
          veCapturedMetadata = null;
        }

        // Switch to Visual Editor tab
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        document.querySelector('[data-tab="visual-editor"]').classList.add('active');
        document.getElementById('tab-visual-editor').classList.add('active');

        // Always open/reset form and select Path A (works for first and subsequent captures)
        veShowForm();
        veSelectPath('A');

        // Auto-load the screenshot into Path A (small delay to ensure DOM is ready)
        veScreenshotB64 = screenshotB64;
        veCompositeB64 = null; // Clear previous drawing
        setTimeout(function() {
          veSetupPathACanvases(dataUrl);
        }, 100);
      } catch (innerErr) {
        alert('Capture failed: ' + innerErr.message + '\n\nUse drag & drop instead: take a screenshot and drag it into the upload area.');
      }
    }, 100); // Small delay for WebGL to finish rendering
  } catch (err) {
    alert('Could not access preview: ' + err.message);
  }
}

// ============================================================
// GENERATE & DOWNLOAD
// ============================================================

function onGenerate() {
  var btn     = document.getElementById('generate-btn');
  var errEl   = document.getElementById('error-msg');
  var resultEl = document.getElementById('result-area');

  btn.disabled        = true;
  btn.textContent     = 'Building...';
  errEl.textContent   = '';
  resultEl.classList.remove('visible');

  var config = buildConfig();

  fetch('/api/generate', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify(config)
  })
  .then(function(res) {
    if (!res.ok) return res.json().then(function(e) { throw new Error(e.detail || 'Unknown error'); });
    return res.json();
  })
  .then(function(data) {
    lastPlayUrl = data.play_url;
    document.getElementById('preview-btn').href = lastPlayUrl;
    document.getElementById('result-msg').textContent = 'Build ready! (' + data.run_id + ')';
    resultEl.classList.add('visible');

    // Load into preview panel
    var iframe = document.getElementById('preview-iframe');
    var placeholder = document.getElementById('preview-placeholder');
    iframe.src = data.play_url;
    placeholder.style.display = 'none';

    // Move pending changes to applied (grouped by this build)
    veMovePendingToApplied(data.run_id, data.run_id);
  })
  .catch(function(err) {
    errEl.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Generate Ad';
  });
}

function onDownload() {
  if (!lastPlayUrl) return;
  fetch(lastPlayUrl)
    .then(function(r) { return r.blob(); })
    .then(function(blob) {
      var url = URL.createObjectURL(blob);
      var a   = document.createElement('a');
      a.href     = url;
      a.download = 'playable_ad.html';
      a.click();
      URL.revokeObjectURL(url);
    })
    .catch(function(err) {
      document.getElementById('error-msg').textContent = 'Download failed: ' + err.message;
    });
}

// ============================================================
// TABS
// ============================================================
document.querySelectorAll('.tab-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'visual-editor') {
      veRefreshAssetLibrary();
    }
  });
});

// ============================================================
// WIRE UP + INIT
// ============================================================
document.getElementById('generate-btn').addEventListener('click', onGenerate);
document.getElementById('download-btn').addEventListener('click', onDownload);
document.getElementById('add-level-btn').addEventListener('click', function() {
  addLevelCard(defaultLevel());
});

// ============================================================
// LOAD BAR â€” previous builds + reset to defaults
// ============================================================
var defaultsCache = null;

function loadDefaults() {
  return fetch('/api/defaults')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      defaultsCache = data;
      populateFromDefaults(data);
      document.getElementById('load-build-select').value = '';
    })
    .catch(function(err) {
      document.getElementById('error-msg').textContent = 'Could not load defaults: ' + err.message;
    });
}

function populateBuildList() {
  fetch('/api/runs')
    .then(function(r) { return r.json(); })
    .then(function(runs) {
      var sel = document.getElementById('load-build-select');
      runs.forEach(function(run) {
        if (!run.has_build) return;
        var opt = document.createElement('option');
        opt.value = run.run_id;
        var date = new Date(run.created_at).toLocaleString();
        opt.textContent = run.run_id + '  (' + date + ')';
        sel.appendChild(opt);
      });
    });
}

document.getElementById('load-build-select').addEventListener('change', function() {
  var runId = this.value;
  if (!runId) return;
  fetch('/api/runs/' + runId)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      populateFromDefaults(data);
    })
    .catch(function(err) {
      document.getElementById('error-msg').textContent = 'Could not load build: ' + err.message;
    });
});

document.getElementById('reset-defaults-btn').addEventListener('click', function() {
  if (defaultsCache) {
    populateFromDefaults(defaultsCache);
    document.getElementById('load-build-select').value = '';
  } else {
    loadDefaults();
  }
});

// ============================================================
// VISUAL EDITOR - State (must be declared before INIT)
// ============================================================
var veImageAssets     = {};  // { background: base64, card_back: base64, felt: base64 }
var vePendingChanges  = [];  // changes not yet built (can be deleted)
var veAppliedChanges  = [];  // grouped by build: [{run_id, run_name, changes: [...]}]

// ============================================================
// INIT
// ============================================================
buildColorFields();
loadDefaults();
populateBuildList();
veRenderPending();
veRenderApplied();

// ============================================================
// VISUAL EDITOR - Remaining State
// ============================================================
var veCurrentPath     = null;
var veScreenshotB64  = null;
var veCompositeB64   = null;  // screenshot + drawing merged â€” sent to Claude
var veCapturedMetadata = null;  // game state metadata from Capture button
var veChosenPrompt   = null;
var veChosenRefB64   = null;
var veEditAssetName  = null;  // Path C: which asset is being edited
var veEditResultB64  = null;  // Path C: last generated preview (not yet saved)
var veDrawTool       = 'pen';
var veDrawing        = false;
var veLastX          = 0;
var veLastY          = 0;

// â”€â”€ Show / hide form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veShowForm() {
  var form = document.getElementById('ve-form');
  // If form is open and has work in progress, confirm before discarding
  if (form.style.display !== 'none' && (veScreenshotB64 || veEditAssetName)) {
    if (!confirm('You have an unsaved change in progress.\nDiscard it and start a new one?')) {
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      return;
    }
  }
  veResetForm();
  form.style.display = 'block';
  form.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
function veHideForm() {
  document.getElementById('ve-form').style.display = 'none';
  veResetForm();
}
function veResetForm() {
  veCurrentPath      = null;
  veScreenshotB64    = null;
  veCompositeB64     = null;
  veCapturedMetadata = null;
  veChosenPrompt     = null;
  veChosenRefB64     = null;
  veEditAssetName    = null;
  veEditResultB64    = null;
  document.getElementById('ve-drop-zone').innerHTML =
    '<p>Click to upload or drag &amp; drop a screenshot (PNG / JPG)</p>' +
    '<input type="file" id="ve-file-input" accept="image/*" style="display:none">';
  document.getElementById('ve-drop-zone').classList.remove('has-image');
  document.getElementById('ve-drop-zone').onclick = function() {
    document.getElementById('ve-file-input').click();
  };
  veRewireFileInput();
  document.getElementById('ve-canvas-area').style.display        = 'none';
  document.getElementById('ve-composite-wrap').style.display     = 'none';
  var saveBtn = document.getElementById('ve-save-drawing-btn');
  if (saveBtn) { saveBtn.textContent = 'ğŸ’¾ Save Drawing'; saveBtn.style.background = ''; saveBtn.style.borderColor = ''; saveBtn.style.color = ''; }
  var screenshotSection = document.getElementById('ve-screenshot-section');
  if (screenshotSection) screenshotSection.style.display = 'none';
  var pathAForm = document.getElementById('ve-path-a-form');
  if (pathAForm) pathAForm.style.display = 'none';
  var pathBForm = document.getElementById('ve-path-b-form');
  if (pathBForm) pathBForm.style.display = 'none';
  var pathCForm = document.getElementById('ve-path-c-form');
  if (pathCForm) pathCForm.style.display = 'none';

  // Reset Path A canvas area and improved prompt
  var aDropZone = document.getElementById('ve-a-drop-zone');
  var aCanvasArea = document.getElementById('ve-a-canvas-area');
  if (aDropZone) aDropZone.style.display = 'block';
  if (aCanvasArea) aCanvasArea.style.display = 'none';
  var aCompWrap = document.getElementById('ve-a-composite-wrap');
  if (aCompWrap) aCompWrap.style.display = 'none';
  var aSaveBtn = document.getElementById('ve-a-save-drawing-btn');
  if (aSaveBtn) {
    aSaveBtn.textContent = 'ğŸ’¾ Save';
    aSaveBtn.style.background = '';
    aSaveBtn.style.borderColor = '';
    aSaveBtn.style.color = '';
  }
  var aImprovedSection = document.getElementById('ve-a-improved-section');
  if (aImprovedSection) aImprovedSection.style.display = 'none';
  var aReasoningSection = document.getElementById('ve-a-reasoning-section');
  if (aReasoningSection) aReasoningSection.style.display = 'none';
  var aStatus = document.getElementById('ve-a-status');
  if (aStatus) {
    aStatus.textContent = '';
    aStatus.style.color = '';
  }
  veImprovedPromptA = null;
  window.vePathAApprovalData = null;

  // Reset Path B sections (with safety checks)
  var bSuggestionsStep = document.getElementById('ve-b-suggestions-step');
  if (bSuggestionsStep) bSuggestionsStep.style.display = 'none';
  var bVariationsStep = document.getElementById('ve-b-variations-step');
  if (bVariationsStep) bVariationsStep.style.display = 'none';
  var bAssetsStep = document.getElementById('ve-b-assets-step');
  if (bAssetsStep) bAssetsStep.style.display = 'none';

  // Reset Path C sections (with safety checks)
  var cPromptSection = document.getElementById('ve-c-prompt-section');
  if (cPromptSection) cPromptSection.style.display = 'none';
  var cPreviewSection = document.getElementById('ve-c-preview-section');
  if (cPreviewSection) cPreviewSection.style.display = 'none';
  var cAssetPicker = document.getElementById('ve-c-asset-picker');
  if (cAssetPicker) cAssetPicker.innerHTML = '';

  // Reset textareas and status fields (with safety checks)
  var textNote = document.getElementById('ve-text-note');
  if (textNote) textNote.value = '';
  var roughPrompt = document.getElementById('ve-rough-prompt');
  if (roughPrompt) roughPrompt.value = '';

  var bEnhanceStatus = document.getElementById('ve-b-enhance-status');
  if (bEnhanceStatus) bEnhanceStatus.textContent = '';
  var bGenStatus = document.getElementById('ve-b-gen-status');
  if (bGenStatus) bGenStatus.textContent = '';
  var cGenStatus = document.getElementById('ve-c-gen-status');
  if (cGenStatus) cGenStatus.textContent = '';
  var cApproveStatus = document.getElementById('ve-c-approve-status');
  if (cApproveStatus) cApproveStatus.textContent = '';

  // Reset path button selection
  document.querySelectorAll('.ve-path-btn').forEach(function(b) { b.classList.remove('selected'); });
}

// â”€â”€ File input wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veRewireFileInput() {
  var inp = document.getElementById('ve-file-input');
  if (!inp) return;
  inp.addEventListener('change', function() {
    var file = inp.files && inp.files[0];
    if (file) veLoadImage(file);
  });
}
veRewireFileInput();

// Drag & drop on drop zone
// Drag & drop for screenshot upload
(function() {
  var dropZone = document.getElementById('ve-drop-zone');
  if (!dropZone) {
    console.error('ve-drop-zone not found!');
    return;
  }

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '#6366f1';
    console.log('dragover');
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.stopPropagation();
    this.style.borderColor = '';
    console.log('dragleave');
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '';
    console.log('drop', e.dataTransfer.files);
    var file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      veLoadImage(file);
    } else {
      console.warn('No valid image file in drop');
    }
  });

  console.log('Drag/drop listeners attached to ve-drop-zone');
})();

function veLoadImage(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    veScreenshotB64 = e.target.result.split(',')[1]; // strip data-URL prefix
    veSetupCanvases(e.target.result);
  };
  reader.readAsDataURL(file);
}

// â”€â”€ Canvas setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veCalcDisplaySize(w, h) {
  var maxH = 260;
  var maxW = (document.getElementById('ve-form').offsetWidth || 400) - 48;
  var scale = Math.min(1, maxH / h, maxW / w);
  return { dw: Math.round(w * scale), dh: Math.round(h * scale) };
}

function veSetupCanvases(dataUrl) {
  var bgCvs = document.getElementById('ve-bg-canvas');
  var drCvs = document.getElementById('ve-draw-canvas');
  var img   = new Image();
  img.onload = function() {
    var w = img.naturalWidth, h = img.naturalHeight;
    var d = veCalcDisplaySize(w, h);
    // Internal resolution = full (accurate drawing coords)
    bgCvs.width  = drCvs.width  = w;
    bgCvs.height = drCvs.height = h;
    // Display size = constrained thumbnail
    bgCvs.style.width  = drCvs.style.width  = d.dw + 'px';
    bgCvs.style.height = drCvs.style.height = d.dh + 'px';
    bgCvs.getContext('2d').drawImage(img, 0, 0);
    drCvs.getContext('2d').clearRect(0, 0, w, h);
    document.getElementById('ve-canvas-area').style.display = 'block';
    // Reveal the appropriate path form now that a screenshot is loaded
    if (veCurrentPath === 'A') document.getElementById('ve-path-a-form').style.display = 'block';
    if (veCurrentPath === 'B') document.getElementById('ve-path-b-form').style.display = 'block';
    veBindDrawEvents(drCvs);
  };
  img.src = dataUrl;
}

function veLoadRefIntoCanvas(dataUrlOrB64) {
  var src = dataUrlOrB64.startsWith('data:') ? dataUrlOrB64 : 'data:image/png;base64,' + dataUrlOrB64;
  var bgCvs = document.getElementById('ve-bg-canvas');
  var drCvs = document.getElementById('ve-draw-canvas');
  var img   = new Image();
  img.onload = function() {
    var w = img.naturalWidth, h = img.naturalHeight;
    var d = veCalcDisplaySize(w, h);
    bgCvs.width  = drCvs.width  = w;
    bgCvs.height = drCvs.height = h;
    bgCvs.style.width  = drCvs.style.width  = d.dw + 'px';
    bgCvs.style.height = drCvs.style.height = d.dh + 'px';
    bgCvs.getContext('2d').drawImage(img, 0, 0);
    drCvs.getContext('2d').clearRect(0, 0, w, h);
  };
  img.src = src;
}

// â”€â”€ Drawing tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veSaveDrawing() {
  // Detect which path is active and use appropriate canvas IDs
  var bgCvs, drCvs, compWrap, compImg, saveBtn;

  if (veCurrentPath === 'A') {
    bgCvs = document.getElementById('ve-a-bg-canvas');
    drCvs = document.getElementById('ve-a-draw-canvas');
    compWrap = document.getElementById('ve-a-composite-wrap');
    compImg = document.getElementById('ve-a-composite-img');
    saveBtn = document.getElementById('ve-a-save-drawing-btn');
  } else {
    // Path B uses old IDs
    bgCvs = document.getElementById('ve-bg-canvas');
    drCvs = document.getElementById('ve-draw-canvas');
    compWrap = document.getElementById('ve-composite-wrap');
    compImg = document.getElementById('ve-composite-img');
    saveBtn = document.getElementById('ve-save-drawing-btn');
  }

  if (!bgCvs || !drCvs) return;

  // Check drawing canvas has any marks
  var drData = drCvs.getContext('2d').getImageData(0, 0, drCvs.width, drCvs.height).data;
  var hasMarks = false;
  for (var i = 3; i < drData.length; i += 4) { if (drData[i] > 0) { hasMarks = true; break; } }
  if (!hasMarks) {
    alert('Draw something on the screenshot first, then save.');
    return;
  }

  // Composite: draw canvas on top of bg canvas â†’ one merged image
  var merged = document.createElement('canvas');
  merged.width = bgCvs.width;
  merged.height = bgCvs.height;
  var ctx = merged.getContext('2d');
  ctx.drawImage(bgCvs, 0, 0);
  ctx.drawImage(drCvs, 0, 0);

  var dataUrl = merged.toDataURL('image/png');
  veCompositeB64 = dataUrl.split(',')[1];

  // Show composite preview at same display size as bg canvas
  if (compWrap && compImg) {
    compImg.src = dataUrl;
    compImg.style.width = bgCvs.style.width;
    compImg.style.height = bgCvs.style.height;
    compWrap.style.display = 'block';
  }

  // Visual feedback on button
  if (saveBtn) {
    saveBtn.textContent = 'âœ“ Drawing Saved';
    saveBtn.style.background = '#22c55e';
    saveBtn.style.borderColor = '#22c55e';
    saveBtn.style.color = '#fff';
  }

  veLog('Drawing saved â€” composite ready to send to Claude');
}

function veSetTool(t) {
  veDrawTool = t;
  document.querySelectorAll('[id^="ve-tool-"]').forEach(function(b) { b.classList.remove('active'); });
  var btn = document.getElementById('ve-tool-' + t);
  if (btn) btn.classList.add('active');
}

function veClearDrawing() {
  var drCvs = document.getElementById('ve-draw-canvas');
  if (drCvs) drCvs.getContext('2d').clearRect(0, 0, drCvs.width, drCvs.height);
}

function veBindDrawEvents(cvs) {
  // Remove old listeners by cloning
  var originalId = cvs.id;
  var newCvs = cvs.cloneNode(false);
  cvs.parentNode.replaceChild(newCvs, cvs);
  newCvs.id = originalId; // Preserve original ID (ve-a-draw-canvas or ve-draw-canvas)
  newCvs.className = cvs.className;

  function pos(e) {
    var r = newCvs.getBoundingClientRect();
    var scaleX = newCvs.width  / r.width;
    var scaleY = newCvs.height / r.height;
    var clientX = e.touches ? e.touches[0].clientX : e.clientX;
    var clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: (clientX - r.left) * scaleX, y: (clientY - r.top) * scaleY };
  }

  function start(e) {
    e.preventDefault();
    veDrawing = true;
    var p = pos(e);
    veLastX = p.x; veLastY = p.y;
  }
  function move(e) {
    if (!veDrawing) return;
    e.preventDefault();
    var p   = pos(e);
    var ctx = newCvs.getContext('2d');
    // Determine which color/size inputs to use based on canvas ID
    var colorId = originalId === 've-a-draw-canvas' ? 've-a-draw-color' : 've-draw-color';
    var sizeId = originalId === 've-a-draw-canvas' ? 've-a-draw-size' : 've-draw-size';
    var col = document.getElementById(colorId).value;
    var sz  = parseInt(document.getElementById(sizeId).value) || 4;
    if (veDrawTool === 'erase') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = sz * 4;
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = col;
      ctx.lineWidth   = sz;
      ctx.lineCap     = 'round';
      ctx.lineJoin    = 'round';
    }
    ctx.beginPath();
    ctx.moveTo(veLastX, veLastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    veLastX = p.x; veLastY = p.y;
  }
  function end() {
    veDrawing = false;
    var ctx = newCvs.getContext('2d');
    ctx.globalCompositeOperation = 'source-over';
  }

  newCvs.addEventListener('mousedown',  start);
  newCvs.addEventListener('mousemove',  move);
  newCvs.addEventListener('mouseup',    end);
  newCvs.addEventListener('mouseleave', end);
  newCvs.addEventListener('touchstart', start, { passive: false });
  newCvs.addEventListener('touchmove',  move,  { passive: false });
  newCvs.addEventListener('touchend',   end);
}

function veGetAnnotations() {
  var drCvs = document.getElementById('ve-draw-canvas');
  if (!drCvs) return null;
  // Return null if canvas is blank
  var data = drCvs.getContext('2d').getImageData(0, 0, drCvs.width, drCvs.height).data;
  var hasPixels = false;
  for (var i = 3; i < data.length; i += 4) { if (data[i] > 0) { hasPixels = true; break; } }
  if (!hasPixels) return null;
  return drCvs.toDataURL('image/png').split(',')[1];
}

// â”€â”€ Path selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veSelectPath(path) {
  veCurrentPath = path;
  document.querySelectorAll('.ve-path-btn').forEach(function(b) { b.classList.remove('selected'); });
  document.getElementById('ve-btn-' + path).classList.add('selected');

  // Screenshot section: visible for B only (Path A has its own upload, C doesn't need it)
  document.getElementById('ve-screenshot-section').style.display = (path === 'B') ? 'block' : 'none';

  // Path forms: A and C show immediately, B shows after screenshot
  document.getElementById('ve-path-a-form').style.display = 'none';
  document.getElementById('ve-path-b-form').style.display = 'none';
  document.getElementById('ve-path-c-form').style.display = 'none';

  if (path === 'A') {
    document.getElementById('ve-path-a-form').style.display = 'block';
    veWirePathAUpload();
  } else if (path === 'C') {
    document.getElementById('ve-path-c-form').style.display = 'block';
    veCLoadAssets();
  } else if (path === 'B') {
    // Path B form shows after screenshot upload
    if (veScreenshotB64) {
      document.getElementById('ve-path-b-form').style.display = 'block';
    }
  }
}

// â”€â”€ PATH A â€” Upload handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veWirePathAUpload() {
  var inp = document.getElementById('ve-a-file-input');
  if (!inp) return;
  // Remove old listeners by cloning
  var newInp = inp.cloneNode(true);
  inp.parentNode.replaceChild(newInp, inp);

  newInp.addEventListener('change', function() {
    var file = newInp.files && newInp.files[0];
    if (file) veLoadPathAImage(file);
  });

  // Drag & drop on Path A drop zone
  var dropZone = document.getElementById('ve-a-drop-zone');
  if (!dropZone) return;

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '#6366f1';
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.stopPropagation();
    this.style.borderColor = '';
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.style.borderColor = '';
    var file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      veLoadPathAImage(file);
    }
  });
}

function veLoadPathAImage(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    veScreenshotB64 = e.target.result.split(',')[1];
    veSetupPathACanvases(e.target.result);
  };
  reader.readAsDataURL(file);
}

function veSetupPathACanvases(dataUrl) {
  var bgCvs = document.getElementById('ve-a-bg-canvas');
  var drCvs = document.getElementById('ve-a-draw-canvas');

  if (!bgCvs || !drCvs) {
    console.error('Path A canvases not found');
    return;
  }

  var img = new Image();
  img.onload = function() {
    var w = img.naturalWidth, h = img.naturalHeight;
    var maxH = 200;
    var scale = Math.min(1, maxH / h);
    var dw = Math.round(w * scale);
    var dh = Math.round(h * scale);

    bgCvs.width = drCvs.width = w;
    bgCvs.height = drCvs.height = h;
    bgCvs.style.width = drCvs.style.width = dw + 'px';
    bgCvs.style.height = drCvs.style.height = dh + 'px';
    bgCvs.getContext('2d').drawImage(img, 0, 0);
    drCvs.getContext('2d').clearRect(0, 0, w, h);

    // Hide drop zone, show canvas area
    document.getElementById('ve-a-drop-zone').style.display = 'none';
    document.getElementById('ve-a-canvas-area').style.display = 'block';

    // Hide composite wrap (from previous drawing)
    var compWrap = document.getElementById('ve-a-composite-wrap');
    if (compWrap) compWrap.style.display = 'none';

    // Reset save button
    var saveBtn = document.getElementById('ve-a-save-drawing-btn');
    if (saveBtn) {
      saveBtn.textContent = 'ğŸ’¾ Save';
      saveBtn.style.background = '';
      saveBtn.style.borderColor = '';
      saveBtn.style.color = '';
    }

    veBindDrawEvents(drCvs);
  };
  img.src = dataUrl;
}

// â”€â”€ PATH A â€” Improve prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var veImprovedPromptA = null;

function veImprovePathA() {
  var note = document.getElementById('ve-text-note').value.trim();
  var status = document.getElementById('ve-a-status');

  // Require at least text OR screenshot
  if (!note && !veScreenshotB64) {
    status.textContent = 'Enter a text description or upload a screenshot first.';
    status.style.color = '';
    return;
  }

  var improveBtn = document.getElementById('ve-a-improve-btn');
  var skipBtn = document.getElementById('ve-a-skip-btn');

  improveBtn.disabled = true;
  skipBtn.disabled = true;
  improveBtn.textContent = 'Thinking...';
  status.textContent = 'Asking Claude to improve your prompt...';
  status.style.color = '';

  // Prepare payload (text + optional screenshot)
  var screenshotToSend = null;
  if (veScreenshotB64) {
    screenshotToSend = veCompositeB64 || veScreenshotB64;
  }

  var payload = {
    text_prompt: note,
    screenshot: screenshotToSend,
    has_drawing: !!veCompositeB64,
    game_metadata: veCapturedMetadata
  };

  // TODO: Replace with real /api/visual/improve-prompt endpoint
  // For now, simulate with timeout
  setTimeout(function() {
    // Simulated improved prompt
    if (note) {
      veImprovedPromptA = note + " â€” optimized for clarity: ensure cards are clearly visible, maintain proper spacing, and verify layout is solvable";
    } else {
      veImprovedPromptA = "Based on the screenshot: adjust card positions to improve playability, ensure all cards are accessible, and optimize the layout for better visual flow";
    }

    document.getElementById('ve-a-improved-prompt').textContent = veImprovedPromptA;
    document.getElementById('ve-a-improved-section').style.display = 'block';

    status.textContent = 'âœ“ Prompt improved!';
    status.style.color = '#22c55e';
    improveBtn.disabled = false;
    skipBtn.disabled = false;
    improveBtn.textContent = 'âœ¨ Improve My Prompt';

    // Scroll to result
    document.getElementById('ve-a-improved-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 2000);
}

function veSkipImprovePathA() {
  var note = document.getElementById('ve-text-note').value.trim();

  // Skip improvement, use original prompt
  veImprovedPromptA = note;

  // Go straight to apply
  veApplyPathA();
}

// â”€â”€ PATH A â€” Apply layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veApplyPathA() {
  var btn = document.getElementById('ve-a-apply-btn');
  var status = document.getElementById('ve-a-status');
  var note = document.getElementById('ve-text-note').value.trim();

  // Use improved prompt if available, otherwise original
  var promptToUse = veImprovedPromptA || note;

  // Require at least text OR screenshot
  if (!promptToUse && !veScreenshotB64) {
    status.textContent = 'Enter a text description or upload a screenshot.';
    status.style.color = '';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Applying...';
  status.textContent = '';

  // Determine what to send
  var screenshotToSend = null;
  var hasDrawing = false;

  if (veScreenshotB64) {
    screenshotToSend = veCompositeB64 || veScreenshotB64;
    hasDrawing = !!veCompositeB64;
  }

  var payload = {
    screenshot: screenshotToSend,
    annotations: null,
    nanobanana_reference: null,
    has_drawing: hasDrawing,
    text_note: promptToUse || null,
    level_index: 0,
    game_metadata: veCapturedMetadata
  };

  fetch('/api/visual/layout', {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    // Apply to the first level card â€” fields use id pattern: {card.dataset.levelId}_fieldname
    var levelCards = document.querySelectorAll('.level-card');
    if (levelCards.length > 0) {
      var card   = levelCards[0];
      var cardId = card.dataset.levelId;
      var layout = data.layout;
      var fc  = document.getElementById(cardId + '_foundation_card');
      var tab = document.getElementById(cardId + '_tableau');
      var dp  = document.getElementById(cardId + '_draw_pile');
      var cw  = document.getElementById(cardId + '_cell_width');
      var ch  = document.getElementById(cardId + '_cell_height');
      if (fc)  fc.value  = layout.foundation_card;
      if (tab) tab.value = JSON.stringify(layout.tableau, null, 2);
      if (dp)  dp.value  = (layout.draw_pile || []).join(', ');
      if (cw)  cw.value  = layout.grid.cell_width;
      if (ch)  ch.value  = layout.grid.cell_height;
      var badge = card.querySelector('.tableau-badge');
      if (badge) badge.textContent = (layout.tableau || []).length + ' cards';
      veLog('Path A applied to level card "' + cardId + '": foundation=' + layout.foundation_card + ', ' + (layout.tableau||[]).length + ' tableau cards');
    } else {
      veLog('Warning: no level cards found in form â€” switch to Levels tab and add a level first');
    }

    // Store data for approval
    window.vePathAApprovalData = {
      layout: data.layout,
      solve_sequence: data.solve_sequence,
      reasoning: data.reasoning || {}
    };

    // Show reasoning section
    var reasoning = data.reasoning || {};
    var reasoningSimple = reasoning.simple || "I understand your request and will create a new layout based on your description.";
    var reasoningComplexity = reasoning.complexity || "moderate";
    var layout = data.layout;

    // 1. Simple explanation
    document.getElementById('ve-a-reasoning-simple').textContent = reasoningSimple;

    // 2. Complexity label with color coding
    var complexityEl = document.getElementById('ve-a-reasoning-complexity');
    var complexityText = '';
    var complexityColor = '';

    if (reasoningComplexity === 'easy') {
      complexityText = 'âš¡ Easy & Simple';
      complexityColor = 'background:#22c55e; color:#fff';
    } else if (reasoningComplexity === 'risky') {
      complexityText = 'ğŸ”´ Complicated & Risky';
      complexityColor = 'background:#ef4444; color:#fff';
    } else {
      complexityText = 'âš ï¸ Moderate';
      complexityColor = 'background:#f59e0b; color:#fff';
    }

    complexityEl.textContent = complexityText;
    complexityEl.style.cssText += complexityColor;

    // 3. Technical details
    var techHtml = '';
    techHtml += 'Foundation: ' + layout.foundation_card + '\n';
    techHtml += 'Tableau: ' + layout.tableau.length + ' cards in ' +
            (Math.max.apply(null, layout.tableau.map(function(c) { return c.col; })) + 1) + ' columns\n';
    if (layout.draw_pile && layout.draw_pile.length > 0) {
      techHtml += 'Draw pile: ' + layout.draw_pile.length + ' cards\n';
    }
    techHtml += 'Grid: ' + layout.grid.cell_width + 'x' + layout.grid.cell_height + ', origin (' + layout.grid.origin_x + ', ' + layout.grid.origin_y + ')\n';
    if (data.solve_sequence && data.solve_sequence.length > 0) {
      techHtml += '\nSolve sequence: ' + data.solve_sequence.join(' â†’ ');
    }

    document.getElementById('ve-a-reasoning-technical').textContent = techHtml;

    // Show reasoning section, hide improved prompt section
    document.getElementById('ve-a-improved-section').style.display = 'none';
    document.getElementById('ve-a-reasoning-section').style.display = 'block';

    status.textContent = 'âœ“ Layout analyzed! Review the reasoning below.';
    status.style.color = '#22c55e';

    // Scroll to reasoning
    document.getElementById('ve-a-reasoning-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = '';
  })
  .finally(function() {
    btn.disabled = false;
    btn.textContent = 'âœ¨ Groom it!';
  });
}

// â”€â”€ PATH A â€” Approve and add to pending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veApprovePathA() {
  if (!window.vePathAApprovalData) {
    alert('No layout to approve. Please apply a change first.');
    return;
  }

  var data = window.vePathAApprovalData;

  // Add to pending changes
  veAddPendingChange(
    'A',
    veScreenshotB64,
    veCompositeB64 || null,
    data.solve_sequence ? 'Solve: ' + data.solve_sequence.join(' â†’ ') : 'Layout updated'
  );

  veLog('Path A approved and added to pending requests');

  // Show success message
  var status = document.getElementById('ve-a-status');
  status.textContent = 'âœ“ Added to Pending Requests!';
  status.style.color = '#22c55e';

  // Close form after brief delay
  setTimeout(function() {
    veHideForm();
  }, 1500);
}

// â”€â”€ PATH B â€” Prompt enhancement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veEnhancePrompt() {
  if (!veScreenshotB64) { document.getElementById('ve-b-enhance-status').textContent = 'Upload a screenshot first.'; return; }
  var rough = document.getElementById('ve-rough-prompt').value.trim();
  if (!rough) { document.getElementById('ve-b-enhance-status').textContent = 'Write a description first.'; return; }

  var btn    = document.getElementById('ve-enhance-btn');
  var status = document.getElementById('ve-b-enhance-status');
  btn.disabled    = true;
  btn.textContent = 'Asking Claude...';
  status.textContent = '';

  fetch('/api/nanobanana/enhance-prompt', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ rough_prompt: rough, screenshot: veScreenshotB64 })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    veShowSuggestions(data.suggestions);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'âœ¨ Suggest Better Prompts';
  });
}

function veSkipEnhance() {
  var rough = document.getElementById('ve-rough-prompt').value.trim();
  if (!rough) { document.getElementById('ve-b-enhance-status').textContent = 'Write a description first.'; return; }
  veChosenPrompt = rough;
  veShowSuggestions([rough]);
}

function veShowSuggestions(suggestions) {
  var list = document.getElementById('ve-suggestions-list');
  list.innerHTML = '';
  suggestions.forEach(function(s, i) {
    var btn = document.createElement('button');
    btn.className   = 've-suggestion';
    btn.textContent = s;
    btn.onclick     = function() {
      veChosenPrompt = s;
      document.querySelectorAll('.ve-suggestion').forEach(function(b) { b.classList.remove('selected'); });
      btn.classList.add('selected');
      document.getElementById('ve-gen-ref-btn').disabled = false;
    };
    list.appendChild(btn);
  });
  document.getElementById('ve-b-suggestions-step').style.display = 'block';
  document.getElementById('ve-gen-ref-btn').disabled = true;
}

function veBackToPrompt() {
  document.getElementById('ve-b-suggestions-step').style.display = 'none';
  veChosenPrompt = null;
}

// â”€â”€ PATH B â€” Generate reference â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veGenerateReference() {
  if (!veChosenPrompt) return;
  var btn    = document.getElementById('ve-gen-ref-btn');
  var status = document.getElementById('ve-b-gen-status');
  btn.disabled    = true;
  btn.textContent = 'Generating...';
  status.textContent = 'Sending to Nanobanana (Google Gemini)...';

  fetch('/api/nanobanana/generate', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt: veChosenPrompt, reference_image: veScreenshotB64, num_variations: 2 })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    status.textContent = '';
    veShowVariations(data.images || []);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Generate Reference Image';
  });
}

function veRegenerateReference() {
  veGenerateReference();
}

function veShowVariations(images) {
  var list = document.getElementById('ve-variations-list');
  list.innerHTML = '';
  images.forEach(function(b64, i) {
    var wrap = document.createElement('div');
    wrap.className = 've-variation';
    var img = document.createElement('img');
    img.src = 'data:image/png;base64,' + b64;
    wrap.appendChild(img);
    wrap.onclick = function() {
      document.querySelectorAll('.ve-variation').forEach(function(v) { v.classList.remove('selected'); });
      wrap.classList.add('selected');
      veChosenRefB64 = b64;
      document.getElementById('ve-ref-confirm-btn').disabled = false;
      // Load selected reference into canvas so user can annotate it
      veLoadRefIntoCanvas(b64);
    };
    list.appendChild(wrap);
  });
  document.getElementById('ve-b-variations-step').style.display = 'block';
  document.getElementById('ve-ref-confirm-btn').disabled = true;
}

function veConfirmReference() {
  if (!veChosenRefB64) return;
  document.getElementById('ve-b-assets-step').style.display = 'block';
  document.getElementById('ve-b-asset-status').textContent = '';
  veLoadAssetBrowser();
}

function veLoadAssetBrowser() {
  var browser = document.getElementById('ve-asset-browser');
  browser.innerHTML = '<span style="color:var(--muted);font-size:13px">Loading assets...</span>';
  fetch('/api/assets/list')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      browser.innerHTML = '';
      (data.assets || []).forEach(function(asset) {
        var card = document.createElement('div');
        card.className = 've-asset-card selected'; // default all selected
        card.dataset.assetName = asset.name;
        card.onclick = function() { card.classList.toggle('selected'); };

        var img = document.createElement('img');
        if (asset.preview) {
          img.src = 'data:image/png;base64,' + asset.preview;
        } else {
          img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
          img.style.background = '#333';
        }

        var nameEl = document.createElement('div');
        nameEl.className = 've-ac-name';
        nameEl.textContent = asset.name.replace('_', ' ');

        var descEl = document.createElement('div');
        descEl.className = 've-ac-desc';
        descEl.textContent = asset.description;

        card.appendChild(img);
        card.appendChild(nameEl);
        card.appendChild(descEl);
        browser.appendChild(card);
      });
    })
    .catch(function() {
      browser.innerHTML = '<span style="color:#f97583">Could not load assets. Is the server running?</span>';
    });
}

// â”€â”€ PATH B â€” Apply assets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veApplyPathB() {
  var btn    = document.getElementById('ve-b-apply-btn');
  var status = document.getElementById('ve-b-asset-status');
  if (!veChosenRefB64) { status.textContent = 'Select a reference image first.'; return; }

  var assetNames = [];
  document.querySelectorAll('.ve-asset-card.selected').forEach(function(card) {
    if (card.dataset.assetName) assetNames.push(card.dataset.assetName);
  });
  if (assetNames.length === 0) { status.textContent = 'Select at least one asset (click to toggle).'; return; }

  btn.disabled    = true;
  btn.textContent = 'Generating assets...';
  status.textContent = 'Sending to Nanobanana...';

  fetch('/api/assets/replace', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ asset_names: assetNames, reference_image: veChosenRefB64, annotations: veGetAnnotations() })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    // Assets saved to disk on server â€” clear in-memory overrides (build will read from files)
    assetNames.forEach(function(n) { delete veImageAssets[n]; });
    veUpdateAssetPreview();
    veAddPendingChange('B', veChosenRefB64, null, 'Saved to disk: ' + assetNames.join(', '));
    status.textContent = 'Assets saved to static/assets/project/. Next Build will include them.';
    setTimeout(function() { veHideForm(); }, 3000);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Generate & Apply Assets';
  });
}

// â”€â”€ PATH C â€” Direct Asset Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function veCLoadAssets() {
  var picker = document.getElementById('ve-c-asset-picker');
  picker.innerHTML = '<span style="color:var(--muted);font-size:13px">Loading assets...</span>';
  fetch('/api/assets/list')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      picker.innerHTML = '';
      (data.assets || []).forEach(function(asset) {
        var card = document.createElement('div');
        card.className = 've-asset-card';
        card.dataset.assetName = asset.name;
        card.style.cursor = 'pointer';
        card.onclick = function() { vePickEditAsset(asset.name, card); };

        var img = document.createElement('img');
        img.src = asset.preview ? 'data:image/png;base64,' + asset.preview
                                : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';

        var nameEl = document.createElement('div');
        nameEl.className = 've-ac-name';
        nameEl.textContent = asset.name.replace('_', ' ');

        var descEl = document.createElement('div');
        descEl.className = 've-ac-desc';
        descEl.textContent = asset.description;

        card.appendChild(img);
        card.appendChild(nameEl);
        card.appendChild(descEl);
        picker.appendChild(card);
      });
    })
    .catch(function() {
      picker.innerHTML = '<span style="color:#f97583">Could not load assets.</span>';
    });
}

function vePickEditAsset(name, cardEl) {
  veEditAssetName = name;
  // Visual selection â€” radio-like (only one at a time)
  document.querySelectorAll('#ve-c-asset-picker .ve-asset-card').forEach(function(c) {
    c.classList.remove('selected');
  });
  cardEl.classList.add('selected');
  // Reveal prompt section
  document.getElementById('ve-c-prompt-section').style.display = 'block';
  document.getElementById('ve-c-preview-section').style.display = 'none';
  document.getElementById('ve-c-gen-status').textContent = '';
  document.getElementById('ve-c-approve-status').textContent = '';
  document.getElementById('ve-c-prompt').focus();
}

function veEditAsset() {
  var btn    = document.getElementById('ve-c-gen-btn');
  var status = document.getElementById('ve-c-gen-status');
  var prompt = document.getElementById('ve-c-prompt').value.trim();
  if (!veEditAssetName) { status.textContent = 'Select an asset first.'; return; }
  if (!prompt)          { status.textContent = 'Write a description of the change.'; return; }

  btn.disabled    = true;
  btn.textContent = 'Generating...';
  status.textContent = 'Sending to Gemini...';
  document.getElementById('ve-c-preview-section').style.display = 'none';

  fetch('/api/assets/edit-preview', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ asset_name: veEditAssetName, prompt: prompt })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function(data) {
    veEditResultB64 = data.result_b64;
    status.textContent = '';

    // Load the current asset as "before"
    var beforeImg = document.getElementById('ve-c-before-img');
    var afterImg  = document.getElementById('ve-c-after-img');
    fetch('/api/assets/list')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var slot = (d.assets || []).find(function(a) { return a.name === veEditAssetName; });
        if (slot && slot.preview) {
          beforeImg.src = 'data:image/png;base64,' + slot.preview;
        }
      });
    afterImg.src = 'data:image/png;base64,' + veEditResultB64;

    document.getElementById('ve-c-preview-section').style.display = 'block';
    document.getElementById('ve-c-approve-status').textContent = '';
    veRefreshLogs();
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Generate Preview';
  });
}

function veApproveEditAsset() {
  if (!veEditResultB64 || !veEditAssetName) return;
  var btn    = document.getElementById('ve-c-approve-btn');
  var status = document.getElementById('ve-c-approve-status');
  btn.disabled    = true;
  btn.textContent = 'Saving...';
  status.textContent = '';

  fetch('/api/assets/approve', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ asset_name: veEditAssetName, image_b64: veEditResultB64 })
  })
  .then(function(r) { return r.ok ? r.json() : r.json().then(function(e) { throw new Error(e.detail || 'Server error'); }); })
  .then(function() {
    delete veImageAssets[veEditAssetName];
    veUpdateAssetPreview();
    veAddPendingChange('C', null, null, 'Saved: ' + veEditAssetName.replace('_', ' '));
    status.textContent = 'Saved to static/assets/project/. Next Build will include it.';
    status.style.color = '#22c55e';
    veRefreshLogs();
    setTimeout(function() { veHideForm(); }, 2500);
  })
  .catch(function(err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = '';
  })
  .finally(function() {
    btn.disabled    = false;
    btn.textContent = 'Approve & Save';
  });
}

function veRetryEditAsset() {
  document.getElementById('ve-c-preview-section').style.display = 'none';
  document.getElementById('ve-c-approve-status').textContent = '';
  veEditResultB64 = null;
  veEditAsset();
}

// â”€â”€ Asset preview panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veUpdateAssetPreview() {
  var panel = document.getElementById('ve-asset-preview');
  var items = document.getElementById('ve-asset-preview-items');
  items.innerHTML = '';
  var names = Object.keys(veImageAssets);
  if (names.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';
  names.forEach(function(name) {
    var wrap = document.createElement('div');
    wrap.style.textAlign = 'center';
    var img = document.createElement('img');
    img.src = 'data:image/png;base64,' + veImageAssets[name];
    img.style.cssText = 'width:60px;height:80px;object-fit:cover;border-radius:4px;border:1px solid var(--border);display:block';
    var lbl = document.createElement('div');
    lbl.textContent = name;
    lbl.style.cssText = 'font-size:11px;color:var(--muted);margin-top:4px';
    wrap.appendChild(img); wrap.appendChild(lbl);
    items.appendChild(wrap);
  });
}

// â”€â”€ History log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Change queue management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function veAddPendingChange(type, thumbCleanB64, thumbMarkedB64, note) {
  var change = {
    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    type: type,
    clean: thumbCleanB64,
    marked: thumbMarkedB64,
    note: note,
    timestamp: new Date().toLocaleString()
  };
  vePendingChanges.push(change);
  veRenderPending();
}

function veDeletePendingChange(changeId) {
  if (!confirm('Delete this pending change?')) return;
  vePendingChanges = vePendingChanges.filter(function(c) { return c.id !== changeId; });
  veRenderPending();
}

function veRenderPending() {
  var list  = document.getElementById('ve-pending-list');
  var empty = document.getElementById('ve-pending-empty');
  list.innerHTML = '';
  if (vePendingChanges.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  vePendingChanges.forEach(function(item) {
    var li = document.createElement('li');
    li.style.flexWrap = 'wrap';

    // Thumbnails
    if (item.clean || item.marked) {
      var thumbRow = document.createElement('div');
      thumbRow.style.cssText = 'display:flex;gap:6px;align-items:flex-end;margin-right:8px';

      if (item.clean) {
        var wrap1 = document.createElement('div');
        wrap1.style.cssText = 'text-align:center';
        var lbl1 = document.createElement('div');
        lbl1.style.cssText = 'font-size:10px;color:var(--muted);margin-bottom:2px';
        lbl1.textContent = 'Original';
        var img1 = document.createElement('img');
        img1.src = 'data:image/png;base64,' + item.clean;
        img1.className = 've-thumb';
        wrap1.appendChild(lbl1); wrap1.appendChild(img1);
        thumbRow.appendChild(wrap1);
      }

      if (item.marked) {
        var wrap2 = document.createElement('div');
        wrap2.style.cssText = 'text-align:center';
        var lbl2 = document.createElement('div');
        lbl2.style.cssText = 'font-size:10px;color:#6366f1;font-weight:600;margin-bottom:2px';
        lbl2.textContent = 'âœ Analyzed';
        var img2 = document.createElement('img');
        img2.src = 'data:image/png;base64,' + item.marked;
        img2.className = 've-thumb';
        img2.style.border = '2px solid #6366f1';
        wrap2.appendChild(lbl2); wrap2.appendChild(img2);
        thumbRow.appendChild(wrap2);
      }

      li.appendChild(thumbRow);
    }

    var badge = document.createElement('span');
    badge.className = 've-badge ' + item.type;
    badge.textContent = 'Path ' + item.type;
    var note = document.createElement('span');
    note.className = 've-status';
    note.textContent = item.note;
    var spacer = document.createElement('span');
    spacer.style.flex = '1';
    var deleteBtn = document.createElement('button');
    deleteBtn.className = 've-small-btn';
    deleteBtn.textContent = 'âŒ Delete';
    deleteBtn.style.cssText = 'font-size:11px;padding:4px 10px;background:#f9758340;border-color:#f97583;color:#f97583';
    deleteBtn.onclick = function() { veDeletePendingChange(item.id); };

    li.appendChild(badge); li.appendChild(note); li.appendChild(spacer); li.appendChild(deleteBtn);
    list.appendChild(li);
  });
}

function veRenderApplied() {
  var container = document.getElementById('ve-applied-list');
  var empty = document.getElementById('ve-applied-empty');
  container.innerHTML = '';
  if (veAppliedChanges.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  veAppliedChanges.forEach(function(build) {
    // Build header
    var buildHeader = document.createElement('div');
    buildHeader.style.cssText = 'font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;align-items:center;gap:8px';
    buildHeader.innerHTML = '<span>ğŸ“¦ ' + build.run_name + '</span><span style="font-size:10px;color:var(--muted);font-weight:400;margin-left:auto">' + build.changes.length + ' change(s)</span>';
    container.appendChild(buildHeader);

    // Changes in this build
    var list = document.createElement('ul');
    list.className = 've-history';
    list.style.marginBottom = '16px';
    build.changes.forEach(function(item) {
      var li = document.createElement('li');
      li.style.flexWrap = 'wrap';

      // Thumbnails
      if (item.clean || item.marked) {
        var thumbRow = document.createElement('div');
        thumbRow.style.cssText = 'display:flex;gap:6px;align-items:flex-end;margin-right:8px';

        if (item.clean) {
          var wrap1 = document.createElement('div');
          wrap1.style.cssText = 'text-align:center';
          var lbl1 = document.createElement('div');
          lbl1.style.cssText = 'font-size:10px;color:var(--muted);margin-bottom:2px';
          lbl1.textContent = 'Original';
          var img1 = document.createElement('img');
          img1.src = 'data:image/png;base64,' + item.clean;
          img1.className = 've-thumb';
          wrap1.appendChild(lbl1); wrap1.appendChild(img1);
          thumbRow.appendChild(wrap1);
        }

        if (item.marked) {
          var wrap2 = document.createElement('div');
          wrap2.style.cssText = 'text-align:center';
          var lbl2 = document.createElement('div');
          lbl2.style.cssText = 'font-size:10px;color:#6366f1;font-weight:600;margin-bottom:2px';
          lbl2.textContent = 'âœ Analyzed';
          var img2 = document.createElement('img');
          img2.src = 'data:image/png;base64,' + item.marked;
          img2.className = 've-thumb';
          img2.style.border = '2px solid #6366f1';
          wrap2.appendChild(lbl2); wrap2.appendChild(img2);
          thumbRow.appendChild(wrap2);
        }

        li.appendChild(thumbRow);
      }

      var badge = document.createElement('span');
      badge.className = 've-badge ' + item.type;
      badge.textContent = 'Path ' + item.type;
      var note = document.createElement('span');
      note.className = 've-status';
      note.textContent = item.note;
      li.appendChild(badge); li.appendChild(note);
      list.appendChild(li);
    });
    container.appendChild(list);
  });
}

function veMovePendingToApplied(run_id, run_name) {
  if (vePendingChanges.length === 0) return;
  veAppliedChanges.unshift({
    run_id: run_id,
    run_name: run_name,
    changes: vePendingChanges.slice() // copy array
  });
  vePendingChanges = [];
  veRenderPending();
  veRenderApplied();
}

// â”€â”€ Log viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function veRefreshAssetLibrary() {
  var grid = document.getElementById('ve-library-grid');
  if (!grid) return;
  grid.innerHTML = '<span style="color:var(--muted);font-size:13px">Loading...</span>';
  fetch('/api/assets/list')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      grid.innerHTML = '';
      (data.assets || []).forEach(function(asset) {
        var card = document.createElement('div');
        card.style.cssText = 'border:1px solid var(--border);border-radius:var(--radius);padding:8px;text-align:center;width:110px;background:var(--bg)';

        var img = document.createElement('img');
        img.style.cssText = 'width:90px;height:120px;object-fit:cover;border-radius:3px;display:block;margin:0 auto 6px';
        img.src = asset.preview ? 'data:image/png;base64,' + asset.preview
                                : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQI12NgAAIABQAABjE+ibYAAAAASUVORK5CYII=';

        var nameEl = document.createElement('div');
        nameEl.style.cssText = 'font-size:12px;font-weight:600;color:var(--text)';
        nameEl.textContent = asset.name.replace('_', ' ');

        var stateEl = document.createElement('div');
        stateEl.style.cssText = 'font-size:11px;color:var(--muted);margin-top:2px';
        stateEl.textContent = asset.has_file ? 'custom' : 'placeholder';

        card.appendChild(img); card.appendChild(nameEl); card.appendChild(stateEl);
        grid.appendChild(card);
      });
    })
    .catch(function() {
      grid.innerHTML = '<span style="color:#f97583;font-size:13px">Could not load. Is the server running?</span>';
    });
}

function veRefreshLogs() {
  fetch('/api/logs?n=60')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var box = document.getElementById('ve-log-box');
      if (!box) return;
      if (!data.lines || data.lines.length === 0) {
        box.textContent = '(no log entries yet)';
        return;
      }
      // Color-code by level
      box.innerHTML = data.lines.map(function(line) {
        var color = '#e6edf3';
        if (line.includes('ERROR'))   color = '#f97583';
        if (line.includes('WARNING')) color = '#e3b341';
        if (line.includes('INFO'))    color = '#79c0ff';
        return '<span style="color:' + color + '">' + line.replace(/</g, '&lt;') + '</span>';
      }).join('\n');
      box.scrollTop = box.scrollHeight;
    })
    .catch(function() { /* server may not be running yet */ });
}

function veClearLogView() {
  var box = document.getElementById('ve-log-box');
  if (box) box.innerHTML = '<span style="color:#6e7681">View cleared. Click Refresh to reload.</span>';
}

function veLog(msg) {
  // Append to log box immediately (client-side echo), then refresh from server
  var box = document.getElementById('ve-log-box');
  if (box) {
    var now = new Date().toLocaleTimeString();
    box.innerHTML += '\n<span style="color:#3fb950">[client ' + now + '] ' + msg.replace(/</g, '&lt;') + '</span>';
    box.scrollTop = box.scrollHeight;
  }
  setTimeout(veRefreshLogs, 800); // pull server log shortly after
}

// â”€â”€ Patch buildConfig to include veImageAssets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _origBuildConfig = buildConfig;
buildConfig = function() {
  var cfg = _origBuildConfig();
  if (veImageAssets.background) cfg.visual.background_image = veImageAssets.background;
  if (veImageAssets.card_back)  cfg.visual.card_back_image  = veImageAssets.card_back;
  if (veImageAssets.felt)       cfg.visual.felt_image       = veImageAssets.felt;
  return cfg;
};
</script>

</body>
</html>
